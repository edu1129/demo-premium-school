```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
   
  
  <meta name="viewport" content="width=1024">
  
  
    <title>Online School System - Advanced UI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" integrity="sha512-2/YdOMV+qvjOQellQm5+L9j7m3NEOhoCyI3RZUfDy97GWoLhU/TWj9G8gcJJgehRt3cT7R+G37cqj3SjFSMWew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #4A90E2; /* Refined Blue */
            --primary-color-dark: #357ABD;
            --secondary-color: #50E3C2; /* Mint Green */
            --secondary-color-dark: #38A89D;
            --accent-color: #F5A623; /* Orange */
            --accent-color-dark: #D48C0A;
            --error-color: #D0021B; /* Strong Red */
            --success-color: #7ED321; /* Vibrant Green */
            --warning-color: var(--accent-color);
            --info-color: var(--primary-color);

            --background-color: #f0f4f8; /* Lighter, cooler gray */
            --text-color: #4A4A4A; /* Dark Gray for text */
            --text-light-color: #7b8c9d;
            --card-bg: #ffffff;
            
            --sidebar-bg: #2c3e50; /* Keeping sidebar dark for contrast */
            --sidebar-bg-gradient: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --sidebar-active: var(--primary-color);
            --sidebar-active-text: #ffffff;

            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
            --border-radius: 12px; /* Softer edges */
            --border-color: #dfe6ee;

            --header-height: 65px;
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 80px;
            
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* Global Resets & Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        html { scroll-behavior: smooth; }
        body { 
            background-color: var(--background-color); 
            color: var(--text-color); 
            display: flex; 
            overflow-x: hidden; 
            font-size: 16px;
            line-height: 1.6;
        }

        /* Enhanced Loading Overlay */
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.9);display:flex;justify-content:center;align-items:center;z-index:9999;opacity:0;visibility:hidden;transition:opacity var(--transition-medium),visibility var(--transition-medium)}
        #loading-overlay.show{opacity:1;visibility:visible}
        .spinner{width:50px;height:50px;border:6px solid rgba(0,0,0,.1);border-left-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Enhanced Login Screen */
                /* Enhanced Login Screen with Background Image */
        #login-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;

            /* --- बदली हुई लाइनें --- */
            background-image: url('https://edu1129.github.io/Hhhhhh/IMG-20250526-WA0018.jpg'); /* अपनी इमेज का URL यहाँ डालें */
            background-size: cover; /* इमेज को पूरी स्क्रीन पर फैलाने के लिए */
            background-position: center; /* इमेज को सेंटर में रखने के लिए */
            background-repeat: no-repeat; /* इमेज को रिपीट होने से रोकने के लिए */
            /* ------------------- */
            
            position: fixed;
            top: 0;
            left: 0;
            z-index: 5000;
            transition: opacity var(--transition-slow), visibility var(--transition-slow);
            padding: 20px;
        }
        #login-container.hidden{opacity:0;visibility:hidden}
        #login-section{background-color:var(--card-bg);padding:45px 55px;border-radius:var(--border-radius);box-shadow:var(--shadow-lg);text-align:center;width:95%;max-width:450px;animation:fadeInUp 0.7s ease-out forwards; transform-style: preserve-3d;}
        #login-section h2{color:var(--primary-color);margin-bottom:35px;font-family:'Titillium Web',sans-serif;font-weight:700;font-size:2.2rem;display:flex;align-items:center;justify-content:center;gap:12px}
        #login-section h2 i{opacity:.9; font-size: 2rem;}
        .input-group{margin-bottom:25px;position:relative;text-align:left}
        .input-group i.fa-input-icon{position:absolute;left:18px;top:50%;transform:translateY(-50%);color:var(--primary-color);opacity:.7; font-size: 0.95rem;}
        .input-group input, .input-group select {width:100%;padding:16px 18px 16px 50px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem;transition:border-color var(--transition-fast),box-shadow var(--transition-fast);background-color:#fcfcfc;}
        .input-group input:focus, .input-group select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px rgba(74, 144, 226,.2); background-color: #fff;}
        
        .login-button{background:linear-gradient(45deg,var(--primary-color),var(--primary-color-dark));color:#fff;padding:16px 28px;border:none;border-radius:var(--border-radius);font-size:1.15rem;cursor:pointer;transition:all var(--transition-fast);width:100%;box-shadow:0 4px 10px rgba(74, 144, 226,0.3);font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:10px;text-transform:uppercase;letter-spacing:1px;position: relative; overflow: hidden;}
        .login-button:hover{background:linear-gradient(45deg,var(--primary-color-dark),var(--primary-color));box-shadow:0 7px 15px rgba(74, 144, 226,0.4);transform:translateY(-3px);}
        .login-button:active {transform:translateY(-1px);box-shadow:0 3px 8px rgba(74, 144, 226,0.3);}

        .login-button.processing {
            color: transparent !important;
            text-indent: -9999px;
            pointer-events: none;
            animation: none !important;
        }
        .login-button.processing i.fa-sign-in-alt {
            display: none !important;
        }
        .login-button.processing::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            margin-top: -12px;
            margin-left: -12px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: loginButtonSpin 0.8s linear infinite;
        }
        @keyframes loginButtonSpin { to { transform: rotate(360deg); } }
        
        #login-message{margin-top:25px;font-weight:500;min-height:24px}
        #premium-info-section{display:none;background:var(--card-bg);padding:45px 55px;border-radius:var(--border-radius);box-shadow:var(--shadow-lg);text-align:center;width:90%;max-width:580px;color:var(--text-color);border-left:6px solid var(--warning-color);animation:fadeInUp 0.7s ease-out forwards;}
        #premium-info-section h2{color:var(--warning-color);margin-bottom:18px;font-size:2rem;font-family:'Titillium Web',sans-serif;font-weight:700}
        #premium-info-section p{margin-bottom:28px;line-height:1.7;font-size:1.05rem}.back-to-login-btn{background:var(--warning-color);color:#fff;padding:12px 28px;border:none;border-radius:var(--border-radius);font-size:1rem;cursor:pointer;transition:all var(--transition-fast);font-weight:600;display:inline-flex;align-items:center;gap:8px;box-shadow:0 3px 7px rgba(245,166,35,0.25);}.back-to-login-btn:hover{background-color:var(--accent-color-dark);transform:translateY(-2px);box-shadow:0 5px 10px rgba(245,166,35,0.35);}.back-to-login-btn:active{transform:translateY(0);box-shadow:0 2px 5px rgba(245,166,35,0.2)}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

        #app-container { display: flex; width: 100%; opacity: 0; visibility: hidden; transition: opacity var(--transition-slow), visibility var(--transition-slow); }
        #app-container.visible { opacity: 1; visibility: visible; }
        #sidebar{width:var(--sidebar-width);height:100vh;background:var(--sidebar-bg-gradient);color:var(--sidebar-text);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:1000;transition:width var(--transition-medium),left var(--transition-medium);overflow-y:auto;overflow-x:hidden; box-shadow: 5px 0 15px rgba(0,0,0,0.1);}
        #sidebar.collapsed{width:var(--sidebar-width-collapsed)}
        #sidebar .sidebar-header{padding:0 15px;display:flex;align-items:center;justify-content:center;height:var(--header-height);border-bottom:1px solid rgba(236,240,241,.15);white-space:nowrap}
        #sidebar .sidebar-header .logo-icon{font-size:2rem;color:var(--secondary-color);margin-right:12px;transition:margin var(--transition-medium), transform var(--transition-medium)}
        #sidebar .sidebar-header .logo-text{font-family:'Titillium Web',sans-serif;font-size:1.6rem;font-weight:700;opacity:1;transition:opacity var(--transition-medium), transform var(--transition-medium) .1s; color: #fff;}
        #sidebar.collapsed .logo-icon{margin-right:0; transform: scale(1.1) translateX(2px);}
        #sidebar.collapsed .logo-text{opacity:0;width:0;overflow:hidden; transform: translateX(-20px);}
        #sidebar .sidebar-menu{list-style:none;padding:20px 0;flex-grow:1}
        #sidebar .sidebar-menu li{white-space:nowrap; position:relative;}
        #sidebar .sidebar-menu li a,#sidebar .sidebar-menu li .menu-item{display:flex;align-items:center;padding:14px 25px;color:var(--sidebar-text);text-decoration:none;transition:background-color var(--transition-fast),color var(--transition-fast), padding-left var(--transition-fast);cursor:pointer;border-left:5px solid transparent; font-size: 0.95rem;}
        #sidebar .sidebar-menu li a i,#sidebar .sidebar-menu li .menu-item i{font-size:1.2rem;margin-right:18px;width:28px;text-align:center;transition:font-size var(--transition-medium), color var(--transition-fast)}
        #sidebar .sidebar-menu li span.menu-text{opacity:1;transition:opacity var(--transition-medium) .1s;font-size:1rem;}
        #sidebar .sidebar-menu li a:hover,#sidebar .sidebar-menu li .menu-item:hover{background-color:var(--sidebar-hover); border-left-color: var(--secondary-color); color: var(--secondary-color);}
        #sidebar .sidebar-menu li.active>a,#sidebar .sidebar-menu li.active>.menu-item{background-color:var(--sidebar-active);color:var(--sidebar-active-text);border-left-color:var(--secondary-color);font-weight:600;padding-left: 30px;}
        #sidebar .sidebar-menu li.active>a i,#sidebar .sidebar-menu li.active>.menu-item i {color: var(--secondary-color);}
        #sidebar.collapsed .sidebar-menu li a,#sidebar.collapsed .sidebar-menu li .menu-item{justify-content:center;padding:15px 10px}
        #sidebar.collapsed .sidebar-menu li a i,#sidebar.collapsed .sidebar-menu li .menu-item i{margin-right:0;font-size:1.5rem}
        #sidebar.collapsed .sidebar-menu li span.menu-text{opacity:0;position:absolute;left: var(--sidebar-width-collapsed); top: 50%; transform: translateY(-50%) translateX(10px); background-color: var(--sidebar-hover); color: var(--sidebar-text); padding: 8px 12px; border-radius: var(--border-radius); box-shadow: var(--shadow); white-space: nowrap; pointer-events: none; transition: opacity 0.1s var(--transition-fast), transform 0.1s var(--transition-fast); z-index: 10;}
        #sidebar.collapsed .sidebar-menu li:hover span.menu-text {opacity:1; transform: translateY(-50%) translateX(15px); }
        #sidebar .sidebar-divider{height:1px;background-color:rgba(236,240,241,.15);margin:18px 25px}
        #sidebar.collapsed .sidebar-divider{margin:18px 15px}
        #sidebar .sidebar-footer{padding:18px 25px;border-top:1px solid rgba(236,240,241,.15);text-align:center}
        #sidebar #sidebar-toggle{background:none;border:none;color:var(--sidebar-text);font-size:1.5rem;cursor:pointer;padding:8px;transition:transform var(--transition-medium), color var(--transition-fast)}
        #sidebar #sidebar-toggle:hover{color:var(--secondary-color);transform:scale(1.15) rotate(180deg);}
        #sidebar.collapsed .sidebar-footer{padding:18px 10px}

        #main-content{flex-grow:1;height:100vh;overflow-y:auto;margin-left:var(--sidebar-width);padding-top:var(--header-height);padding-bottom:30px;transition:margin-left var(--transition-medium)}
        #sidebar.collapsed+#main-content{margin-left:var(--sidebar-width-collapsed)}
        #top-header{position:fixed;top:0;left:var(--sidebar-width);right:0;height:var(--header-height);background-color:var(--card-bg);box-shadow:0 3px 8px rgba(0,0,0,.06);z-index:900;display:flex;align-items:center;padding:0 30px;justify-content:space-between;transition:left var(--transition-medium)}
        #sidebar.collapsed~#top-header{left:var(--sidebar-width-collapsed)}
        .header-title{font-family:'Titillium Web',sans-serif;font-size:1.6rem;font-weight:600;color:var(--primary-color)}
        .header-actions{display:flex;align-items:center;gap:15px}
        .header-actions button{background:none;border:1px solid var(--border-color);color:var(--text-color);font-size:.9rem;cursor:pointer;padding:8px 15px;border-radius:var(--border-radius);transition:all var(--transition-fast);display:inline-flex;align-items:center;gap:8px;}
        .header-actions button:hover{background-color:#e9edf0;border-color:#c8d0d8; color: var(--primary-color);}
        .header-actions button.logout-button{border-color:var(--accent-color);color:var(--accent-color)}
        .header-actions button.logout-button:hover{background-color:var(--accent-color);color:#fff}
        #user-greeting { font-size: 0.95rem; color: var(--text-light-color); font-weight: 500;}
        
        .content-wrapper{padding:30px;max-width:100%}
        .view-section{display:none;animation:fadeInUpView 0.6s var(--transition-medium) forwards;background-color:transparent;padding:0; border-radius:0; box-shadow:none; margin-bottom:30px}
        .view-section.active{display:block}
        .view-header{font-family:'Titillium Web',sans-serif;font-size:1.9rem;font-weight:600;color:var(--primary-color);margin-bottom:0px;padding-bottom:20px;display:flex;align-items:center;justify-content:space-between;gap:15px; background-color:var(--card-bg); padding: 25px 30px; border-radius:var(--border-radius) var(--border-radius) 0 0; box-shadow: var(--shadow-sm); border-bottom: 1px solid var(--border-color);} 
        .view-header .title-text{display:flex;align-items:center;gap:12px}
        .view-header .title-text i{opacity:.9; font-size: 1.7rem;}
        .view-header .header-action-buttons button{font-size:.95rem;padding:8px 16px}
        @keyframes fadeInUpView{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        
        .section-content { background-color: var(--card-bg); padding: 30px; border-radius: 0 0 var(--border-radius) var(--border-radius); box-shadow: var(--shadow-sm); }
        .view-header + .section-content {border-top: none;}
        .view-section > .section-content:only-child {border-radius: var(--border-radius);}

        .data-table-container{max-height:65vh;overflow:auto;border:1px solid var(--border-color);border-radius:var(--border-radius);box-shadow:var(--shadow-sm)}
        .data-table{width:100%;border-collapse:collapse;font-size:.95rem}
        .data-table th,.data-table td{padding:14px 18px;text-align:left;border-bottom:1px solid var(--border-color);white-space:nowrap;vertical-align:middle}
        .data-table th{background-color:#f8fafc;font-weight:600;color:var(--primary-color);position:sticky;top:0;z-index:10;box-shadow:inset 0 -2px 0 var(--primary-color-dark); font-size: 1rem;}
        .data-table tbody tr:nth-child(even){background-color:#fcfdff}
        .data-table tbody tr{transition: background-color var(--transition-fast), transform var(--transition-fast);}
        .data-table tbody tr:hover{background-color:rgba(74, 144, 226,0.05); transform: scale(1.005); box-shadow: var(--shadow);}
        .data-table .action-col{text-align:center;white-space:nowrap}
        .data-table .action-col i { margin: 0 6px; cursor: pointer; font-size: 1.2rem; transition: color var(--transition-fast), transform var(--transition-fast); padding:6px; display:inline-block; border-radius: 50%;} 
        .data-table .action-col i:hover { transform: scale(1.2); background-color: rgba(0,0,0,0.05);}
        .data-table .action-col .edit-btn, .data-table .action-col .edit-btn-generic {color: var(--primary-color);} 
        .data-table .action-col .edit-btn:hover, .data-table .action-col .edit-btn-generic:hover {color: var(--primary-color-dark);} 
        .data-table .action-col .delete-btn { color: var(--error-color); } 
        .data-table .action-col .delete-btn:hover { color: darkred; } 
        .data-table .action-col .view-btn { color: var(--info-color); } 
        .data-table .action-col .view-btn:hover { color: var(--primary-color-dark); }
        .data-table .student-photo,.data-table .student-photo-placeholder{width:40px;height:40px;border-radius:50%;object-fit:cover;vertical-align:middle;border:2px solid var(--border-color);background-color:#e9edf0;display:inline-flex;align-items:center;justify-content:center;color:#a0aec0;font-size:1.1rem}
        
        #student-classes-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; padding: 20px 0;}
        .class-tile { background: linear-gradient(135deg, var(--card-bg) 0%, #fdfeff 100%); border-radius: var(--border-radius); padding: 30px; box-shadow: var(--shadow); cursor: pointer; transition: all var(--transition-medium); text-align: center; border-left: 6px solid var(--primary-color); display:flex; flex-direction:column; align-items:center; justify-content:center; position: relative; overflow: hidden;}
        .class-tile::before { content: ""; position: absolute; top:0; left:0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(80, 227, 194, 0.2), transparent 70%); opacity: 0; transition: opacity var(--transition-medium);}
        .class-tile:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-lg); border-left-color: var(--secondary-color); }
        .class-tile:hover::before { opacity: 1;}
        .class-tile i.fa-chalkboard { font-size: 3rem; color: var(--primary-color); margin-bottom: 18px; transition: color var(--transition-medium); }
        .class-tile:hover i.fa-chalkboard { color: var(--secondary-color); }
        .class-tile h4 { font-size: 1.4rem; font-weight: 600; margin-bottom: 10px; color: var(--text-color);}
        .class-tile p { font-size: 1rem; color: var(--text-light-color); }
        .back-to-classes-btn { margin-bottom: 25px; background-color: var(--text-light-color); color: white; padding: 10px 18px; font-size: 0.95rem; border-radius: var(--border-radius); border: none; cursor: pointer; transition: all var(--transition-fast);}
        .back-to-classes-btn:hover { background-color: var(--text-color); transform: translateY(-2px);}

        #student-list-view .filter-controls{margin-bottom:25px;padding:20px;background-color:#f8fafc;border-radius:var(--border-radius);display:flex;align-items:center;gap:20px;flex-wrap:wrap; border: 1px solid var(--border-color);}
        #student-list-view .filter-controls label{font-weight:500;display:flex;align-items:center;gap:8px;color:var(--text-color)}
        #student-list-view .filter-controls select{padding:10px 14px;border:1px solid var(--border-color);border-radius:var(--border-radius);min-width:200px;font-size:1rem;cursor:pointer;background-color:#fff;transition: all var(--transition-fast);}
        #student-list-view .filter-controls select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,144,226,.2)}
        #student-list-view .student-table-container{max-height:calc(100vh - 350px);}

        .add-form-view .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px 25px; margin-bottom: 25px;}
        .add-form-view .input-group {margin-bottom: 0px;}
        .add-form-view .input-group label, #add-class-view .input-group label, #add-subject-view .input-group label, #add-expense-view .input-group label, #assign-teacher-view .input-group label {display: block; margin-bottom: 8px; font-weight: 500;}
        .add-form-view .input-group input, .add-form-view .input-group select, #add-class-view input, #add-subject-view input, #add-expense-view input, #assign-teacher-view select { width:100%; padding:12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size:1rem;}
        .add-form-view .full-width { grid-column: 1 / -1; }
        .add-form-view button[type="submit"] { margin-top: 15px; float: right; padding: 12px 30px;}


        #add-results-view .form-step{margin-bottom:30px;padding:30px 35px;background-color:#fdfdff;border:1px solid var(--border-color);border-radius:var(--border-radius);animation:fadeInUpStep .5s ease-out;box-shadow:var(--shadow-sm)}
        @keyframes fadeInUpStep{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
        #add-results-view .form-step h4{margin-bottom:25px;color:var(--primary-color);font-size:1.3rem;font-weight:600;border-bottom:1px solid #eee;padding-bottom:12px}
        #add-results-view .input-group{margin-bottom:22px}
        #add-results-view .input-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--text-color);font-size:.95rem}
        #add-results-view .input-group input,#add-results-view .input-group select{width:100%;padding:12px 14px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem;transition:border-color var(--transition-fast),box-shadow var(--transition-fast)}
        #add-results-view .input-group input:focus,#add-results-view .input-group select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,144,226,.2)}
        #add-results-view .subject-entry{display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center;margin-bottom:15px;padding:15px;background-color:#f8fafc;border-radius:var(--border-radius);border:1px solid var(--border-color)}
        #add-results-view .subject-entry input{padding:10px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:.95rem}
        #add-results-view .subject-entry input.marks-input{width:85px;text-align:center}
        #add-results-view .remove-subject-btn{background:none;border:none;color:var(--error-color);font-size:1.4rem;cursor:pointer;transition:color var(--transition-fast),transform var(--transition-fast);padding:0 5px;line-height:1;opacity:.8}
        #add-results-view .remove-subject-btn:hover{color:darkred;transform:scale(1.15);opacity:1}
        #add-results-view .add-subject-btn{background-color:var(--secondary-color);color:#fff;padding:10px 18px;border:none;border-radius:var(--border-radius);font-size:.95rem;cursor:pointer;transition:all var(--transition-fast);margin-top:12px;font-weight:500;display:inline-flex;align-items:center;gap:8px; box-shadow: 0 3px 7px rgba(80,227,194,.25);}
        #add-results-view .add-subject-btn:hover{background-color:var(--secondary-color-dark);transform:translateY(-2px);box-shadow:0 5px 10px rgba(80,227,194,.35);}
        #add-results-view .step-navigation{display:flex;justify-content:space-between;margin-top:30px;padding-top:25px;border-top:1px solid #eee;flex-wrap:wrap;gap:12px}
        #add-results-view .step-navigation button{padding:12px 25px;border:none;border-radius:var(--border-radius);font-size:1.05rem;cursor:pointer;transition:all var(--transition-fast);font-weight:500;display:inline-flex;align-items:center;gap:10px; letter-spacing: 0.5px;}
        #add-results-view .step-navigation button:hover{transform:translateY(-3px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
        #add-results-view .next-step-btn,#add-results-view .submit-result-btn{background-color:var(--primary-color);color:#fff; box-shadow: 0 3px 7px rgba(74,144,226,.25);}
        #add-results-view .next-step-btn:hover,#add-results-view .submit-result-btn:hover{background-color:var(--primary-color-dark);box-shadow:0 5px 10px rgba(74,144,226,.35);}
        #add-results-view .prev-step-btn{background-color:#95a5a6;color:#fff; box-shadow: 0 3px 7px rgba(149,165,166,.25);}
        #add-results-view .prev-step-btn:hover{background-color:#7f8c8d; box-shadow:0 5px 10px rgba(149,165,166,.35);}
        #add-results-view #results-student-list{margin-top:18px;max-height:45vh;overflow-y:auto;padding-right:8px;border:1px solid var(--border-color);border-radius:var(--border-radius);background-color:#fff}
        #add-results-view .student-result-item{display:flex;align-items:center;padding:12px 18px;margin:0;border-bottom:1px solid #f0f3f6;cursor:pointer;transition:background-color var(--transition-fast), transform var(--transition-fast);position:relative}
        #add-results-view .student-result-item:last-child{border-bottom:none}
        #add-results-view .student-result-item:hover{background-color:rgba(74,144,226,.05); transform: translateX(5px);}
        #add-results-view .student-result-item.selected{background-color:rgba(74,144,226,.1);font-weight:500}
        #add-results-view .student-result-item.selected::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;background-color:var(--primary-color)}
        #add-results-view .student-result-item img, #add-results-view .student-result-item .student-photo-placeholder{width:45px;height:45px;border-radius:50%;margin-right:18px;object-fit:cover;border:2px solid var(--border-color)}
        #add-results-view .student-result-info span{display:block;font-size:.95rem;color:var(--text-light-color);line-height:1.5}
        #add-results-view .student-result-info span strong{color:var(--text-color);font-weight:600;font-size:1rem}
        #add-results-view .result-saved-indicator{margin-left:auto;color:var(--success-color);font-size:1.2rem;opacity:0;transition:opacity var(--transition-medium), transform var(--transition-medium); transform: scale(0.8);}
        #add-results-view .student-result-item.has-result .result-saved-indicator{opacity:1; transform: scale(1);}
        #add-results-view #marks-entry-container{margin-top:25px;padding:25px;border:1px solid var(--border-color);border-radius:var(--border-radius);background-color:#fdfdff;box-shadow:var(--shadow-sm)}
        #add-results-view #marks-entry-container h5{margin-bottom:18px;color:var(--primary-color);font-size:1.2rem;font-weight:600;border-bottom:1px solid #eee;padding-bottom:12px}
        #add-results-view #marks-entry-container h5 strong{color:var(--secondary-color);font-weight:700}
        #add-results-view #marks-entry-form .marks-input-group{display:grid;grid-template-columns:1fr auto;gap:12px 18px;align-items:center;margin-bottom:15px}
        #add-results-view #marks-entry-form .marks-input-group label{font-weight:500;font-size:1rem;text-align:right;color:var(--text-color)}
        #add-results-view #marks-entry-form .marks-input-group label .max-marks{font-size:.85em;font-weight:400;color:var(--text-light-color)}
        #add-results-view #marks-entry-form .marks-input-group input{padding:10px;border:1px solid var(--border-color);border-radius:var(--border-radius);width:110px;text-align:center;font-size:1rem}
        #add-results-view #marks-entry-form .marks-input-group input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,144,226,.15)}
        #add-results-view #marks-entry-form .marks-input-group input.invalid{border-color:var(--error-color);background-color:#fdecea}
        #add-results-view #marks-entry-message{margin-top:18px;font-weight:500;min-height:22px}
        
        .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(30,50,70,.7);animation:fadeInModalBg var(--transition-medium) forwards;padding:5vh 20px; backdrop-filter: blur(5px);}
        @keyframes fadeInModalBg{from{opacity:0}to{opacity:1}}
        .modal-content{background-color:var(--card-bg);margin:0 auto;padding:0;border:none;width:90%;max-width:700px;border-radius:var(--border-radius);box-shadow:var(--shadow-lg);position:relative;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;animation:zoomInModal var(--transition-medium) forwards}
        @keyframes zoomInModal{from{opacity:0;transform:scale(.92) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .modal-content.modal-lg{max-width:950px}.modal-content.modal-xl{max-width:1200px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:22px 35px;border-bottom:1px solid var(--border-color);background-color:#f8fafc;border-top-left-radius:var(--border-radius);border-top-right-radius:var(--border-radius)}
        .modal-header h3{color:var(--primary-color);font-size:1.5rem;font-family:'Titillium Web',sans-serif;display:flex;align-items:center;gap:12px;font-weight:600}
        .modal-header h3 i{opacity:.9; font-size: 1.4rem;}
        .close-btn{color:#aaa;background:none;border:none;font-size:2rem;font-weight:700;cursor:pointer;transition:color var(--transition-fast),transform var(--transition-fast);line-height:1;padding:0 5px}
        .close-btn:hover,.close-btn:focus{color:var(--error-color);transform:rotate(90deg) scale(1.1);outline:none}
        .modal-body{overflow-y:auto;padding:30px 35px;flex-grow:1}
        .modal-body .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px 25px}
        .modal-body .input-group{margin-bottom:0}
        .modal-body .input-group label{display:block;margin-bottom:6px;font-weight:500;color:var(--text-color);font-size:.95rem}
        .modal-body .input-group input,.modal-body .input-group select,.modal-body .input-group textarea{width:100%;padding:12px 14px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem}
        .modal-body .input-group input:focus,.modal-body .input-group select:focus,.modal-body .input-group textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,144,226,.2)}
        .modal-body .input-group textarea{min-height:90px;resize:vertical}
        .modal-footer{padding:20px 35px;border-top:1px solid var(--border-color);text-align:right;background-color:#f8fafc;border-bottom-left-radius:var(--border-radius);border-bottom-right-radius:var(--border-radius)}
        .modal-footer button{padding:12px 22px;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;margin-left:12px;transition:all var(--transition-fast);font-weight:500;border:none;display:inline-flex;align-items:center;gap:8px; letter-spacing: 0.5px;}
        .modal-footer .save-btn{background-color:var(--success-color);color:#fff; box-shadow: 0 3px 7px rgba(126,211,33,.25);}
        .modal-footer .save-btn:hover{background-color: #68b21c;transform:translateY(-2px);box-shadow:0 5px 10px rgba(126,211,33,.35);}
        .modal-footer .save-btn:active{transform:translateY(0);box-shadow:none}
        .modal-footer .cancel-btn{background-color:#bdc3c7;color:#fff; box-shadow: 0 3px 7px rgba(189,195,199,.25);}
        .modal-footer .cancel-btn:hover{background-color:#95a5a6;transform:translateY(-2px)}
        .modal-footer .cancel-btn:active{transform:translateY(0)}
        .modal-footer .message{margin:0 auto 15px 0;text-align:left;}

        .message{padding:12px 18px;border-radius:var(--border-radius);margin:18px 0;font-weight:500;text-align:left;border-width:1px;border-style:solid;display:flex;align-items:center;gap:12px;font-size:.95rem; animation: fadeInMessage 0.4s ease forwards;}
        @keyframes fadeInMessage{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .message i.fa-message-icon{font-size:1.2em; flex-shrink: 0;}
        .message.error{background-color:#ffebee;color:#c62828;border-color:#ef9a9a; border-left: 5px solid var(--error-color);}
        .message.success{background-color:#e8f5e9;color:#2e7d32;border-color:#a5d6a7; border-left: 5px solid var(--success-color);}
        .message.info{background-color:#e3f2fd;color:#1565c0;border-color:#90caf9; border-left: 5px solid var(--info-color);}
        .message.warning{background-color:#fff8e1;color:#ff8f00;border-color:#ffd54f; border-left: 5px solid var(--warning-color);}
        .hidden{display:none!important}

        #dashboard-view .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom:30px;}
        .dashboard-card { background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: all var(--transition-medium); position: relative; overflow:hidden; border-top: 4px solid transparent;}
        .dashboard-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-lg); border-top-color: var(--primary-color); }
        .dashboard-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background-image: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%); transform: rotate(0deg); transition: transform 0.8s ease; z-index: 0;}
        .dashboard-card:hover::after { transform: rotate(360deg); }
        .dashboard-card > * { position: relative; z-index: 1;}
        .dashboard-card .card-icon { font-size: 2.8rem; color: var(--primary-color); margin-bottom: 18px; line-height: 1; }
        .dashboard-card .card-title { font-size: 0.95rem; color: var(--text-light-color); margin-bottom: 10px; text-transform: uppercase; font-weight:500; letter-spacing: 0.5px;}
        .dashboard-card .card-value { font-size: 2.4rem; font-weight: 700; color: var(--text-color); }
        .dashboard-chart-container { background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 25px; }
        .dashboard-chart-container h4 { margin-bottom:18px; font-size:1.3rem; color:var(--primary-color); text-align:center; font-weight: 600;}

        #tools-view-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 25px; padding:20px 0;}
        .tool-card { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; text-align: center; cursor: pointer; transition: transform var(--transition-medium), box-shadow var(--transition-medium); border-top: 5px solid var(--primary-color); position: relative; overflow: hidden;}
        .tool-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: var(--shadow-lg); border-top-color: var(--secondary-color);}
        .tool-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 18px; border-radius: 50%; background: #f0f4f8; padding: 8px; box-shadow: var(--shadow-sm); transition: transform var(--transition-medium);}
        .tool-card:hover img { transform: scale(1.1) rotate(5deg); }
        .tool-card h4 { font-size: 1.2rem; margin-bottom: 10px; color: var(--text-color); font-weight:600;}
        .tool-card p { font-size: 0.95rem; color: var(--text-light-color); line-height: 1.5; }
        
        #fullscreen-iframe-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30,50,70,0.7); z-index: 6000; display: none; flex-direction: column; animation: fadeInModalBg var(--transition-medium) forwards; backdrop-filter: blur(3px); }
        #fullscreen-iframe-header { background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        #fullscreen-iframe-title { font-size: 1.3rem; font-weight: 600; }
        #close-fullscreen-iframe-btn { background: var(--accent-color); color: white; border: none; padding: 9px 18px; border-radius: var(--border-radius); cursor: pointer; font-size: .95rem; transition: background-color var(--transition-fast), transform var(--transition-fast);}
        #close-fullscreen-iframe-btn:hover { background-color: var(--accent-color-dark); transform: scale(1.05); }
        #fullscreen-iframe-wrapper { flex-grow: 1; background-color: #fff; border-radius: 0 0 var(--border-radius) var(--border-radius); overflow: hidden; }
        #fullscreen-iframe-wrapper iframe { width: 100%; height: 100%; border: none; }

        .profile-grid { display: grid; grid-template-columns: 320px 1fr; gap: 35px; }
        .profile-sidebar { background-color: #f8fafc; padding: 30px; border-radius: var(--border-radius); text-align: center; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);}
        .profile-photo-container img, .profile-photo-container div { width: 160px; height: 160px; border-radius: 50%; object-fit: cover; margin: 0 auto 25px auto; border: 5px solid var(--primary-color); box-shadow: 0 4px 12px rgba(74,144,226,0.3); padding:3px; background-color: white;}
        .profile-sidebar h3.profile-name { font-size: 1.8rem; color: var(--primary-color); margin-bottom: 12px; font-family: 'Titillium Web'; }
        .profile-sidebar p.profile-meta { font-size: 1rem; color: var(--text-light-color); margin-bottom: 10px; line-height: 1.6; display: flex; align-items: center; justify-content: flex-start; text-align: left;}
        .profile-sidebar p.profile-meta i { margin-right: 12px; color: var(--primary-color); width: 20px; text-align:center; font-size: 1.1rem;}
        .profile-main-content .details-section { background-color: #fff; padding: 25px 30px; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);}
        .profile-main-content .details-section:last-child { margin-bottom: 0; }
        .profile-main-content .details-section h4 { font-size: 1.3rem; color: var(--primary-color); margin-bottom: 20px; font-weight: 600; padding-bottom: 12px; border-bottom: 1px solid #eee; display:flex; align-items:center; gap:10px;}
        .profile-main-content .details-section h4 i { opacity: 0.9; font-size: 1.2rem;}
        .profile-main-content .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 28px; }
        .profile-main-content .info-grid p { margin-bottom: 12px; font-size: 1rem; display: flex; }
        .profile-main-content .info-grid strong { font-weight: 600; color: var(--text-color); min-width: 130px; display: inline-block; color:var(--text-light-color); margin-right: 8px;}
        .profile-main-content .details-list { max-height: 280px; overflow-y: auto; padding-right:12px;} 
        .profile-main-content .list-item { padding: 12px 8px; border-bottom: 1px solid #f0f3f6; display: flex; justify-content: space-between; align-items: center; transition: background-color var(--transition-fast);}
        .profile-main-content .list-item:hover { background-color: #f9fbfc;}
        .profile-main-content .list-item:last-child { border-bottom: none; }
        .profile-main-content .list-item span { font-size: 0.95rem; }
        .profile-main-content .list-item .amount { font-weight: bold; }
        .profile-main-content .list-item .status-due { color: var(--error-color); font-weight:500; background-color: #fde8e8; padding: 3px 8px; border-radius: 5px; font-size: 0.85rem;}
        .profile-main-content .list-item .status-paid { color: var(--success-color); font-weight:500; background-color: #eaf7e2; padding: 3px 8px; border-radius: 5px; font-size: 0.85rem;}
        .profile-main-content .attendance-summary, .profile-main-content .fees-summary { margin-bottom:18px; font-weight:bold; font-size:1.05rem; text-align: right; padding: 10px; background-color: #f8fafc; border-radius: var(--border-radius); border: 1px solid var(--border-color);}
        .profile-main-content .mark-paid-btn { padding: 7px 14px; font-size: 0.9rem; background-color: var(--secondary-color); color:white; border:none; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-fast);}
        .profile-main-content .mark-paid-btn:hover { background-color: var(--secondary-color-dark); transform: translateY(-2px); box-shadow: var(--shadow-sm);}
        #staffDetailsModal .profile-main-content #add-salary-form-modal { margin-top:25px; padding-top:25px; border-top:1px solid #eee;} 

        @media (max-width: 992px) { 
             .profile-grid { grid-template-columns: 1fr; }
             .profile-sidebar { margin-bottom: 30px; }
        }
        @media (max-width: 768px){
            :root{--sidebar-width:220px;--sidebar-width-collapsed:0; --header-height: 60px;}
            body { font-size: 15px;}
            #sidebar{position:fixed;left:calc(-1 * var(--sidebar-width));z-index:1100; box-shadow: 3px 0 10px rgba(0,0,0,0.15);}
            #sidebar.open{left:0}#sidebar.collapsed{width:0;left:calc(-1 * var(--sidebar-width))}
            #main-content{margin-left:0!important; padding-top: var(--header-height);}
            #top-header{left:0!important;padding:0 20px; height: var(--header-height);}
            .header-title{font-size:1.4rem}
            #sidebar-toggle-mobile{display:block!important;margin-right:15px; font-size: 1.4rem; color: var(--primary-color); background: transparent; border:none; padding: 5px;}
            #sidebar-toggle{display:none!important}
            .content-wrapper{padding:20px}.view-section{margin-bottom: 25px;} .section-content { padding: 25px;}
            .view-header{font-size:1.5rem; padding: 20px 25px;} .view-header .title-text i {font-size: 1.4rem;}
            .data-table th,.data-table td{padding:10px 12px;font-size:.9rem}
            .modal-content{width:95%;max-width:95%; padding:5px;}.modal-body .form-grid{grid-template-columns:1fr}
            .modal-header{padding:18px 25px}.modal-body{padding:25px}.modal-footer{padding:15px 25px}.modal-footer button{font-size:.95rem;padding:10px 18px}
            #add-results-view .step-navigation{flex-direction:column;align-items:stretch}#add-results-view .step-navigation button{width:100%}#add-results-view .step-navigation .prev-step-btn{margin-bottom:12px}
            #dashboard-view .dashboard-grid { grid-template-columns: 1fr; gap: 20px;} 
            .dashboard-card { padding: 20px;} .dashboard-card .card-value { font-size: 2rem; }
            #add-fees-view .form-grid, .add-form-view .form-grid { grid-template-columns: 1fr; }
            #student-classes-list { grid-template-columns: 1fr; gap: 20px;} .class-tile { width: 100%; padding: 25px;}
            .tool-card { padding: 20px;}
            #login-section { padding: 35px 25px; } #login-section h2 { font-size: 1.8rem; }
            .profile-grid {gap: 25px;} .profile-sidebar { padding: 25px;} .profile-main-content .details-section { padding: 20px 25px;}
         }
         @media (max-width: 480px) {
            body { font-size: 14px; }
            .content-wrapper { padding: 15px; }
            .section-content { padding: 20px; }
            .view-header { font-size: 1.3rem; padding: 15px 20px; }
            .data-table th, .data-table td { padding: 8px 10px; font-size: .85rem; white-space: normal; }
            .data-table .action-col i { margin: 0 3px; font-size: 1.1rem; padding: 4px;}
            .modal-header h3 { font-size: 1.3rem; }
            .modal-body { padding: 20px; } .modal-footer { padding: 12px 20px; }
            .modal-footer button { font-size: .9rem; padding: 8px 15px; }
            .dashboard-card .card-icon { font-size: 2.2rem; } .dashboard-card .card-value { font-size: 1.8rem; }
            .class-tile i.fa-chalkboard { font-size: 2.5rem; } .class-tile h4 { font-size: 1.2rem; }
            #login-section { padding: 30px 20px; } #login-section h2 { font-size: 1.6rem; }
            .login-button { padding: 14px 20px; font-size: 1rem; }
            .input-group input, .input-group select { padding: 14px 15px 14px 45px; }
            .header-actions { gap: 8px; } .header-actions button { padding: 6px 10px; font-size: .8rem;}
         }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div></div>

<div id="login-container">
    <div id="login-section">
        <h2><i class="fas fa-school"></i> School Portal</h2>
        <form id="login-form" novalidate>
            <div class="input-group"><i class="fas fa-mobile-alt fa-input-icon"></i><input type="tel" id="mobile" placeholder="Mobile Number" required></div>
            <div class="input-group"><i class="fas fa-lock fa-input-icon"></i><input type="password" id="password" placeholder="Password" required></div>
            <button type="submit" class="login-button" id="login-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
        </form>
        <div id="login-message" class="message error" style="display: none;"></div>
    </div>
     <div id="premium-info-section">
         <h2><i class="fas fa-exclamation-triangle"></i> Premium Access Required</h2>
         <p>This feature requires premium access to the system. Please contact support for more information or to upgrade your account.</p>
         <button class="back-to-login-btn" id="premium-back-btn"><i class="fas fa-arrow-left"></i> Back to Login</button>
    </div>
</div>

<div id="app-container">
    <aside id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-university logo-icon"></i>
            <span class="logo-text">School Sys</span>
        </div>
        <ul class="sidebar-menu" id="sidebar-menu">
            <li id="nav-dashboard" class="active"><a data-view="dashboard-view"><i class="fas fa-tachometer-alt"></i><span class="menu-text">Dashboard</span></a></li>
            <li id="nav-students"><a data-view="student-list-view"><i class="fas fa-user-graduate"></i><span class="menu-text">Students</span></a></li>
            <li id="nav-staff"><a data-view="staff-list-view"><i class="fas fa-users-cog"></i><span class="menu-text">Staff</span></a></li>
            <li id="nav-add-fees"><a data-view="add-fees-view"><i class="fas fa-file-invoice-dollar"></i><span class="menu-text">Add Fees</span></a></li>
            <li id="nav-add-result"><a data-view="add-results-view"><i class="fas fa-award"></i><span class="menu-text">Add Result</span></a></li>
            <li id="nav-add-student"><a data-view="add-student-view"><i class="fas fa-user-plus"></i><span class="menu-text">Add Student</span></a></li>
            <li id="nav-add-staff"><a data-view="add-staff-view"><i class="fas fa-user-tie"></i><span class="menu-text">Add Staff</span></a></li>
            <li id="nav-add-class"><a data-view="add-class-view"><i class="fas fa-chalkboard"></i><span class="menu-text">Add Class</span></a></li>
            <li id="nav-add-subject"><a data-view="add-subject-view"><i class="fas fa-book"></i><span class="menu-text">Add Subject</span></a></li>
            <li id="nav-assign-teacher"><a data-view="assign-teacher-view"><i class="fas fa-chalkboard-teacher"></i><span class="menu-text">Assign Teacher</span></a></li>
            <li id="nav-add-expense"><a data-view="add-expense-view"><i class="fas fa-receipt"></i><span class="menu-text">Add Expense</span></a></li>
            <li id="nav-tools"><a data-view="tools-view"><i class="fas fa-tools"></i><span class="menu-text">Tools Hub</span></a></li>
            <li class="sidebar-divider" id="generator-divider" style="display: none;"></li>
            <li class="sidebar-divider" id="sheet-divider" style="display: none;"></li>
        </ul>
        <div class="sidebar-footer"><button id="sidebar-toggle" title="Toggle Sidebar"><i class="fas fa-bars"></i></button></div>
    </aside>

    <main id="main-content">
        <header id="top-header">
             <button id="sidebar-toggle-mobile" style="display: none;"><i class="fas fa-bars"></i></button>
            <div class="header-title" id="main-header-title">Dashboard</div>
             <div class="header-actions">
                 <button id="download-pdf-btn" style="display: none;" title="Download Current View as PDF">
                     <i class="fas fa-file-pdf"></i> PDF
                 </button>
                <span id="user-greeting"></span>
                 <button class="logout-button" id="logout-btn" title="Logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
             </div>
        </header>

        <div class="content-wrapper">
            <section id="dashboard-view" class="view-section active">
                <div class="view-header"><div class="title-text"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</div></div>
                <div class="section-content">
                    <div id="dashboard-message" class="message info" style="display: none;"></div>
                    <div id="dashboard-content">
                        <div class="dashboard-grid">
                            <div class="dashboard-card" style="border-top-color: var(--primary-color);"><i class="fas fa-user-graduate card-icon"></i><div class="card-title">Total Students</div><div class="card-value" id="db-total-students">-</div></div>
                            <div class="dashboard-card" style="border-top-color: #6f42c1;"><i class="fas fa-chalkboard-teacher card-icon" style="color: #6f42c1;"></i><div class="card-title">Total Staff</div><div class="card-value" id="db-total-staff">-</div></div>
                            <div class="dashboard-card" style="border-top-color: #fd7e14;"><i class="fas fa-school card-icon" style="color: #fd7e14;"></i><div class="card-title">Total Classes</div><div class="card-value" id="db-total-classes">-</div></div>
                            <div class="dashboard-card" style="border-top-color: #e83e8c;"><i class="fas fa-venus card-icon" style="color: #e83e8c;"></i><div class="card-title">Total Girls</div><div class="card-value" id="db-total-girls">-</div></div>
                            <div class="dashboard-card" style="border-top-color: #007bff;"><i class="fas fa-mars card-icon" style="color: #007bff;"></i><div class="card-title">Total Boys</div><div class="card-value" id="db-total-boys">-</div></div>
                            <div class="dashboard-card" style="border-top-color: var(--success-color);"><i class="fas fa-money-bill-wave card-icon" style="color: var(--success-color);"></i><div class="card-title">Total Paid Fees</div><div class="card-value" id="db-total-paid">-</div></div>
                            <div class="dashboard-card" style="border-top-color: var(--error-color);"><i class="fas fa-hand-holding-usd card-icon" style="color: var(--error-color);"></i><div class="card-title">Total Due Fees</div><div class="card-value" id="db-total-due">-</div></div>
                            <div class="dashboard-card" style="border-top-color: var(--warning-color);"><i class="fas fa-receipt card-icon" style="color: var(--warning-color);"></i><div class="card-title">Total Expenses</div><div class="card-value" id="db-total-expenses">-</div></div>
                        </div>
                        <div class="dashboard-grid">
                            <div class="dashboard-chart-container"><canvas id="studentsPerClassChart"></canvas></div>
                            <div class="dashboard-chart-container"><canvas id="genderSplitPerClassChart"></canvas></div>
                        </div>
                         <div class="dashboard-grid">
                            <div class="dashboard-chart-container"><canvas id="feesCollectedPerClassChart"></canvas></div>
                            <div class="dashboard-chart-container"><canvas id="duesPerClassChart"></canvas></div>
                        </div>
                        <div class="dashboard-grid">
                            <div class="dashboard-chart-container"><canvas id="attendancePerClassChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="student-list-view" class="view-section">
                <div class="view-header">
                    <div class="title-text"><i class="fas fa-user-graduate"></i> Students Management</div>
                </div>
                <div class="section-content">
                    <div id="student-list-main-content"></div>
                    <div id="student-list-message" class="message info" style="display: none;"></div>
                </div>
            </section>
            
            <section id="staff-list-view" class="view-section">
                <div class="view-header"><div class="title-text"><i class="fas fa-users-cog"></i> Staff Management</div></div>
                <div class="section-content">
                    <div id="staff-list-message" class="message info" style="display: none;"></div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead><tr><th>Photo</th><th>Name</th><th>Mobile</th><th>Role/Designation</th><th>Is Active</th><th>Actions</th></tr></thead>
                            <tbody id="staff-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="add-fees-view" class="view-section add-form-view">
                <div class="view-header"><div class="title-text"><i class="fas fa-file-invoice-dollar"></i> Add Bulk Fees</div></div>
                <div class="section-content">
                    <div id="add-fees-message" class="message" style="display:none;"></div>
                    <form id="add-fees-form">
                        <div class="form-grid">
                            <div class="input-group"><label for="fee-class-select">Select Class</label><select id="fee-class-select" required></select></div>
                            <div class="input-group"><label for="fee-type-select">Fee Type</label><select id="fee-type-select" required></select></div>
                             <div class="input-group"><label for="fee-amount">Amount (Optional)</label><input type="number" id="fee-amount" placeholder="Default from Fee Type"></div>
                            <div class="input-group"><label for="fee-month-year">For Month & Year</label><input type="text" id="fee-month-year" required placeholder="e.g. July 2024"></div>
                            <div class="input-group"><label for="fee-due-date">Due Date</label><input type="date" id="fee-due-date" required></div>
                            <div class="input-group"><label for="fee-academic-year">Academic Year</label><input type="text" id="fee-academic-year" placeholder="e.g. 2024-25"></div>
                        </div>
                        <button type="submit" class="modal-footer save-btn submit-btn"><i class="fas fa-plus-circle"></i> Add Fees to Class</button>
                    </form>
                </div>
            </section>
            
            <section id="add-results-view" class="view-section">
                 <div class="view-header"><div class="title-text"><i class="fas fa-award"></i> Add New Result</div></div>
                 <div class="section-content">
                    <div id="add-results-message" class="message" style="display: none;"></div>
                    <div id="step1-result-details" class="form-step">
                        <h4>Step 1: Result & Subject Details</h4>
                        <div class="input-group"><label for="result-name">Result Name</label><input type="text" id="result-name"></div>
                        <div class="input-group"><label for="school-name">School Name (for report)</label><input type="text" id="school-name"></div>
                        <div class="input-group"><label for="teacher-name">Teacher's Name (for report)</label><input type="text" id="teacher-name"></div>
                        <div class="input-group"><label for="result-class">Select Class</label><select id="result-class"></select></div>
                        <div id="subjects-container">
                            <label style="font-weight: 500; color: var(--text-color); font-size: 0.95rem; margin-bottom: 10px; display: block;">Subjects</label>
                            <div class="subject-entry">
                                <input type="text" class="subject-name" placeholder="Subject Name"><input type="number" class="total-marks marks-input" placeholder="Total" min="1" value="100"><input type="number" class="pass-marks marks-input" placeholder="Pass" min="0" value="30"><button type="button" class="remove-subject-btn" onclick="removeSubject(this)" style="visibility: hidden;"><i class="fas fa-times-circle"></i></button>
                            </div>
                        </div>
                        <button type="button" class="add-subject-btn" id="add-subject-btn"><i class="fas fa-plus"></i> Add Subject</button>
                        <div class="step-navigation" style="justify-content: flex-end;">
                            <button type="button" class="next-step-btn" id="next-to-step2-btn">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                     <div id="step2-select-student" class="form-step" style="display: none;"><h4>Step 2: Select Student (Class: <strong id="selected-class-info"></strong>)</h4><p style="font-size:.95rem;color:var(--text-light-color);margin-bottom:18px">Click a student to enter marks. <i class="fas fa-check-circle" style="color:var(--success-color);"></i> indicates saved results.</p><div id="results-student-list"></div><div class="step-navigation"><button type="button" class="prev-step-btn" id="back-to-step1-btn"><i class="fas fa-arrow-left"></i> Back</button></div></div>
                     <div id="step3-enter-marks" class="form-step" style="display: none;"><div id="marks-entry-container"><h5>Enter Marks for: <strong id="selected-student-info"></strong></h5><form id="marks-entry-form" novalidate></form><div id="marks-entry-message" class="message" style="display: none;"></div></div><div class="step-navigation"><button type="button" class="prev-step-btn" id="back-to-step2-btn"><i class="fas fa-arrow-left"></i> Back</button><button type="button" class="submit-result-btn" id="submit-marks-btn">Save Marks <i class="fas fa-save"></i></button></div></div>
                 </div>
             </section>

            <section id="add-student-view" class="view-section add-form-view">
                <div class="view-header"><div class="title-text"><i class="fas fa-user-plus"></i> Add New Student</div></div>
                <div class="section-content">
                    <div id="add-student-message" class="message" style="display:none;"></div>
                    <form id="add-student-form" novalidate>
                        <div class="form-grid">
                            <div class="input-group"><label for="add-student-name">Name</label><input type="text" id="add-student-name" required></div>
                            <div class="input-group"><label for="add-student-roll">Roll Number</label><input type="text" id="add-student-roll" required></div>
                            <div class="input-group"><label for="add-student-class">Class</label><select id="add-student-class" required></select></div>
                            <div class="input-group"><label for="add-student-gender">Gender</label><select id="add-student-gender" required><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
                            <div class="input-group"><label for="add-student-father">Father's Name</label><input type="text" id="add-student-father"></div>
                            <div class="input-group"><label for="add-student-mother">Mother's Name</label><input type="text" id="add-student-mother"></div>
                            <div class="input-group"><label for="add-student-mobile">Mobile</label><input type="tel" id="add-student-mobile"></div>
                            <div class="input-group"><label for="add-student-gmail">Gmail</label><input type="email" id="add-student-gmail"></div>
                            <div class="input-group"><label for="add-student-password">Password</label><input type="password" id="add-student-password" required></div>
                            <div class="input-group"><label for="add-student-aadhar">Aadhar Number</label><input type="text" id="add-student-aadhar"></div>
                            <div class="input-group full-width"><label for="add-student-address">Address</label><input type="text" id="add-student-address"></div>
                            <div class="input-group full-width"><label for="add-student-photo">Photo</label><input type="file" id="add-student-photo" accept="image/*"></div>
                        </div>
                        <button type="submit" class="modal-footer save-btn"><i class="fas fa-user-plus"></i> Add Student</button>
                    </form>
                </div>
            </section>
            
            <section id="add-staff-view" class="view-section add-form-view">
                <div class="view-header"><div class="title-text"><i class="fas fa-user-tie"></i> Add New Staff</div></div>
                <div class="section-content">
                    <div id="add-staff-message" class="message" style="display:none;"></div>
                    <form id="add-staff-form" novalidate>
                        <div class="form-grid">
                            <div class="input-group"><label for="add-staff-name">Name</label><input type="text" id="add-staff-name" required></div>
                            <div class="input-group"><label for="add-staff-mobile">Mobile</label><input type="tel" id="add-staff-mobile" required></div>
                            <div class="input-group"><label for="add-staff-gmail">Gmail</label><input type="email" id="add-staff-gmail"></div>
                            <div class="input-group"><label for="add-staff-password">Password</label><input type="password" id="add-staff-password" required></div>
                            <div class="input-group"><label for="add-staff-salary">Salary Amount</label><input type="number" id="add-staff-salary" required min="0"></div>
                            <div class="input-group"><label for="add-staff-active">Status</label><select id="add-staff-active" required><option value="TRUE">Active</option><option value="FALSE">Inactive</option></select></div>
                             <div class="input-group full-width"><label for="add-staff-photo">Photo</label><input type="file" id="add-staff-photo" accept="image/*"></div>
                        </div>
                        <button type="submit" class="modal-footer save-btn"><i class="fas fa-user-plus"></i> Add Staff</button>
                    </form>
                </div>
            </section>
            
            <section id="add-class-view" class="view-section add-form-view">
                <div class="view-header"><div class="title-text"><i class="fas fa-chalkboard"></i> Add New Class</div></div>
                <div class="section-content">
                    <div id="add-class-message" class="message" style="display:none;"></div>
                     <form id="add-class-form" novalidate>
                        <div class="form-grid">
                            <div class="input-group"><label for="add-class-name">Class Name</label><input type="text" id="add-class-name" required placeholder="e.g. Class 10"></div>
                            <div class="input-group"><label for="add-class-section">Section</label><input type="text" id="add-class-section" required placeholder="e.g. A"></div>
                        </div>
                        <button type="submit" class="modal-footer save-btn"><i class="fas fa-plus-circle"></i> Add Class</button>
                    </form>
                </div>
            </section>
            
            <section id="add-subject-view" class="view-section add-form-view">
                 <div class="view-header"><div class="title-text"><i class="fas fa-book"></i> Add New Subject</div></div>
                 <div class="section-content">
                     <div id="add-subject-message" class="message" style="display:none;"></div>
                      <form id="add-subject-form" novalidate>
                         <div class="form-grid">
                             <div class="input-group full-width"><label for="add-subject-name">Subject Name</label><input type="text" id="add-subject-name" required placeholder="e.g. Mathematics"></div>
                         </div>
                         <button type="submit" class="modal-footer save-btn"><i class="fas fa-plus-circle"></i> Add Subject</button>
                     </form>
                 </div>
            </section>
            
            <section id="assign-teacher-view" class="view-section add-form-view">
                <div class="view-header"><div class="title-text"><i class="fas fa-chalkboard-teacher"></i> Assign Class Teacher</div></div>
                 <div class="section-content">
                     <div id="assign-teacher-message" class="message" style="display:none;"></div>
                     <form id="assign-teacher-form" novalidate>
                         <div class="form-grid">
                            <div class="input-group"><label for="assign-teacher-class">Select Class</label><select id="assign-teacher-class" required></select></div>
                            <div class="input-group"><label for="assign-teacher-staff">Select Teacher</label><select id="assign-teacher-staff" required></select></div>
                         </div>
                         <button type="submit" class="modal-footer save-btn"><i class="fas fa-check-circle"></i> Assign Teacher</button>
                     </form>
                 </div>
            </section>

            <section id="add-expense-view" class="view-section add-form-view">
                 <div class="view-header"><div class="title-text"><i class="fas fa-receipt"></i> Add New Expense</div></div>
                 <div class="section-content">
                     <div id="add-expense-message" class="message" style="display:none;"></div>
                     <form id="add-expense-form" novalidate>
                          <div class="form-grid">
                             <div class="input-group"><label for="add-expense-category">Category</label><input type="text" id="add-expense-category" required placeholder="e.g. Stationary Cost"></div>
                             <div class="input-group"><label for="add-expense-amount">Amount</label><input type="number" id="add-expense-amount" required placeholder="e.g. 5000" min="0"></div>
                             <div class="input-group full-width"><label for="add-expense-description">Description</label><input type="text" id="add-expense-description" required></div>
                         </div>
                         <button type="submit" class="modal-footer save-btn"><i class="fas fa-plus-circle"></i> Add Expense</button>
                     </form>
                 </div>
            </section>
            
            <section id="tools-view" class="view-section">
                <div class="view-header"><div class="title-text"><i class="fas fa-tools"></i> Tools Hub</div></div>
                <div class="section-content">
                    <div id="tools-message" class="message info" style="display: none;"></div>
                    <div id="tools-view-content"></div>
                </div>
            </section>

            <section id="generic-sheet-view" class="view-section">
                 <div class="view-header">
                     <div class="title-text" id="generic-view-title"><i class="far fa-file-alt"></i> Sheet View</div>
                      <div class="header-action-buttons">
                           <button id="download-sheet-json-btn" class="info-btn" style="display:none;"><i class="fas fa-download"></i> Download JSON</button>
                      </div>
                 </div>
                 <div class="section-content">
                    <div id="generic-sheet-message" class="message info" style="display: none;"></div>
                    <div id="generic-table-container" class="data-table-container">
                        <table id="generic-data-table" class="data-table">
                            <thead><tr id="generic-table-header-row"></tr></thead>
                            <tbody id="generic-table-body"></tbody>
                        </table>
                    </div>
                 </div>
            </section>

        </div> 
    </main>
</div> 

<div id="fullscreen-iframe-container">
    <div id="fullscreen-iframe-header">
        <span id="fullscreen-iframe-title">Embedded Content</span>
        <button id="close-fullscreen-iframe-btn"><i class="fas fa-times"></i> Close</button>
    </div>
    <div id="fullscreen-iframe-wrapper">
        <iframe id="fullscreen-iframe" src="about:blank" allowfullscreen sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
    </div>
</div>

<div id="editStudentModal" class="modal"><div class="modal-content modal-lg"><div class="modal-header"><h3><i class="fas fa-user-edit"></i> Edit Student</h3><button class="close-btn" data-modal-id="editStudentModal">×</button></div><div class="modal-body"><form id="edit-student-form" novalidate><input type="hidden" id="edit-student-id"><div class="form-grid"><div class="input-group"><label for="edit-rollNumber">Roll No:</label><input type="text" id="edit-rollNumber" required></div><div class="input-group"><label for="edit-name">Name:</label><input type="text" id="edit-name" required></div><div class="input-group"><label for="edit-class">Class:</label><select id="edit-class" required></select></div><div class="input-group"><label for="edit-mobile">Mobile:</label><input type="tel" id="edit-mobile"></div><div class="input-group"><label for="edit-gmail">Gmail:</label><input type="email" id="edit-gmail"></div><div class="input-group"><label for="edit-password">New Password:</label><input type="text" id="edit-password" placeholder="Leave blank to keep current"></div><div class="input-group"><label for="edit-fatherName">Father:</label><input type="text" id="edit-fatherName"></div><div class="input-group"><label for="edit-motherName">Mother:</label><input type="text" id="edit-motherName"></div><div class="input-group"><label for="edit-address">Address:</label><input type="text" id="edit-address"></div><div class="input-group"><label for="edit-photoURL">Photo URL:</label><input type="url" id="edit-photoURL"></div><div class="input-group"><label for="edit-aadhar">Aadhar:</label><input type="text" id="edit-aadhar"></div><div class="input-group"><label for="edit-gender">Gender:</label><select id="edit-gender"><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div></div></form></div><div class="modal-footer"><div id="edit-student-message" class="message" style="display:none;"></div><button type="button" class="cancel-btn" data-modal-id="editStudentModal"><i class="fas fa-times"></i> Cancel</button><button type="button" class="save-btn" id="save-student-changes-btn"><i class="fas fa-save"></i> Save Changes</button></div></div></div>

<div id="studentDetailsModal" class="modal"><div class="modal-content modal-xl"><div class="modal-header"><h3 id="student-details-modal-title"><i class="fas fa-user-check"></i> Student Details</h3><button class="close-btn" data-modal-id="studentDetailsModal">×</button></div><div class="modal-body" id="student-details-modal-body"></div><div class="modal-footer"><button type="button" class="cancel-btn" data-modal-id="studentDetailsModal"><i class="fas fa-times"></i> Close</button></div></div></div>

<div id="genericEditModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="generic-edit-modal-title"><i class="fas fa-edit"></i> Edit Row</h3><button class="close-btn" data-modal-id="genericEditModal">×</button></div><div class="modal-body"><form id="generic-edit-form" novalidate><input type="hidden" id="generic-edit-sheetname"><input type="hidden" id="generic-edit-rowindex"><div id="generic-edit-form-fields" class="form-grid"></div></form></div><div class="modal-footer"><div id="generic-edit-message" class="message" style="display:none;"></div><button type="button" class="cancel-btn" data-modal-id="genericEditModal"><i class="fas fa-times"></i> Cancel</button><button type="button" class="save-btn" id="save-generic-changes-btn"><i class="fas fa-save"></i> Save Changes</button></div></div></div>

<div id="staffDetailsModal" class="modal"><div class="modal-content modal-xl"><div class="modal-header"><h3 id="staff-details-modal-title"><i class="fas fa-user-tie"></i> Staff Details</h3><button class="close-btn" data-modal-id="staffDetailsModal">×</button></div><div class="modal-body" id="staff-details-modal-body"></div><div class="modal-footer" id="staff-details-modal-footer"><div id="add-salary-message" class="message" style="display:none;"></div><button type="button" class="cancel-btn" data-modal-id="staffDetailsModal"><i class="fas fa-times"></i> Close</button><button type="button" class="save-btn" id="add-salary-payment-btn-modal" style="display:none;"><i class="fas fa-money-check-alt"></i> Save Payment</button></div></div></div>

<script>
    let schoolSpreadsheetId = null;
    let authToken = null;
    let studentsData = [], currentClassStudents = [], classMapping = {}, feeTypes = [], staffListData = [],
        currentResultConfig = null, currentStudentForResult = null, studentsWithResults = new Set(),
        currentGenericSheetName = null, currentGenericHeaders = [], currentGenericData = [], currentView = 'dashboard-view',
        dashboardCharts = {}, cachedTools = [], cachedGenerators = [], cachedSubjects = [];
    const { jsPDF } = window.jspdf;

    const D = {
        loadingOverlay:document.getElementById("loading-overlay"),loginContainer:document.getElementById("login-container"),loginSection:document.getElementById("login-section"),premiumInfoSection:document.getElementById("premium-info-section"),appContainer:document.getElementById("app-container"),loginForm:document.getElementById("login-form"),mobileInput:document.getElementById("mobile"),passwordInput:document.getElementById("password"),loginButton:document.getElementById("login-btn"),loginMessage:document.getElementById("login-message"),premiumBackBtn:document.getElementById("premium-back-btn"),
        sidebar:document.getElementById("sidebar"),sidebarMenu:document.getElementById("sidebar-menu"),sidebarToggle:document.getElementById("sidebar-toggle"),sidebarToggleMobile:document.getElementById("sidebar-toggle-mobile"),sheetDivider:document.getElementById("sheet-divider"),generatorDivider:document.getElementById("generator-divider"),
        topHeader:document.getElementById("top-header"),mainHeaderTitle:document.getElementById("main-header-title"),userGreeting:document.getElementById("user-greeting"),logoutBtn:document.getElementById("logout-btn"),mainContent:document.getElementById("main-content"),viewSections:document.querySelectorAll(".view-section"),downloadPdfBtn:document.getElementById("download-pdf-btn"),
        dashboardView:document.getElementById("dashboard-view"),dashboardMessage:document.getElementById("dashboard-message"),dbTotalStudents:document.getElementById("db-total-students"),dbTotalStaff:document.getElementById("db-total-staff"),dbTotalClasses:document.getElementById("db-total-classes"),dbTotalGirls:document.getElementById("db-total-girls"),dbTotalBoys:document.getElementById("db-total-boys"),dbTotalPaid:document.getElementById("db-total-paid"),dbTotalDue:document.getElementById("db-total-due"),dbTotalExpenses:document.getElementById("db-total-expenses"),
        studentsPerClassChartEl:document.getElementById("studentsPerClassChart"),genderSplitPerClassChartEl:document.getElementById("genderSplitPerClassChart"),feesCollectedPerClassChartEl:document.getElementById("feesCollectedPerClassChart"),duesPerClassChartEl:document.getElementById("duesPerClassChart"),attendancePerClassChartEl:document.getElementById("attendancePerClassChart"),
        studentListView:document.getElementById("student-list-view"),studentListMessage:document.getElementById("student-list-message"),studentListMainContent:document.getElementById("student-list-main-content"),
        editStudentModal:document.getElementById("editStudentModal"),editStudentForm:document.getElementById("edit-student-form"),editStudentMessage:document.getElementById("edit-student-message"),saveStudentChangesBtn:document.getElementById("save-student-changes-btn"),editClassSelect:document.getElementById("edit-class"),
        studentDetailsModal:document.getElementById("studentDetailsModal"),studentDetailsModalTitle:document.getElementById("student-details-modal-title"),studentDetailsModalBody:document.getElementById("student-details-modal-body"),
        addResultsView:document.getElementById("add-results-view"),step1ResultDetails:document.getElementById("step1-result-details"),step2SelectStudent:document.getElementById("step2-select-student"),step3EnterMarks:document.getElementById("step3-enter-marks"),resultNameInput:document.getElementById("result-name"),schoolNameInput:document.getElementById("school-name"),teacherNameInput:document.getElementById("teacher-name"),resultClassSelect:document.getElementById("result-class"),subjectsContainer:document.getElementById("subjects-container"),addSubjectBtn:document.getElementById("add-subject-btn"),nextToStep2Btn:document.getElementById("next-to-step2-btn"),backToStep1Btn:document.getElementById("back-to-step1-btn"),backToStep2Btn:document.getElementById("back-to-step2-btn"),submitMarksBtn:document.getElementById("submit-marks-btn"),resultsStudentList:document.getElementById("results-student-list"),selectedClassInfo:document.getElementById("selected-class-info"),selectedStudentInfo:document.getElementById("selected-student-info"),marksEntryContainer:document.getElementById("marks-entry-container"),marksEntryForm:document.getElementById("marks-entry-form"),marksEntryMessage:document.getElementById("marks-entry-message"),addResultsMessage:document.getElementById("add-results-message"),
        genericSheetView:document.getElementById("generic-sheet-view"),genericSheetMessage:document.getElementById("generic-sheet-message"),genericTableContainer:document.getElementById("generic-table-container"),genericDataTable:document.getElementById("generic-data-table"),genericTableHeaderRow:document.getElementById("generic-table-header-row"),genericTableBody:document.getElementById("generic-table-body"),genericViewTitle:document.getElementById("generic-view-title"),downloadSheetJsonBtn:document.getElementById("download-sheet-json-btn"),
        genericEditModal:document.getElementById("genericEditModal"),genericEditModalTitle:document.getElementById("generic-edit-modal-title"),genericEditForm:document.getElementById("generic-edit-form"),genericEditFormFields:document.getElementById("generic-edit-form-fields"),genericEditMessage:document.getElementById("generic-edit-message"),saveGenericChangesBtn:document.getElementById("save-generic-changes-btn"),genericEditSheetNameInput:document.getElementById("generic-edit-sheetname"),genericEditRowIndexInput:document.getElementById("generic-edit-rowindex"),
        toolsView:document.getElementById("tools-view"),toolsViewContent:document.getElementById("tools-view-content"),toolsMessage:document.getElementById("tools-message"),
        fullscreenIframeContainer:document.getElementById("fullscreen-iframe-container"),fullscreenIframeEl:document.getElementById("fullscreen-iframe"),fullscreenIframeTitle:document.getElementById("fullscreen-iframe-title"),closeFullscreenIframeBtn:document.getElementById("close-fullscreen-iframe-btn"),
        addFeesView:document.getElementById("add-fees-view"),addFeesForm:document.getElementById("add-fees-form"),feeClassSelect:document.getElementById("fee-class-select"),feeTypeSelect:document.getElementById("fee-type-select"),feeAmountInput:document.getElementById("fee-amount"),feeMonthYearInput:document.getElementById("fee-month-year"),feeDueDateInput:document.getElementById("fee-due-date"),feeAcademicYearInput:document.getElementById("fee-academic-year"),addFeesMessage:document.getElementById("add-fees-message"),
        staffListView:document.getElementById("staff-list-view"),staffListMessage:document.getElementById("staff-list-message"),staffTableBody:document.getElementById("staff-table-body"),
        staffDetailsModal:document.getElementById("staffDetailsModal"),staffDetailsModalTitle:document.getElementById("staff-details-modal-title"),staffDetailsModalBody:document.getElementById("staff-details-modal-body"),staffDetailsModalFooter:document.getElementById("staff-details-modal-footer"),addSalaryMessage:document.getElementById("add-salary-message"),addSalaryPaymentBtnModal:document.getElementById("add-salary-payment-btn-modal"),
        
        addStudentView: document.getElementById('add-student-view'), addStudentForm: document.getElementById('add-student-form'), addStudentMessage: document.getElementById('add-student-message'), addStudentClassSelect: document.getElementById('add-student-class'), addStudentPhotoInput: document.getElementById('add-student-photo'),
        addStaffView: document.getElementById('add-staff-view'), addStaffForm: document.getElementById('add-staff-form'), addStaffMessage: document.getElementById('add-staff-message'), addStaffPhotoInput: document.getElementById('add-staff-photo'),
        addClassView: document.getElementById('add-class-view'), addClassForm: document.getElementById('add-class-form'), addClassMessage: document.getElementById('add-class-message'),
        addSubjectView: document.getElementById('add-subject-view'), addSubjectForm: document.getElementById('add-subject-form'), addSubjectMessage: document.getElementById('add-subject-message'),
        assignTeacherView: document.getElementById('assign-teacher-view'), assignTeacherForm: document.getElementById('assign-teacher-form'), assignTeacherMessage: document.getElementById('assign-teacher-message'), assignTeacherClassSelect: document.getElementById('assign-teacher-class'), assignTeacherStaffSelect: document.getElementById('assign-teacher-staff'),
        addExpenseView: document.getElementById('add-expense-view'), addExpenseForm: document.getElementById('add-expense-form'), addExpenseMessage: document.getElementById('add-expense-message')
    };

    const GITHUB_API_KEY = "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"; const GITHUB_USERNAME = "edu1129"; const GITHUB_REPO = "Hhhhh";
    const showLoading=()=>D.loadingOverlay.classList.add("show"),hideLoading=()=>D.loadingOverlay.classList.remove("show");function showMessage(e,t,o="error",a=!0){if(!e)return;const s="error"===o?"fa-times-circle":"success"===o?"fa-check-circle":"warning"===o?"fa-exclamation-triangle":"fa-info-circle";e.innerHTML=`<i class="fas ${s} fa-message-icon"></i> ${t}`,e.className=`message ${o}`,e.style.display="flex",a&&"success"===o&&setTimeout(()=>hideMessage(e),4e3)}function hideMessage(e){e&&(e.style.display="none",e.innerHTML="",e.className="message")}
    const sanitizeHTML=e=>{const t=document.createElement("div");return t.textContent=e||"",t.innerHTML};function openModal(e){const t=document.getElementById(e);t&&(t.style.display="block"),document.body.style.overflow="hidden"}function closeModal(e){const t=document.getElementById(e);t&&(t.style.display="none"),Array.from(document.querySelectorAll(".modal")).some((e=>"block"===e.style.display))||(document.body.style.overflow="")}
    function getStudentPhotoHtml(e,t="student-photo",o="fa-user"){const a=`<div class="${t}-placeholder"><i class="fas ${o}"></i></div>`;if(!e||"string"!=typeof e||!e.trim())return a;try{return new URL(e),`<img src="${sanitizeHTML(e)}" alt="Photo" class="${t}" onerror="this.outerHTML = '${a.replace(/"/g,"\\\"")}';">`}catch(e){return a}}function getCurrentMonthYear(){return(new Date).toLocaleString("default",{month:"long",year:"numeric"})}function getCurrentAcademicYear(){const e=new Date,t=e.getFullYear(),o=e.getMonth()+1;return o>=4?`${t}-${String(t+1).slice(-2)}`:`${t-1}-${String(t).slice(-2)}`}
    function formatDateForInput(e){if(!e)return"";try{return(new Date(e)).toISOString().split("T")[0]}catch(e){return""}}function formatDisplayDate(e){if(!e)return"N/A";try{const t=new Date(e);return isNaN(t)?e:t.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}catch(t){return e}}function formatCurrency(e){return parseFloat(e||0).toLocaleString("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:0,maximumFractionDigits:2})}
    
    async function uploadToGitHub(file) {
        if (!file) return { success: true, url: null }; 
        const reader = new FileReader();
        return new Promise((resolve) => {
            reader.onloadend = async () => {
                const base64Content = reader.result.split(',')[1];
                const fileName = `${new Date().getTime()}-${file.name}`;
                const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/uploads/${fileName}`;
                try {
                    const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${GITHUB_API_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Upload: ${fileName}`, content: base64Content }) });
                    const result = await response.json();
                    if (response.ok && result.content?.download_url) { resolve({ success: true, url: result.content.download_url });
                    } else { console.error("GitHub Upload Error:", result); resolve({ success: false, error: result.message || 'Failed to upload photo.' }); }
                } catch (error) { console.error("Network Error during GitHub Upload:", error); resolve({ success: false, error: 'Network error during upload.' }); }
            };
            reader.onerror = () => { resolve({ success: false, error: 'Failed to read file for upload.' }); };
            reader.readAsDataURL(file);
        });
    }

    async function callBackendApi(action, payload={}) { showLoading(); const endpoint=`/api/${action}`; if(action!=="login"){if(schoolSpreadsheetId)payload.spreadsheetId=schoolSpreadsheetId;if(authToken)payload.token=authToken} try { const res = await fetch(endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}); const result = await res.json(); hideLoading(); if(result.success===false&&result.message&&result.message.toLowerCase().includes("token")){showMessage(D.loginMessage,`Session expired. Please log in again. (${result.message})`,"error");showLoginView();return{success:!1,error:"Authentication failed."}} if(!res.ok)throw new Error(result.error||result.message||`HTTP ${res.status}`); return result } catch(err) { hideLoading(); console.error(`API Error (${action}):`,err); const isAutoLoggedIn = localStorage.getItem("schoolSpreadsheetId"); let msgEl=D.loginMessage; if(D.appContainer.classList.contains("visible")){const modal=document.querySelector('.modal[style*="display: block"]');if(modal)msgEl=modal.querySelector('.message[id$="-message"]');else msgEl=document.getElementById(`${currentView.replace(/-/g,"")}-message`)||D.dashboardMessage} if(isAutoLoggedIn&&action!=="login"){showMessage(msgEl||D.loginMessage,"Connection error. Please log in again.","error");showLoginView()}else{showMessage(msgEl||D.loginMessage,`Network/Server Error: ${err.message}`,"error")} return{success:!1,error:err.message} } }
    
    function showLoginView(){D.loginContainer.classList.remove("hidden");D.appContainer.classList.remove("visible");D.loginSection.style.display="block";D.premiumInfoSection.style.display="none";D.loginForm.reset();hideMessage(D.loginMessage);D.loginButton.classList.remove("processing");D.loginButton.disabled=!1;schoolSpreadsheetId=null;authToken=null;studentsData=[];classMapping={};feeTypes=[];staffListData=[];cachedTools=[];cachedGenerators=[];currentResultConfig=null;currentStudentForResult=null;studentsWithResults.clear();currentGenericHeaders=[];currentGenericData=[];clearDynamicMenuItems();Object.values(dashboardCharts).forEach((e=>e?.destroy()));dashboardCharts={};localStorage.removeItem("schoolSpreadsheetId");localStorage.removeItem("userMobile");localStorage.removeItem("authToken");D.userGreeting.textContent="";document.body.style.overflow=""}
    async function showAppView(){D.loginContainer.classList.add("hidden");D.appContainer.classList.add("visible");const e=localStorage.getItem("userMobile");D.userGreeting.textContent=e?`Welcome, ${sanitizeHTML(e)}`:"";await loadInitialAppData();switchView("dashboard-view","Dashboard","nav-dashboard")}function showPremiumView(){D.loginSection.style.display="none",D.premiumInfoSection.style.display="block"}
    D.loginForm.addEventListener("submit",async e=>{e.preventDefault(),hideMessage(D.loginMessage);const t=D.mobileInput.value.trim(),o=D.passwordInput.value.trim();if(!t||!o)return void showMessage(D.loginMessage,"Mobile and password are required.","warning");D.loginButton.classList.add("processing"),D.loginButton.disabled=!0;try{const s=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mobile:t,password:o})}),a=await s.json();D.loginButton.classList.remove("processing"),D.loginButton.disabled=!1,s.ok&&a?.success&&a.spreadsheetId&&a.token?(schoolSpreadsheetId=a.spreadsheetId,authToken=a.token,localStorage.setItem("schoolSpreadsheetId",schoolSpreadsheetId),localStorage.setItem("authToken",authToken),localStorage.setItem("userMobile",t),await showAppView()):s.ok&&"not_premium"===a?.reason?showPremiumView():(showMessage(D.loginMessage,a?.message||a?.error||"Login failed. Check credentials.","error"),localStorage.clear())}catch(i){D.loginButton.classList.remove("processing"),D.loginButton.disabled=!1,console.error("Login fetch error:",i),showMessage(D.loginMessage,`Login Error: ${i.message}`,"error"),localStorage.clear()}});
    D.premiumBackBtn.addEventListener("click",()=>{D.premiumInfoSection.style.display="none",D.loginSection.style.display="block",D.loginForm.reset(),hideMessage(D.loginMessage)}),D.logoutBtn.addEventListener("click",()=>{confirm("Are you sure you want to logout?")&&showLoginView()});function toggleSidebar(){D.sidebar.classList.toggle("collapsed")}
    D.sidebarToggle.addEventListener("click",toggleSidebar),D.sidebarToggleMobile.addEventListener("click",()=>D.sidebar.classList.toggle("open")),D.mainContent.addEventListener("click",()=>{window.innerWidth<=768&&D.sidebar.classList.contains("open")&&D.sidebar.classList.remove("open")});function setActiveMenuItem(e){D.sidebarMenu.querySelectorAll("li").forEach((e=>e.classList.remove("active")));const t=document.getElementById(e);t&&t.classList.add("active")}
    function switchView(viewId,title,navId){ D.viewSections.forEach((s=>s.classList.remove("active"))); const target=document.getElementById(viewId); if(target){target.classList.add("active");currentView=viewId;D.mainHeaderTitle.textContent=title||"School System";if(navId)setActiveMenuItem(navId); if (viewId === 'dashboard-view') loadDashboardData(); else if (viewId === 'student-list-view') { studentsData.length > 0 && Object.keys(classMapping).length > 0 ? displayClassTiles() : loadStudentsAndClasses(); } else if (viewId === 'tools-view') loadTools(); else if (viewId === 'add-fees-view') prepareAddFeesForm(); else if (viewId === 'staff-list-view') loadStaffList(); else if (viewId === 'add-results-view') { D.resultClassSelect.options.length <=1 && Object.keys(classMapping).length > 0 && populateClassDropdowns(); showStep(1); } else if (viewId === 'add-student-view') prepareAddStudentForm(); else if (viewId === 'add-staff-view') D.addStaffForm.reset(); else if (viewId === 'add-class-view') D.addClassForm.reset(); else if (viewId === 'add-subject-view') D.addSubjectForm.reset(); else if (viewId === 'assign-teacher-view') prepareAssignTeacherForm(); else if (viewId === 'add-expense-view') D.addExpenseForm.reset(); }else console.error(`View "${viewId}" not found.`);updatePdfButtonVisibility(viewId);if(window.innerWidth<=768&&D.sidebar.classList.contains("open"))D.sidebar.classList.remove("open");D.mainContent.scrollTop=0}
    D.sidebarMenu.addEventListener('click', (e) => { const link = e.target.closest('a'); if (link) { const viewId = link.dataset.view, sheetName = link.dataset.sheetName, iframeUrl = link.dataset.iframeUrl, iframeName = link.dataset.iframeName, navId = link.closest('li').id; let title = link.querySelector('.menu-text')?.textContent || 'View'; if (iframeUrl) { e.preventDefault(); openFullscreenIframe(iframeName || title, iframeUrl); navId && setActiveMenuItem(navId); } else if (viewId) { e.preventDefault(); switchView(viewId, title, navId); viewId === 'generic-sheet-view' && sheetName && loadGenericSheetData(sheetName); } } });
    async function loadInitialAppData(){if(!schoolSpreadsheetId||!authToken)return console.error("Missing Spreadsheet ID or Auth Token."),void showLoginView();showLoading();try{await Promise.all([loadStudentsAndClasses(!1),loadSheetNames(!1),loadFeeTypes(!1),loadStaffList(!1),loadToolsAndGenerators(!1)])}catch(e){console.error("Error during initial data load batch:",e),showMessage(D.dashboardMessage||D.loginMessage,`Failed to load critical school data: ${e.message}`,"error")}clearDynamicMenuItems(),populateDynamicSidebarItems(),populateClassDropdowns(),hideLoading()}
    let cachedSheetNames=[];async function loadSheetNames(e=!0){if(!schoolSpreadsheetId)return;e&&(D.genericSheetMessage||D.dashboardMessage)&&showMessage(D.genericSheetMessage||D.dashboardMessage,"Loading sheet list...","info");const t=await callBackendApi("getSheetNames",{});t?.success&&t.data?(cachedSheetNames=t.data,e&&populateDynamicSidebarItems()):(console.error("Failed to load sheet names:",t?.error),e&&(D.genericSheetMessage||D.dashboardMessage)&&showMessage(D.genericSheetMessage||D.dashboardMessage,`Error loading sheet list: ${t?.error}`,"error"))}
    async function loadToolsAndGenerators(e=!0){try{const t=await fetch("./tools.json");t.ok?cachedTools=await t.json():console.warn("tools.json not found or not accessible.")}catch(t){console.warn("Error fetching tools.json",t),cachedTools=[]}try{const t=await fetch("./generator.json");t.ok?cachedGenerators=await t.json():console.warn("generator.json not found or not accessible.")}catch(t){console.warn("Error fetching generator.json",t),cachedGenerators=[]}e&&populateDynamicSidebarItems()}
    function clearDynamicMenuItems(){D.sidebarMenu.querySelectorAll(".dynamic-sheet-item, .dynamic-generator-item").forEach((e=>e.remove())),D.sheetDivider.style.display="none",D.generatorDivider.style.display="none"}
    function populateDynamicSidebarItems(){clearDynamicMenuItems();const e=document.createDocumentFragment();let t=!1,o=!1;const a=["expenses","Permissions"];cachedGenerators&&cachedGenerators.length>0&&(cachedGenerators.forEach((t=>{const o=document.createElement("li");o.className="dynamic-generator-item",o.id=`nav-generator-${sanitizeHTML(t.name.replace(/[^a-zA-Z0-9]/g,"-"))}`,o.innerHTML=`<a data-iframe-url="${sanitizeHTML(t.url)}" data-iframe-name="${sanitizeHTML(t.name)}">\n                                <i class="${sanitizeHTML(t.icon||"fas fa-cogs")}"></i>\n                                <span class="menu-text">${sanitizeHTML(t.name)}</span>\n                              </a>`,e.appendChild(o),generatorsAdded=!0})),generatorsAdded&&(D.generatorDivider.style.display="block")),D.generatorDivider.after(...Array.from(e.childNodes));const s=document.createDocumentFragment();cachedSheetNames.forEach((e=>{const i=e.toLowerCase().replace(/\s+/g,"");if(a.some((e=>i.includes(e))))return;const n=document.createElement("li");n.className="dynamic-sheet-item",n.id=`nav-sheet-${sanitizeHTML(e.replace(/[^a-zA-Z0-9]/g,"-"))}`,n.innerHTML=`<a data-view="generic-sheet-view" data-sheet-name="${sanitizeHTML(e)}"><i class="far fa-file-excel"></i><span class="menu-text">${sanitizeHTML(e)}</span></a>`,s.appendChild(n),t=!0})),t&&(D.sheetDivider.style.display="block",D.sidebarMenu.appendChild(s))}
    async function loadStudentsAndClasses(e=!0){if(!schoolSpreadsheetId)return;e&&D.studentListMessage&&showMessage(D.studentListMessage,"Loading student and class data...","info");const t=await callBackendApi("getStudents",{});t?.success&&t.data?(e&&D.studentListMessage&&hideMessage(D.studentListMessage),studentsData=t.data.students||[],classMapping=t.data.classes||{},("student-list-view"===currentView||document.getElementById("student-list-view").classList.contains("active"))&&displayClassTiles(),populateClassDropdowns()):e&&D.studentListMessage&&showMessage(D.studentListMessage,t?.error||"Failed to load students data.","error")}
    function displayClassTiles(){D.studentListMainContent.innerHTML="";const e=document.createElement("div");if(e.id="student-classes-list",0===Object.keys(classMapping).length)e.innerHTML='<p class="message warning">No classes found. Please configure classes in your spreadsheet.</p>';else{const t=Object.keys(classMapping).sort(((e,t)=>classMapping[e].displayName.localeCompare(classMapping[t].displayName)));t.forEach((t=>{const o=classMapping[t],a=document.createElement("div");a.className="class-tile",a.dataset.classId=t,a.innerHTML=`<i class="fas fa-chalkboard"></i><h4>${sanitizeHTML(o.displayName)}</h4><p>${studentsData.filter((e=>e.Class===t)).length} Students</p>`,a.addEventListener("click",(()=>displayStudentsForClass(t))),e.appendChild(a)}))}D.studentListMainContent.appendChild(e),updatePdfButtonVisibility(currentView),D.studentListMainContent.dataset.currentClassId=""}
    function displayStudentsForClass(e){D.studentListMainContent.innerHTML="",currentClassStudents=studentsData.filter((t=>String(t.Class||"").trim()===e)),D.studentListMainContent.dataset.currentClassId=e;const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.marginBottom="20px";const o=document.createElement("button");o.innerHTML='<i class="fas fa-arrow-left"></i> Back to Classes',o.className="btn cancel-btn back-to-classes-btn",o.addEventListener("click",displayClassTiles),t.appendChild(o);const a=document.createElement("h3");a.style.textAlign="right",a.style.flexGrow="1",a.style.color="var(--primary-color)",a.style.fontFamily="'Titillium Web', sans-serif",a.textContent=`${sanitizeHTML(classMapping[e]?.displayName||e)} - Student List`,t.appendChild(a),D.studentListMainContent.appendChild(t);const s=document.createElement("div");s.className="student-table-container data-table-container";const i=document.createElement("table");i.className="student-table data-table",i.innerHTML='<thead><tr><th>Photo</th><th>Roll No</th><th>Name</th><th>Mobile</th><th>Father\'s Name</th><th>Actions</th></tr></thead><tbody id="current-class-student-table-body"></tbody>',s.appendChild(i),D.studentListMainContent.appendChild(s);const n=document.getElementById("current-class-student-table-body");if(n.innerHTML="",0===currentClassStudents.length)n.innerHTML='<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-light-color);">No students in this class.</td></tr>';else{const r=document.createDocumentFragment();currentClassStudents.sort(((e,t)=>(e.RollNumber||"").localeCompare(t.RollNumber||"",void 0,{numeric:!0})||(e.Name||"").localeCompare(t.Name||""))).forEach((e=>{const t=document.createElement("tr");t.innerHTML=`<td>${getStudentPhotoHtml(e.PhotoURL,"student-photo")}</td><td>${sanitizeHTML(e.RollNumber||"N/A")}</td><td>${sanitizeHTML(e.Name||"N/A")}</td><td>${sanitizeHTML(e.Mobile||"N/A")}</td><td>${sanitizeHTML(e.FatherName||"N/A")}</td><td class="action-col"><i class="fas fa-eye view-btn" title="View Details" data-studentid="${sanitizeHTML(e.StudentID)}"></i> <i class="fas fa-edit edit-btn" title="Edit Student" data-studentid="${sanitizeHTML(e.StudentID)}"></i> <i class="fas fa-trash-alt delete-btn" title="Delete Student" data-studentid="${sanitizeHTML(e.StudentID)}" data-studentname="${sanitizeHTML(e.Name||"this student")}"></i></td>`,r.appendChild(t)})),n.appendChild(r)}updatePdfButtonVisibility(currentView)}
    D.studentListMainContent.addEventListener("click",async e=>{if(e.target?.classList.contains("edit-btn")){const t=e.target.dataset.studentid;t&&openEditStudentModal(t)}if(e.target?.classList.contains("delete-btn")){const o=e.target.dataset.studentid,a=e.target.dataset.studentname;o&&handleDeleteStudent(o,a)}if(e.target?.classList.contains("view-btn")){const s=e.target.dataset.studentid;s&&openStudentDetailsModal(s)}});
    function populateClassDropdowns(){const e=(e,t)=>{const o=document.createElement("option");return o.value=e,o.textContent=t,o},t=[D.editClassSelect,D.resultClassSelect,D.feeClassSelect, D.addStudentClassSelect, D.assignTeacherClassSelect];t.forEach((t=>{if(t){const o=t.value;t.innerHTML='<option value="" disabled selected>-- Select Class --</option>';const a=Object.keys(classMapping).sort(((e,t)=>classMapping[e].displayName.localeCompare(classMapping[t].displayName)));a.forEach((a=>{t.appendChild(e(a,classMapping[a].displayName))})),o&&(t.value=o)}}))}
    function openEditStudentModal(e){hideMessage(D.editStudentMessage);const t=studentsData.find((t=>String(t.StudentID)===String(e)));if(!t)return console.error("Student not found:",e),void showMessage(D.studentListMessage||D.dashboardMessage,"Student details not found.","error");D.editStudentForm.reset(),document.getElementById("edit-student-id").value=t.StudentID,document.getElementById("edit-rollNumber").value=t.RollNumber||"",document.getElementById("edit-name").value=t.Name||"",D.editClassSelect.value=t.Class||"",document.getElementById("edit-mobile").value=t.Mobile||"",document.getElementById("edit-gmail").value=t.Gmail||"",document.getElementById("edit-password").value="",document.getElementById("edit-fatherName").value=t.FatherName||"",document.getElementById("edit-motherName").value=t.MotherName||"",document.getElementById("edit-address").value=t.Address||"",document.getElementById("edit-photoURL").value=t.PhotoURL||"",document.getElementById("edit-aadhar").value=t.Aadhar||"",document.getElementById("edit-gender").value=t.Gender||"Male",openModal("editStudentModal")}
    D.saveStudentChangesBtn.addEventListener("click",async()=>{hideMessage(D.editStudentMessage);const e=document.getElementById("edit-name").value.trim(),t=document.getElementById("edit-rollNumber").value.trim(),o=D.editClassSelect.value;if(!e||!t||!o)return void showMessage(D.editStudentMessage,"Roll Number, Name, and Class are required.","error");const a=document.getElementById("edit-student-id").value,s={StudentID:a,RollNumber:t,Name:e,Class:o,Mobile:document.getElementById("edit-mobile").value.trim(),Gmail:document.getElementById("edit-gmail").value.trim(),Password:document.getElementById("edit-password").value.trim()||void 0,FatherName:document.getElementById("edit-fatherName").value.trim(),MotherName:document.getElementById("edit-motherName").value.trim(),Address:document.getElementById("edit-address").value.trim(),PhotoURL:document.getElementById("edit-photoURL").value.trim(),Aadhar:document.getElementById("edit-aadhar").value.trim(),Gender:document.getElementById("edit-gender").value};void 0===s.Password&&delete s.Password;const i=await callBackendApi("editStudent",{studentData:s});if(i?.success){showMessage(D.editStudentMessage,i.message||"Student updated successfully!","success"),await loadStudentsAndClasses(!1);const n=D.studentListMainContent.dataset.currentClassId;n?displayStudentsForClass(n):displayClassTiles(),setTimeout((()=>closeModal("editStudentModal")),1500)}else showMessage(D.editStudentMessage,i?.error||"Update failed. Try again.","error")});
    async function handleDeleteStudent(e,t){if(!confirm(`Delete ${t} (ID: ${e})? This is permanent.`))return;const o=await callBackendApi("deleteStudent",{studentId:e});if(o?.success){showMessage(D.studentListMessage||D.dashboardMessage,o.message||"Student deleted.","success"),await loadStudentsAndClasses(!1);const a=D.studentListMainContent.dataset.currentClassId;a?displayStudentsForClass(a):displayClassTiles()}else showMessage(D.studentListMessage||D.dashboardMessage,o?.error||"Failed to delete student.","error")}
    
    // --- New form handlers ---
    D.addStudentForm.addEventListener('submit', async(e) => { e.preventDefault(); const form = e.target, msgEl = D.addStudentMessage; hideMessage(msgEl); const photoFile = D.addStudentPhotoInput.files[0]; const photoUploadResult = await uploadToGitHub(photoFile); if (!photoUploadResult.success) return showMessage(msgEl, `Photo Upload Failed: ${photoUploadResult.error}`, 'error'); const studentData = { Name: document.getElementById('add-student-name').value.trim(), RollNumber: document.getElementById('add-student-roll').value.trim(), Class: D.addStudentClassSelect.value, Gender: document.getElementById('add-student-gender').value, FatherName: document.getElementById('add-student-father').value.trim(), MotherName: document.getElementById('add-student-mother').value.trim(), Mobile: document.getElementById('add-student-mobile').value.trim(), Gmail: document.getElementById('add-student-gmail').value.trim(), Password: document.getElementById('add-student-password').value.trim(), Aadhar: document.getElementById('add-student-aadhar').value.trim(), Address: document.getElementById('add-student-address').value.trim(), PhotoURL: photoUploadResult.url || ''}; if(!studentData.Name || !studentData.RollNumber || !studentData.Class || !studentData.Password) return showMessage(msgEl, "Name, Roll Number, Class and Password are required.", "error"); const result = await callBackendApi('addStudent', {studentData}); if(result?.success){showMessage(msgEl, result.message, 'success'); form.reset(); await loadStudentsAndClasses(false);} else {showMessage(msgEl, result?.error || "Failed to add student.", "error");}});
    D.addStaffForm.addEventListener('submit', async(e) => { e.preventDefault(); const form = e.target, msgEl = D.addStaffMessage; hideMessage(msgEl); const photoFile = D.addStaffPhotoInput.files[0]; const photoUploadResult = await uploadToGitHub(photoFile); if (!photoUploadResult.success) return showMessage(msgEl, `Photo Upload Failed: ${photoUploadResult.error}`, 'error'); const staffData = { Name: document.getElementById('add-staff-name').value.trim(), Mobile: document.getElementById('add-staff-mobile').value.trim(), Gmail: document.getElementById('add-staff-gmail').value.trim(), Password: document.getElementById('add-staff-password').value.trim(), SalaryAmount: document.getElementById('add-staff-salary').value.trim(), IsActive: document.getElementById('add-staff-active').value, PhotoURL: photoUploadResult.url || ''}; if(!staffData.Name || !staffData.Mobile || !staffData.Password || !staffData.SalaryAmount) return showMessage(msgEl, "Name, Mobile, Password and Salary are required.", "error"); const result = await callBackendApi('addStaff', {staffData}); if(result?.success){showMessage(msgEl, result.message, 'success'); form.reset(); await loadStaffList(false);} else {showMessage(msgEl, result?.error || "Failed to add staff.", "error");}});
    D.addClassForm.addEventListener('submit', async(e) => { e.preventDefault(); const form = e.target, msgEl = D.addClassMessage; hideMessage(msgEl); const classData = { ClassName: document.getElementById('add-class-name').value.trim(), Section: document.getElementById('add-class-section').value.trim() }; if(!classData.ClassName || !classData.Section) return showMessage(msgEl, "Class Name and Section are required.", "error"); const result = await callBackendApi('addClass', {classData}); if(result?.success){showMessage(msgEl, result.message, 'success'); form.reset(); await loadStudentsAndClasses(false);} else {showMessage(msgEl, result?.error || "Failed to add class.", "error");}});
    D.addSubjectForm.addEventListener('submit', async(e) => { e.preventDefault(); const form = e.target, msgEl = D.addSubjectMessage; hideMessage(msgEl); const subjectData = { SubjectName: document.getElementById('add-subject-name').value.trim() }; if(!subjectData.SubjectName) return showMessage(msgEl, "Subject Name is required.", "error"); const result = await callBackendApi('addSubject', {subjectData}); if(result?.success){showMessage(msgEl, result.message, 'success'); form.reset(); await loadSubjects(false);} else {showMessage(msgEl, result?.error || "Failed to add subject.", "error");}});
    D.assignTeacherForm.addEventListener('submit', async(e) => { e.preventDefault(); const form = e.target, msgEl = D.assignTeacherMessage; hideMessage(msgEl); const payload = { classId: D.assignTeacherClassSelect.value, staffId: D.assignTeacherStaffSelect.value }; if(!payload.classId || !payload.staffId) return showMessage(msgEl, "Please select both a class and a teacher.", "error"); const result = await callBackendApi('assignClassTeacher', payload); if(result?.success){showMessage(msgEl, result.message, 'success'); form.reset();} else {showMessage(msgEl, result?.error || "Failed to assign teacher.", "error");}});
    D.addExpenseForm.addEventListener('submit', async(e) => { e.preventDefault(); const form = e.target, msgEl = D.addExpenseMessage; hideMessage(msgEl); const expenseData = { Category: document.getElementById('add-expense-category').value.trim(), Amount: document.getElementById('add-expense-amount').value.trim(), Description: document.getElementById('add-expense-description').value.trim() }; if(!expenseData.Category || !expenseData.Amount || !expenseData.Description) return showMessage(msgEl, "Category, Amount, and Description are required.", "error"); const result = await callBackendApi('addExpense', {expenseData}); if(result?.success){showMessage(msgEl, result.message, 'success'); form.reset();} else {showMessage(msgEl, result?.error || "Failed to add expense.", "error");}});
    
    function prepareAddStudentForm(){ D.addStudentForm.reset(); populateClassDropdowns(); }
    async function prepareAssignTeacherForm() { D.assignTeacherForm.reset(); await Promise.all([loadStudentsAndClasses(false), loadStaffList(false)]); populateClassDropdowns(); const staffSelect = D.assignTeacherStaffSelect; staffSelect.innerHTML = '<option value="" disabled selected>-- Select Teacher --</option>'; staffListData.forEach(staff => { if (String(staff.IsActive).toLowerCase() === 'true') { const opt = document.createElement('option'); opt.value = staff.StaffID; opt.textContent = staff.Name; staffSelect.appendChild(opt); } }); }
    async function loadSubjects(showMsg=false) { if(!schoolSpreadsheetId) return; const result = await callBackendApi('getSheetDataAsJson', { sheetName: 'Subjects' }); if(result?.success && result.data) cachedSubjects = result.data; }

    async function openStudentDetailsModal(studentId) {
        D.studentDetailsModalBody.innerHTML = '<p class="message info">Loading student details...</p>'; openModal('studentDetailsModal');
        const result = await callBackendApi('getStudentFullDetails', { studentId });
        if (result?.success && result.data) {
            const S = result.data; 
            D.studentDetailsModalTitle.innerHTML = `<i class="fas fa-user-check"></i> Profile: ${sanitizeHTML(S.Name || 'Student')}`;
            let feeDetailsHtml = '<h4><i class="fas fa-coins"></i> Fee Records</h4>';
            if (S.fees) {
                feeDetailsHtml += `<div class="fees-summary">Total Due: <strong>${formatCurrency(S.fees.totalDue)}</strong> | Total Paid: <strong>${formatCurrency(S.fees.totalPaid)}</strong></div><div class="details-list">`;
                if (S.fees.due?.length > 0) { S.fees.due.forEach(f => { feeDetailsHtml += `<div class="list-item" data-fee-record-id="${sanitizeHTML(f.FeeRecordID)}"><span>${sanitizeHTML(f.FeeTypeName||f.FeeTypeID)} (${formatDisplayDate(f.DueDate)}): <strong class="amount">${formatCurrency(f.Amount)}</strong> - <span class="status-due">${sanitizeHTML(f.Status)}</span></span><button class="mark-paid-btn" data-student-id="${sanitizeHTML(S.StudentID)}"><i class="fas fa-check-circle"></i> Mark Paid</button></div>`; }); } else { feeDetailsHtml += '<p style="text-align:center;color:var(--text-light-color);margin-top:10px;">No outstanding due fees.</p>'; }
                feeDetailsHtml += '</div><h5 style="margin-top:15px; font-size:1rem; color:var(--text-light-color);">Paid History:</h5><div class="details-list">';
                if (S.fees.paid?.length > 0) { S.fees.paid.forEach(f => { feeDetailsHtml += `<div class="list-item"><span>${sanitizeHTML(f.FeeTypeName||f.FeeTypeID)} (${formatDisplayDate(f.PaidDate)}): <strong class="amount status-paid">${formatCurrency(f.Amount)}</strong></span></div>`; }); } else { feeDetailsHtml += '<p style="text-align:center;color:var(--text-light-color);margin-top:10px;">No paid fee records.</p>'; } feeDetailsHtml += '</div>';
                if (Object.keys(S.fees.byMonth || {}).length > 0) { feeDetailsHtml += '<h5 style="margin-top:15px; font-size:1rem; color:var(--text-light-color);">Fees Paid (Monthly):</h5><div class="details-list">'; for (const month in S.fees.byMonth) { feeDetailsHtml += `<div class="list-item"><span>${sanitizeHTML(month)}: <strong>${formatCurrency(S.fees.byMonth[month])}</strong></span></div>`; } feeDetailsHtml += '</div>'; }
            } else { feeDetailsHtml += '<p>Fee data not available.</p>'; }
            let attendanceDetailsHtml = '<h4><i class="fas fa-user-clock"></i> Attendance</h4>';
            if (S.attendance) {
                attendanceDetailsHtml += `<div class="attendance-summary">Present: <strong>${S.attendance.totalPresent}</strong> | Absent: <strong>${S.attendance.totalAbsent}</strong> (of ${S.attendance.totalSchoolDaysForStudent} days)</div><div class="details-list">`;
                if (Object.keys(S.attendance.byMonth || {}).length > 0) { for (const month in S.attendance.byMonth) { const monthData = S.attendance.byMonth[month]; const percentage = monthData.schoolDays > 0 ? ((monthData.present / monthData.schoolDays) * 100).toFixed(1) : 0; attendanceDetailsHtml += `<div class="list-item"><span>${sanitizeHTML(month)}: ${monthData.present}P, ${monthData.absent}A (${percentage}%)</span></div>`; } }
                else if(S.attendance.records?.length > 0) { S.attendance.records.slice(-10).reverse().forEach(att => { attendanceDetailsHtml += `<div class="list-item"><span>${formatDisplayDate(att.Date)}: <strong>${sanitizeHTML(att.Status)}</strong></span></div>`; }); } else { attendanceDetailsHtml += '<p style="text-align:center;color:var(--text-light-color);margin-top:10px;">No attendance records found.</p>'; }
                attendanceDetailsHtml += '</div>';
            } else { attendanceDetailsHtml += '<p>Attendance data not available.</p>'; }
            D.studentDetailsModalBody.innerHTML = `<div class="profile-grid"><div class="profile-sidebar"><div class="profile-photo-container">${getStudentPhotoHtml(S.PhotoURL, 'profile-photo')}</div><h3 class="profile-name">${sanitizeHTML(S.Name)}</h3><p class="profile-meta"><i class="fas fa-id-badge"></i> ID: ${sanitizeHTML(S.StudentID)}</p><p class="profile-meta"><i class="fas fa-chalkboard"></i> Class: ${sanitizeHTML(S.ClassNameWithSection || S.Class)}</p><p class="profile-meta"><i class="fas fa-list-ol"></i> Roll: ${sanitizeHTML(S.RollNumber || 'N/A')}</p><p class="profile-meta"><i class="fas fa-venus-mars"></i> Gender: ${sanitizeHTML(S.Gender || 'N/A')}</p><p class="profile-meta"><i class="fas fa-calendar-alt"></i> Reg. Date: ${formatDisplayDate(S.RegistrationDate)}</p></div><div class="profile-main-content"><div class="details-section"><h4><i class="fas fa-user-friends"></i> Family & Contact</h4><div class="info-grid"><p><strong>Father:</strong> ${sanitizeHTML(S.FatherName)}</p><p><strong>Mother:</strong> ${sanitizeHTML(S.MotherName)}</p><p><strong>Mobile:</strong> ${sanitizeHTML(S.Mobile)}</p><p><strong>Gmail:</strong> ${sanitizeHTML(S.Gmail)}</p><p><strong>Address:</strong> ${sanitizeHTML(S.Address)}</p><p><strong>Aadhar:</strong> ${sanitizeHTML(S.Aadhar)}</p></div></div><div class="details-section fees-section">${feeDetailsHtml}</div><div class="details-section attendance-section">${attendanceDetailsHtml}</div></div></div>`;
        } else { D.studentDetailsModalBody.innerHTML = `<p class="message error">${result?.error || 'Failed to load details.'}</p>`; }
    }
    D.studentDetailsModalBody.addEventListener('click', async (e) => { if (e.target.classList.contains('mark-paid-btn') || e.target.closest('.mark-paid-btn')) { const button = e.target.closest('.mark-paid-btn'); const feeRecordId = button.closest('.list-item').dataset.feeRecordId; const studentId = button.dataset.studentId; if (!feeRecordId || !studentId) { const feeMsgContainer = D.studentDetailsModalBody.querySelector('.fees-section'); const tempMsg = document.createElement('div'); if (feeMsgContainer) feeMsgContainer.prepend(tempMsg); showMessage(tempMsg || D.studentDetailsModalBody, "Error: Fee Record ID missing.", "error", false); return; } const paidDate = prompt("Enter Paid Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]); if (paidDate) { try { new Date(paidDate).toISOString(); } catch { alert("Invalid date format!"); return; } const result = await callBackendApi('updateStudentFeeStatus', { feeRecordId, newStatus: 'Paid', paidDate }); if (result?.success) { const feeMsgContainer = D.studentDetailsModalBody.querySelector('.fees-section'); const tempMsg = document.createElement('div'); if (feeMsgContainer) feeMsgContainer.prepend(tempMsg); showMessage(tempMsg, result.message || 'Fee status updated.', 'success', true); openStudentDetailsModal(studentId); } else { const feeMsgContainer = D.studentDetailsModalBody.querySelector('.fees-section'); const tempMsg = document.createElement('div'); if (feeMsgContainer) feeMsgContainer.prepend(tempMsg); showMessage(tempMsg, result?.error || 'Failed to update.', 'error', false); } } } });

    function resetAddResultsForm(){D.resultNameInput.value="",D.schoolNameInput.value="",D.teacherNameInput.value="",D.resultClassSelect.value="",D.subjectsContainer.innerHTML='<label style="font-weight: 500; color: var(--text-color); font-size: 0.95rem; margin-bottom: 10px; display: block;">Subjects:</label><div class="subject-entry"><input type="text" class="subject-name" placeholder="Subject Name"><input type="number" class="total-marks marks-input" placeholder="Total" min="1" value="100"><input type="number" class="pass-marks marks-input" placeholder="Pass" min="0" value="30"><button type="button" class="remove-subject-btn" onclick="removeSubject(this)" style="visibility:hidden;"><i class="fas fa-times-circle"></i></button></div>',D.resultsStudentList.innerHTML="",D.marksEntryForm.innerHTML="",currentResultConfig=null,currentStudentForResult=null,studentsWithResults.clear(),hideMessage(D.addResultsMessage),hideMessage(D.marksEntryMessage),showStep(1)}
    function showStep(e){D.step1ResultDetails.style.display=1===e?"block":"none",D.step2SelectStudent.style.display=2===e?"block":"none",D.step3EnterMarks.style.display=3===e?"block":"none",3!==e&&(currentStudentForResult=null),2===e&&D.resultsStudentList.querySelectorAll(".selected").forEach((e=>e.classList.remove("selected"))),1===e&&D.addResultsView.classList.contains("active")&&resetAddResultsForm()}
    D.addSubjectBtn.addEventListener("click",()=>{const e=document.createElement("div");e.className="subject-entry",e.innerHTML='<input type="text" class="subject-name" placeholder="Subject Name"><input type="number" class="total-marks marks-input" placeholder="Total" min="1" value="100"><input type="number" class="pass-marks marks-input" placeholder="Pass" min="0" value="30"><button type="button" class="remove-subject-btn" onclick="removeSubject(this)"><i class="fas fa-times-circle"></i></button>';const t=D.subjectsContainer.querySelector(".remove-subject-btn");t&&(t.style.visibility="visible"),D.subjectsContainer.appendChild(e),e.querySelector(".subject-name").focus()});function removeSubject(e){const t=D.subjectsContainer,o=t.querySelectorAll(".subject-entry");if(o.length>1){e.closest(".subject-entry").remove();const a=t.querySelector(".remove-subject-btn");1===t.querySelectorAll(".subject-entry").length&&a&&(a.style.visibility="hidden")}else showMessage(D.addResultsMessage,"Must have at least one subject.","warning")}
    D.nextToStep2Btn.addEventListener("click",(()=>{hideMessage(D.addResultsMessage);const e=D.resultNameInput.value.trim(),t=D.schoolNameInput.value.trim(),o=D.teacherNameInput.value.trim(),a=D.resultClassSelect.value,s=[],i=!0;let n=null;D.subjectsContainer.querySelectorAll(".subject-entry").forEach((e=>{const t=e.querySelector(".subject-name"),o=e.querySelector(".total-marks"),a=e.querySelector(".pass-marks"),r=t.value.trim(),d=o.value.trim(),l=a.value.trim();let c=!0;[t,o,a].forEach((e=>e.classList.remove("invalid"))),r||(c=!1,t.classList.add("invalid"),n||(n=t)),d&&!isNaN(d)&&Number(d)>0||(c=!1,o.classList.add("invalid"),n||(n=o)),l&&!isNaN(l)&&Number(l)>=0&&Number(l)<=Number(d)||(c=!1,a.classList.add("invalid"),n||(n=a)),c?s.push({name:r,total:Number(d),pass:Number(l)}):i=!1}));let r="";e||(r+="Result Name required. "),a||(r+="Class required. "),0!==s.length&&i||(r+="Valid subject(s) required. ");if(r)return showMessage(D.addResultsMessage,r.trim(),"error"),void(n&&n.focus());const d=classMapping[a]?.displayName||a;currentResultConfig={resultName:e,schoolName:t,teacherName:o,className:a,classDisplayName:d,subjects:s},studentsWithResults.clear(),D.selectedClassInfo.textContent=d,loadStudentsForResultsList(a),showStep(2)}));
    function loadStudentsForResultsList(e){D.resultsStudentList.innerHTML='<p class="message info">Loading students...</p>';const t=studentsData.filter((t=>String(t.Class||"").trim()===e));if(0===t.length)return void(D.resultsStudentList.innerHTML='<p class="message warning">No students found for this class.</p>');D.resultsStudentList.innerHTML="";const o=document.createDocumentFragment();t.sort(((e,t)=>(e.RollNumber||"").localeCompare(t.RollNumber||"",void 0,{numeric:!0})||(e.Name||"").localeCompare(t.Name||""))).forEach((e=>{const t=document.createElement("div");t.className="student-result-item",t.dataset.studentId=e.StudentID,t.innerHTML=`${getStudentPhotoHtml(e.PhotoURL)}<div class="student-result-info"><span><strong>${sanitizeHTML(e.Name||"N/A")}</strong></span><span>Roll: ${sanitizeHTML(e.RollNumber||"N/A")}</span></div><i class="fas fa-check-circle result-saved-indicator"></i>`,t.addEventListener("click",(()=>selectStudentForMarks(t,e))),o.appendChild(t)})),D.resultsStudentList.appendChild(o)}
    function selectStudentForMarks(e,t){const o=D.resultsStudentList.querySelector(".selected");o&&o.classList.remove("selected"),e.classList.add("selected"),hideMessage(D.marksEntryMessage),currentStudentForResult=t,currentStudentForResult?(D.selectedStudentInfo.textContent=`${sanitizeHTML(t.Name||"N/A")} (Roll: ${sanitizeHTML(t.RollNumber||"N/A")})`,generateMarksEntryForm(),showStep(3),D.marksEntryContainer.scrollIntoView({behavior:"smooth",block:"nearest"})):console.error("Student invalid:",t)}
    function generateMarksEntryForm(){if(D.marksEntryForm.innerHTML="",!currentResultConfig?.subjects?.length)return void(D.marksEntryForm.innerHTML='<p class="message error">No subjects defined.</p>');if(!currentStudentForResult)return void(D.marksEntryForm.innerHTML='<p class="message error">No student selected.</p>');const e=document.createDocumentFragment();currentResultConfig.subjects.forEach((t=>{const o=document.createElement("div");o.className="marks-input-group";const a=`marks-${currentResultConfig.className}-${currentStudentForResult.StudentID}-${t.name.replace(/\s+/g,"-")}`;o.innerHTML=`<label for="${a}">${sanitizeHTML(t.name)} <span class="max-marks">(Max: ${t.total})</span>:</label><input type="number" id="${a}" class="marks-input" data-subject-name="${sanitizeHTML(t.name)}" max="${t.total}" min="0" required>`,e.appendChild(o)})),D.marksEntryForm.appendChild(e);const t=D.marksEntryForm.querySelector(".marks-input");t&&t.focus()}
    D.backToStep1Btn.addEventListener("click",(()=>showStep(1))),D.backToStep2Btn.addEventListener("click",(()=>showStep(2))),D.submitMarksBtn.addEventListener("click",async()=>{if(hideMessage(D.marksEntryMessage),!currentStudentForResult||!schoolSpreadsheetId||!currentResultConfig)return void showMessage(D.marksEntryMessage,"Error: Invalid state. Cannot save.","error");const e={};let t=!0,o=null;if(currentResultConfig.subjects.forEach((s=>{const i=document.getElementById(`marks-${currentResultConfig.className}-${currentStudentForResult.StudentID}-${s.name.replace(/\s+/g,"-")}`);if(!i)return console.error(`Input missing: ${i}`),void(t=!1);const n=i.value.trim(),r=parseFloat(i.max),d=parseFloat(i.min);i.classList.remove("invalid"),""===n||isNaN(n)||parseFloat(n)<d||parseFloat(n)>r?(t=!1,i.classList.add("invalid"),o||(o=i)):e[s.name]=parseFloat(n)})),!t)return showMessage(D.marksEntryMessage,"One or more marks are invalid or empty.","error"),void(o&&o.focus());const a={resultName:currentResultConfig.resultName,className:currentResultConfig.className,schoolName:currentResultConfig.schoolName,teacherName:currentResultConfig.teacherName,subjects:JSON.stringify(currentResultConfig.subjects),studentId:currentStudentForResult.StudentID,marks:JSON.stringify(e)},s=await callBackendApi("saveResult",a);if(s?.success){showMessage(D.marksEntryMessage,s.message||"Marks saved successfully!","success");const i=D.resultsStudentList.querySelector(`.student-result-item[data-student-id="${currentStudentForResult.StudentID}"]`);i&&i.classList.add("has-result"),studentsWithResults.add(currentStudentForResult.StudentID),setTimeout((()=>showStep(2)),1500)}else showMessage(D.marksEntryMessage,s?.error||"Failed to save marks.","error")});

    async function loadGenericSheetData(sheetName){if(!schoolSpreadsheetId||!sheetName)return;currentGenericSheetName=sheetName,D.downloadSheetJsonBtn.style.display="none",showMessage(D.genericSheetMessage,`Loading "${sanitizeHTML(sheetName)}"...`,"info"),D.genericTableHeaderRow.innerHTML="",D.genericTableBody.innerHTML='<tr><td colspan="1" style="text-align:center;padding:30px;color:var(--text-light-color);">Loading...</td></tr>',currentGenericHeaders=[],currentGenericData=[],D.genericViewTitle.innerHTML=`<i class="far fa-file-excel"></i> ${sanitizeHTML(sheetName)}`;const result=await callBackendApi("getSheetData",{sheetName});if(result?.success&&result.data){hideMessage(D.genericSheetMessage),currentGenericHeaders=result.data.headers||[],currentGenericData=result.data.rows||[];const headFrag=document.createDocumentFragment();currentGenericHeaders.forEach((h=>{const th=document.createElement("th");th.textContent=sanitizeHTML(h),headFrag.appendChild(th)})),currentGenericData.length>0&&((()=>{const e=document.createElement("th");e.textContent="Actions",e.style.textAlign="center",headFrag.appendChild(e)})(),D.downloadSheetJsonBtn.style.display="inline-flex"),D.genericTableHeaderRow.appendChild(headFrag),D.genericTableBody.innerHTML="",0===currentGenericData.length?D.genericTableBody.innerHTML=`<tr><td colspan="${currentGenericHeaders.length||1}" style="text-align:center;padding:30px;color:var(--text-light-color);">Sheet is empty.</td></tr>`:(e=>{const t=document.createDocumentFragment();e.forEach((e=>{const o=document.createElement("tr");e.values.forEach((e=>{const t=document.createElement("td");t.textContent=sanitizeHTML(e),o.appendChild(t)}));const a=document.createElement("td");a.className="action-col",a.innerHTML=`<i class="fas fa-edit edit-btn-generic" title="Edit Row" data-sheet-name="${sanitizeHTML(sheetName)}" data-row-index="${e.rowIndex}"></i> <i class="fas fa-trash-alt delete-btn generic-delete-btn" title="Delete Row" data-sheet-name="${sanitizeHTML(sheetName)}" data-row-index="${e.rowIndex}"></i>`,o.appendChild(a),t.appendChild(o)})),D.genericTableBody.appendChild(t)})(currentGenericData)}else showMessage(D.genericSheetMessage,result?.error||`Failed to load "${sanitizeHTML(sheetName)}".`,"error"),D.genericTableHeaderRow.innerHTML="",D.genericTableBody.innerHTML='<tr><td colspan="1" style="text-align:center;padding:30px;color:var(--error-color);">Error loading data.</td></tr>';updatePdfButtonVisibility(currentView)}
    D.genericTableBody.addEventListener("click",(e=>{if(e.target?.classList.contains("edit-btn-generic")){const t=e.target.dataset.sheetName,o=e.target.dataset.rowIndex;t&&o&&openGenericEditModal(t,parseInt(o))}if(e.target?.classList.contains("generic-delete-btn")){const a=e.target.dataset.sheetName,s=e.target.dataset.rowIndex;a&&s&&handleGenericDeleteRow(a,parseInt(s))}}));
    function openGenericEditModal(sheetName,rowIndex){hideMessage(D.genericEditMessage),D.genericEditForm.reset(),D.genericEditFormFields.innerHTML="<p>Loading...</p>";const rowData=currentGenericData.find((i=>i.rowIndex===rowIndex));if(!rowData||!currentGenericHeaders||0===currentGenericHeaders.length)return console.error("Data/Headers missing",{sheetName,rowIndex}),void showMessage(D.genericSheetMessage,"Error: Headers missing or data not found.","error");D.genericEditModalTitle.innerHTML=`<i class="fas fa-edit"></i> Edit Row ${rowIndex} in "${sanitizeHTML(sheetName)}"`,D.genericEditSheetNameInput.value=sheetName,D.genericEditRowIndexInput.value=rowIndex;const frag=document.createDocumentFragment();currentGenericHeaders.forEach(((h,idx)=>{const v=rowData.values[idx]??"",ig=document.createElement("div");ig.className="input-group";const lbl=document.createElement("label"),id=`gen-edit-${h.replace(/[^a-zA-Z0-9]/g,"-")}-${rowIndex}`;lbl.htmlFor=id,lbl.textContent=sanitizeHTML(h)+":";let inp;String(v).length>100||String(v).includes("\n")?(inp=document.createElement("textarea")):(inp=document.createElement("input"),inp.type="text"),inp.id=id,inp.name=h,inp.value=v,ig.appendChild(lbl),ig.appendChild(inp),frag.appendChild(ig)})),D.genericEditFormFields.innerHTML="",D.genericEditFormFields.appendChild(frag),openModal("genericEditModal")}
    D.saveGenericChangesBtn.addEventListener("click",async()=>{hideMessage(D.genericEditMessage);const sheetName=D.genericEditSheetNameInput.value,rowIndex=D.genericEditRowIndexInput.value;if(!sheetName||!rowIndex)return void showMessage(D.genericEditMessage,"Error: Sheet/Row ID missing.","error");const formD=new FormData(D.genericEditForm),data={};currentGenericHeaders.forEach((h=>{formD.has(h)&&(data[h]=formD.get(h))}));const result=await callBackendApi("updateSheetRow",{sheetName,rowIndex:parseInt(rowIndex),rowData:data});result?.success?(showMessage(D.genericEditMessage,result.message||"Row updated!","success"),loadGenericSheetData(sheetName),setTimeout((()=>closeModal("genericEditModal")),1500)):showMessage(D.genericEditMessage,result?.error||"Update failed.","error")});
    async function handleGenericDeleteRow(sheetName,rowIndex){if(!confirm(`Delete row ${rowIndex} from sheet "${sheetName}"? This is permanent.`))return;const result=await callBackendApi("deleteSheetRow",{sheetName,rowIndex});result?.success? (showMessage(D.genericSheetMessage,result.message||"Row deleted.","success"),loadGenericSheetData(sheetName)):showMessage(D.genericSheetMessage,result?.error||"Failed to delete row.","error")}
    D.downloadSheetJsonBtn.addEventListener("click",async()=>{if(!currentGenericSheetName)return void showMessage(D.genericSheetMessage,"No sheet selected.","warning");const result=await callBackendApi("getSheetDataAsJson",{sheetName:currentGenericSheetName});if(result?.success&&result.data){const jsonStr=JSON.stringify(result.data,null,2),blob=new Blob([jsonStr],{type:"application/json"}),url=URL.createObjectURL(blob),a=document.createElement("a");a.href=url,a.download=`${currentGenericSheetName.replace(/ /g,"_")}_export.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(url),showMessage(D.genericSheetMessage,"JSON downloaded.","success")}else showMessage(D.genericSheetMessage,result?.error||"Failed to download JSON.","error")});
    
    async function loadTools(){if(cachedTools.length>0)return void populateToolsView();showMessage(D.toolsMessage,"Loading tools...","info"),D.toolsViewContent.innerHTML="";try{const e=await fetch("./tools.json");if(!e.ok)throw new Error(`HTTP error ${e.status}`);cachedTools=await e.json(),populateToolsView()}catch(t){console.error("Error loading tools.json:",t),showMessage(D.toolsMessage,`Failed to load tools: ${t.message}`,"error"),D.toolsViewContent.innerHTML='<p class="message error">Could not load tools.json.</p>',cachedTools=[]}}
    function populateToolsView(){hideMessage(D.toolsMessage),D.toolsViewContent.innerHTML="",cachedTools&&cachedTools.length>0?cachedTools.forEach((e=>{const t=document.createElement("div");t.className="tool-card",t.innerHTML=`<img src="${sanitizeHTML(e.imageUrl||"https://via.placeholder.com/80x80/f0f4f8/90a4ae?text=Tool")}" alt="${sanitizeHTML(e.name)}"><h4>${sanitizeHTML(e.name)}</h4><p>${sanitizeHTML(e.description||"Click to open tool")}</p>`,t.addEventListener("click",(()=>openFullscreenIframe(e.name,e.url))),D.toolsViewContent.appendChild(t)})):D.toolsViewContent.innerHTML='<p class="message warning">No tools configured in tools.json.</p>'}
    function openFullscreenIframe(e,t){D.fullscreenIframeTitle.textContent=sanitizeHTML(e),D.fullscreenIframeEl.src=t,D.fullscreenIframeContainer.style.display="flex",document.body.style.overflow="hidden"}
    D.closeFullscreenIframeBtn.addEventListener("click",()=>{D.fullscreenIframeContainer.style.display="none",D.fullscreenIframeEl.src="about:blank",D.fullscreenIframeTitle.textContent="Tool",document.body.style.overflow=""});

    async function loadFeeTypes(e=!0){if(!schoolSpreadsheetId)return;if(feeTypes.length>0&&!e)return;e&&showMessage(D.addFeesMessage,"Loading fee types...","info");const t=await callBackendApi("getSheetDataAsJson",{sheetName:"FeeTypes"});t?.success&&t.data?(e&&hideMessage(D.addFeesMessage),feeTypes=t.data,populateFeeTypeDropdown()):(e&&showMessage(D.addFeesMessage,t?.error||"Failed to load fee types.","error"),console.error("Failed to load fee types",t?.error))}
    function populateFeeTypeDropdown(){D.feeTypeSelect.innerHTML='<option value="" disabled selected>-- Select Fee Type --</option>',feeTypes&&feeTypes.length>0&&feeTypes.forEach((e=>{const t=document.createElement("option");t.value=e.FeeTypeID,t.textContent=`${sanitizeHTML(e.FeeTypeName)} (${formatCurrency(e.DefaultAmount||0)})`,t.dataset.defaultAmount=e.DefaultAmount||"",D.feeTypeSelect.appendChild(t)}))}
    D.feeTypeSelect.addEventListener("change",e=>{const t=e.target.selectedOptions[0];t&&t.dataset.defaultAmount?(D.feeAmountInput.placeholder=`Default: ${formatCurrency(t.dataset.defaultAmount)}`,D.feeAmountInput.value||(D.feeAmountInput.value=t.dataset.defaultAmount)):D.feeAmountInput.placeholder="Enter Amount"});
    async function prepareAddFeesForm(){Object.keys(classMapping).length===0&&await loadStudentsAndClasses(!1),0===feeTypes.length&&await loadFeeTypes(!1),D.feeClassSelect.options.length<=1&&Object.keys(classMapping).length>0&&populateClassDropdowns(),D.feeMonthYearInput.value=getCurrentMonthYear(),D.feeAcademicYearInput.value=getCurrentAcademicYear();const e=new Date;D.feeDueDateInput.value=(new Date(e.getFullYear(),e.getMonth()+1,0)).toISOString().split("T")[0],D.feeAmountInput.value="",D.feeAmountInput.placeholder="Default from Fee Type",D.feeTypeSelect.options.length<=1&&feeTypes.length>0&&populateFeeTypeDropdown()}
    D.addFeesForm.addEventListener("submit",async e=>{e.preventDefault(),hideMessage(D.addFeesMessage);const t={classId:D.feeClassSelect.value,feeTypeId:D.feeTypeSelect.value,monthYear:D.feeMonthYearInput.value.trim(),dueDate:D.feeDueDateInput.value,academicYear:D.feeAcademicYearInput.value.trim()||void 0,amount:D.feeAmountInput.value.trim()||void 0};if(!t.classId||!t.feeTypeId||!t.monthYear||!t.dueDate)return void showMessage(D.addFeesMessage,"Class, Fee Type, Month/Year, and Due Date are required.","error");const o=await callBackendApi("addBulkFees",t);o?.success?(showMessage(D.addFeesMessage,o.message||"Fees added!","success"),D.addFeesForm.reset(),prepareAddFeesForm()):showMessage(D.addFeesMessage,o?.error||"Failed to add fees.","error")});

    async function loadStaffList(e=!0){if(e&&(showMessage(D.staffListMessage,"Loading staff...","info"),D.staffTableBody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-light-color);">Loading...</td></tr>'),staffListData.length>0&&!e)return;const t=await callBackendApi("getStaffList");if(t?.success&&t.data){e&&hideMessage(D.staffListMessage),staffListData=t.data;const o=document.createDocumentFragment();0===staffListData.length?o.innerHTML='<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-light-color);">No staff members found.</td></tr>':staffListData.forEach((e=>{const t=document.createElement("tr");t.innerHTML=`<td>${getStudentPhotoHtml(e.PhotoURL,"student-photo","fa-user-tie")}</td><td>${sanitizeHTML(e.Name||"N/A")}</td><td>${sanitizeHTML(e.Mobile||"N/A")}</td><td>${sanitizeHTML(e.Role||e.Designation||"N/A")}</td> <td><span style="color:${"true"===String(e.IsActive).toLowerCase()?"var(--success-color)":"var(--error-color)"}; font-weight:bold;">${"true"===String(e.IsActive).toLowerCase()?"Active":"Inactive"}</span></td><td class="action-col"><i class="fas fa-eye view-btn" title="View Staff Details" data-staffid="${sanitizeHTML(e.StaffID)}"></i></td>`,o.appendChild(t)})),D.staffTableBody.innerHTML="",D.staffTableBody.appendChild(o)}else e&&showMessage(D.staffListMessage,t?.error||"Failed to load staff.","error"),D.staffTableBody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--error-color);">Error loading staff data.</td></tr>'}
    D.staffTableBody.addEventListener("click",e=>{if(e.target?.classList.contains("view-btn")){const t=e.target.dataset.staffid;t&&openStaffDetailsModal(t)}});
    async function openStaffDetailsModal(staffId){D.staffDetailsModalBody.innerHTML='<p class="message info">Loading staff details...</p>',D.addSalaryPaymentBtnModal.style.display="none",hideMessage(D.addSalaryMessage),openModal("staffDetailsModal");const result=await callBackendApi("getStaffDetails",{staffId});if(result?.success&&result.data){const S=result.data;D.staffDetailsModalTitle.innerHTML=`<i class="fas fa-user-tie"></i> Profile: ${sanitizeHTML(S.Name||"Staff Member")}`;let paymentsHtml='<h4><i class="fas fa-money-check-alt"></i> Salary Payments</h4>';S.payments&&S.payments.records?.length>0?(paymentsHtml+=`<div class="fees-summary">Total Paid to Date: <strong>${formatCurrency(S.payments.totalPaid)}</strong></div><div class="details-list">`,S.payments.records.slice(-10).reverse().forEach((p=>{paymentsHtml+=`<div class="list-item"><span>${formatDisplayDate(p.PaymentDate)} for ${sanitizeHTML(p.MonthYear)}: <strong class="amount status-paid">${formatCurrency(p.Amount)}</strong></span></div>`})),paymentsHtml+="</div>"):paymentsHtml+='<p style="text-align:center; color:var(--text-light-color); margin-top:10px;">No payment records found.</p>',paymentsHtml+=`<hr style="margin: 25px 0 15px;"><h4><i class="fas fa-hand-holding-usd"></i> Add New Salary Payment</h4>\n                <form id="add-salary-form-modal" class="form-grid" data-staff-id="${sanitizeHTML(S.StaffID)}">\n                    <div class="input-group"><label for="modal-salary-payment-date">Payment Date:</label><input type="date" id="modal-salary-payment-date" required></div>\n                    <div class="input-group"><label for="modal-salary-amount">Amount:</label><input type="number" id="modal-salary-amount" min="0.01" step="0.01" required placeholder="e.g., 25000"></div>\n                    <div class="input-group"><label for="modal-salary-monthyear">For Month/Year:</label><input type="text" id="modal-salary-monthyear" placeholder="MMMM YYYY" required></div>\n                    <div class="input-group" style="grid-column: 1 / -1;"><label for="modal-salary-notes">Notes (Optional):</label><textarea id="modal-salary-notes" rows="2"></textarea></div>\n                </form>`,D.addSalaryPaymentBtnModal.style.display="inline-flex",D.staffDetailsModalBody.innerHTML=`\n                <div class="profile-grid">\n                    <div class="profile-sidebar">\n                         <div class="profile-photo-container">${getStudentPhotoHtml(S.PhotoURL,"profile-photo","fa-user-tie")}</div>\n                         <h3 class="profile-name">${sanitizeHTML(S.Name)}</h3>\n                         <p class="profile-meta"><i class="fas fa-id-badge"></i> ID: ${sanitizeHTML(S.StaffID)}</p>\n                         <p class="profile-meta"><i class="fas fa-briefcase"></i> Role: ${sanitizeHTML(S.Role||S.Designation||"N/A")}</p>\n                         <p class="profile-meta"><i class="fas fa-dollar-sign"></i> Salary: ${formatCurrency(S.SalaryAmount)}</p>\n                         <p class="profile-meta"><i class="fas fa-calendar-check"></i> Joined: ${formatDisplayDate(S.JoiningDate)}</p>\n                         <p class="profile-meta"><i class="fas fa-toggle-${"true"===String(S.IsActive).toLowerCase()?"on":"off"}"></i> Status: <span style="font-weight:bold; color: ${S.IsActive?"var(--success-color)":"var(--error-color)"};">${S.IsActive?"Active":"Inactive"}</span></p>\n                    </div>\n                    <div class="profile-main-content">\n                        <div class="details-section">\n                            <h4><i class="fas fa-address-book"></i> Contact Information</h4>\n                            <div class="info-grid">\n                                <p><strong>Mobile:</strong> ${sanitizeHTML(S.Mobile)}</p>\n                                <p><strong>Gmail:</strong> ${sanitizeHTML(S.Gmail)}</p>\n                            </div>\n                        </div>\n                        <div class="details-section"> \n                            <h4><i class="fas fa-file-invoice-dollar"></i> Financial Overview</h4>\n                            <div class="info-grid">\n                                 <p><strong>Base Salary:</strong> ${formatCurrency(S.SalaryAmount)}</p>\n                                 <p><strong>Total Paid:</strong> ${formatCurrency(S.TotalPaid)}</p>\n                                 <p><strong>Total Dues:</strong> ${formatCurrency(S.TotalDues)}</p>\n                            </div>\n                        </div>\n                        <div class="details-section payments-section">${paymentsHtml}</div>\n                    </div>\n                </div>`,document.getElementById("modal-salary-payment-date").valueAsDate=new Date,document.getElementById("modal-salary-monthyear").value=getCurrentMonthYear()}else D.staffDetailsModalBody.innerHTML=`<p class="message error">${result?.error||"Failed to load staff details."}</p>`}
    D.addSalaryPaymentBtnModal.addEventListener("click",async()=>{hideMessage(D.addSalaryMessage);const e=document.getElementById("add-salary-form-modal");if(!e)return;const t=e.dataset.staffId,o={staffId:t,paymentDate:document.getElementById("modal-salary-payment-date").value,amount:document.getElementById("modal-salary-amount").value,monthYear:document.getElementById("modal-salary-monthyear").value.trim(),notes:document.getElementById("modal-salary-notes").value.trim()};if(!o.staffId||!o.paymentDate||!o.amount||!o.monthYear)return void showMessage(D.addSalaryMessage,"Date, Amount, and Month/Year required.","error");if(parseFloat(o.amount)<=0)return void showMessage(D.addSalaryMessage,"Amount must be > 0.","error");const a=await callBackendApi("addStaffSalaryPayment",o);a?.success?(showMessage(D.addSalaryMessage,a.message||"Payment added!","success"),openStaffDetailsModal(t),loadStaffList()):showMessage(D.addSalaryMessage,a?.error||"Failed to add payment.","error")});

    async function loadDashboardData(){showMessage(D.dashboardMessage,"Loading dashboard data...","info");const e=await callBackendApi("getDashboardOverview");if(e?.success&&e.data){hideMessage(D.dashboardMessage);const t=e.data;D.dbTotalStudents.textContent=t.totalStudents??="-",D.dbTotalStaff.textContent=t.totalStaff??="-",D.dbTotalClasses.textContent=t.totalClasses??="-",D.dbTotalGirls.textContent=t.totalGirls??="-",D.dbTotalBoys.textContent=t.totalBoys??="-",D.dbTotalPaid.textContent=formatCurrency(t.totalPaidMoney)??="-",D.dbTotalDue.textContent=formatCurrency(t.totalDuesMoney)??="-",D.dbTotalExpenses.textContent=formatCurrency(t.totalExpenses)??="-",Object.values(dashboardCharts).forEach((e=>e?.destroy())),dashboardCharts={},t.studentsPerClass&&renderBarChart("studentsPerClassChart",D.studentsPerClassChartEl,"Students per Class",t.studentsPerClass),t.genderSplitPerClass&&renderGroupedBarChart("genderSplitPerClassChart",D.genderSplitPerClassChartEl,"Gender Split per Class",t.genderSplitPerClass),t.feesCollectedPerClassThisMonth&&renderBarChart("feesCollectedPerClassChart",D.feesCollectedPerClassChartEl,`Fees Collected (${getCurrentMonthYear()})`,t.feesCollectedPerClassThisMonth,!0),t.duesPerClass&&renderBarChart("duesPerClassChart",D.duesPerClassChartEl,"Total Dues per Class",t.duesPerClass,!0),t.attendancePerClass&&renderBarChart("attendancePerClassChart",D.attendancePerClassChartEl,"Avg Attendance % (Last 30 Days)",t.attendancePerClass,!1,!0)}else showMessage(D.dashboardMessage,e?.error||"Failed to load dashboard.","error")}
    function renderBarChart(e,t,o,a,s=!1,i=!1){if(!t)return;const n=t.getContext("2d"),r=Object.keys(a),d=Object.values(a).map((e=>i&&"object"==typeof e?e.averageAttendancePercent:e));dashboardCharts[e]=new Chart(n,{type:"bar",data:{labels:r,datasets:[{label:o,data:d,backgroundColor:"rgba(74, 144, 226, 0.7)', borderColor: 'rgba(74, 144, 226, 1)', borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#e9edf0'}, ticks: { color: '#555', callback: function(value) { return isCurrency ? formatCurrency(value) : (isPercentage ? value + '%' : value); } } }, x: { grid: { display: false }, ticks: { color: '#555'} } }, plugins: { legend: { display: false }, title: {display:true, text:label, font:{size:16, weight: '600'}, color: 'var(--primary-color)'}, tooltip: { backgroundColor: '#333', titleFont: { size: 14 }, bodyFont: {size: 12}, padding: 10, cornerRadius: 6} } } }); }
    function renderGroupedBarChart(chartId, canvasEl, label, dataObject) { if(!canvasEl) return; const ctx = canvasEl.getContext('2d'); const labels = Object.keys(dataObject); const boysData = labels.map(l => dataObject[l].boys || 0); const girlsData = labels.map(l => dataObject[l].girls || 0); const othersData = labels.map(l => dataObject[l].other || 0); dashboardCharts[chartId] = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Boys', data: boysData, backgroundColor: 'rgba(74, 144, 226, 0.7)', borderColor: 'rgba(74, 144, 226, 1)', borderWidth: 1, borderRadius: 5 }, { label: 'Girls', data: girlsData, backgroundColor: 'rgba(232, 62, 140, 0.7)', borderColor: 'rgba(232, 62, 140, 1)', borderWidth: 1, borderRadius: 5 }, { label: 'Other', data: othersData, backgroundColor: 'rgba(80, 227, 194, 0.7)', borderColor: 'rgba(80, 227, 194, 1)', borderWidth: 1, borderRadius: 5} ] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', scales: { y: { beginAtZero: true, stacked: false, grid: { color: '#e9edf0'}, ticks: { color: '#555'} }, x: {stacked: false, grid: { display: false }, ticks: { color: '#555'}} }, plugins: { legend: { display: true, position: 'top', labels: { color: '#555', font: {size: 12}}}, title: { display: true, text: label, font:{size:16, weight: '600'}, color: 'var(--primary-color)' }, tooltip: { backgroundColor: '#333', titleFont: { size: 14 }, bodyFont: {size: 12}, padding: 10, cornerRadius: 6} } } }); }

    function updatePdfButtonVisibility(viewId) { D.downloadPdfBtn.style.display = 'none'; if (viewId === 'student-list-view') { const studentTableBody = document.getElementById('current-class-student-table-body'); if (studentTableBody && studentTableBody.rows.length > 0 && !studentTableBody.rows[0].cells[0].textContent.toLowerCase().includes('no students')) { D.downloadPdfBtn.style.display = 'inline-flex'; } } else if (viewId === 'generic-sheet-view' && D.genericTableBody.rows.length > 0 && !D.genericTableBody.rows[0].cells[0].textContent.toLowerCase().includes('empty')) { D.downloadPdfBtn.style.display = 'inline-flex'; } }
    D.downloadPdfBtn.addEventListener('click', downloadCurrentViewAsPDF);
    function downloadCurrentViewAsPDF() { let tableElement, headers = [], data = [], title = 'Data Export', orientation = 'p'; if (currentView === 'student-list-view') { const currentStudentTable = document.getElementById('current-class-student-table-body'); if(!currentStudentTable || currentClassStudents.length === 0) { showMessage(D.studentListMessage, "No data to export.", "warning"); return;} tableElement = currentStudentTable.closest('table'); const displayedClassName = D.studentListMainContent.querySelector('h3')?.textContent.replace(' - Student List','') || "Student List"; title = displayedClassName; headers = Array.from(tableElement.querySelectorAll('thead th')).map(th => th.textContent.trim()).slice(0, -1); data = currentClassStudents.map(s => [ s.PhotoURL ? 'Photo' : '-', s.RollNumber || '-', s.Name || '-', s.Mobile || '-', s.FatherName || '-' ]); if (headers.length > 4) orientation = 'l'; } else if (currentView === 'generic-sheet-view' && currentGenericSheetName && currentGenericData.length > 0) { tableElement = D.genericDataTable; title = `${currentGenericSheetName} Data`; headers = currentGenericHeaders; data = currentGenericData.map(rowItem => currentGenericHeaders.map((h, idx) => rowItem.values[idx] ?? '')); if (headers.length > 6) orientation = 'l'; } else { showMessage(D.dashboardMessage || D.mainHeaderTitle, "PDF not available.", 'warning'); return; } if (!tableElement || data.length === 0) { showMessage(D.mainHeaderTitle, "No data to download.", 'warning'); return; } try { showLoading(); const doc = new jsPDF({ orientation: orientation }); doc.setFontSize(16); doc.text(title, 14, 16); doc.setFontSize(8); doc.setTextColor(100); doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 20); jsPDF.autoTable(doc, { head: [headers], body: data, startY: 25, theme: 'grid', styles: { fontSize: orientation === 'l' ? 7 : 8, cellPadding: 1.5, overflow: 'linebreak' }, headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' }, didDrawPage: function (data) { doc.setFontSize(8); doc.setTextColor(150); const pageCount=doc.internal.getNumberOfPages(); doc.text('Page '+doc.internal.getCurrentPageInfo().pageNumber+' of '+pageCount,data.settings.margin.left,doc.internal.pageSize.height-10); } }); doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().slice(0,10)}.pdf`); hideLoading(); } catch (error) { console.error("Error PDF:", error); hideLoading(); showMessage(document.querySelector('.header-actions'), `PDF Error: ${error.message}`, 'error'); } }

    document.querySelectorAll('.close-btn, .cancel-btn[data-modal-id]').forEach(btn => { btn.addEventListener('click', () => closeModal(btn.dataset.modalId || btn.closest('.modal').id)); });
    window.addEventListener('click', (e)=>{ if(e.target.classList.contains('modal')) closeModal(e.target.id); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>closeModal(m.id)); if (D.fullscreenIframeContainer.style.display === 'flex') D.closeFullscreenIframeBtn.click(); } });
    
    document.addEventListener('DOMContentLoaded', () => {
        const storedSpreadsheetId = localStorage.getItem('schoolSpreadsheetId');
        const storedAuthToken = localStorage.getItem('authToken');
        if (storedSpreadsheetId && storedAuthToken) {
            schoolSpreadsheetId = storedSpreadsheetId;
            authToken = storedAuthToken;
            showAppView();
        } else {
            showLoginView();
        }
        const mt = D.sidebarToggleMobile;
        if (window.innerWidth <= 768) {
            mt.style.display = 'block';
            D.sidebar.classList.add('collapsed');
        } else {
            mt.style.display = 'none';
        }
    });

    window.addEventListener('resize',()=>{const mt=D.sidebarToggleMobile; if(window.innerWidth<=768){mt.style.display='block';if(!D.sidebar.classList.contains('open'))D.sidebar.classList.add('collapsed');}else{mt.style.display='none';D.sidebar.classList.remove('open');D.sidebar.classList.remove('collapsed');}});

</script>

</body>
</html>
