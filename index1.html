```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online School System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" integrity="sha512-2/YdOMV+qvjOQellQm5+L9j7m3NEOhoCyI3RZUfDy97GWoLhU/TWj9G8gcJJgehRt3cT7R+G37cqj3SjFSMWew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #2ecc71; --accent-color: #e74c3c;
            --background-color: #f4f7f9; --text-color: #34495e; --card-bg: #ffffff;
            --sidebar-bg: #2c3e50; --sidebar-text: #ecf0f1; --sidebar-hover: #34495e; --sidebar-active: var(--primary-color);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --border-radius: 8px; /* Increased border radius */
            --error-color: #e74c3c; --success-color: #2ecc71; --warning-color: #f39c12; --info-color: #3498db;
            --header-height: 60px; --sidebar-width: 250px; --sidebar-width-collapsed: 70px; /* Slightly wider sidebar */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--background-color); color: var(--text-color); display: flex; overflow-x: hidden; }
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(255,255,255,0.85);display:flex;justify-content:center;align-items:center;z-index:9999;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}#loading-overlay.show{opacity:1;visibility:visible}.spinner{width:45px;height:45px;border:5px solid rgba(0,0,0,.1);border-left-color:var(--primary-color);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
        #login-container{width:100%;min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;background:linear-gradient(135deg,#6dd5ed,#2193b0);position:fixed;top:0;left:0;z-index:5000;transition:opacity .5s ease,visibility .5s ease}#login-container.hidden{opacity:0;visibility:hidden}#login-section{background-color:var(--card-bg);padding:40px 50px;border-radius:var(--border-radius);box-shadow:0 10px 25px rgba(0,0,0,.2);text-align:center;width:90%;max-width:420px;animation:fadeInLogin .6s ease-out}#login-section h2{color:var(--primary-color);margin-bottom:30px;font-family:'Titillium Web',sans-serif;font-weight:700;font-size:2rem;display:flex;align-items:center;justify-content:center;gap:10px}#login-section h2 i{opacity:.8}.input-group{margin-bottom:20px;position:relative;text-align:left}.input-group i.fa-input-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--primary-color);opacity:.6}.input-group input{width:100%;padding:14px 15px 14px 45px;border:1px solid #ccc;border-radius:var(--border-radius);font-size:1rem;transition:border-color .3s ease,box-shadow .3s ease;background-color:#fdfdfd}.input-group input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(52,152,219,.2)}
        .login-button{background:linear-gradient(45deg,var(--primary-color),#5dade2);color:#fff;padding:14px 25px;border:none;border-radius:var(--border-radius);font-size:1.1rem;cursor:pointer;transition:all .3s ease;width:100%;box-shadow:0 4px 8px rgba(0,0,0,.15);font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-transform:uppercase;letter-spacing:.5px}.login-button:hover{background:linear-gradient(45deg,#2980b9,var(--primary-color));box-shadow:0 6px 12px rgba(0,0,0,.2);transform:translateY(-2px)}.login-button:active,.login-button.processing{transform:translateY(0);box-shadow:0 2px 5px rgba(0,0,0,.15); animation:pulseButton .5s ease-in-out;} @keyframes pulseButton{0%,100%{transform:scale(1)}50%{transform:scale(.98)}}
        #login-message{margin-top:20px;font-weight:500;min-height:20px}#premium-info-section{display:none;background:var(--card-bg);padding:40px 50px;border-radius:var(--border-radius);box-shadow:0 10px 25px rgba(0,0,0,.2);text-align:center;width:90%;max-width:550px;color:var(--text-color);border-left:5px solid var(--warning-color);animation:fadeInLogin .6s ease-out}#premium-info-section h2{color:var(--warning-color);margin-bottom:15px;font-size:1.8rem;font-family:'Titillium Web',sans-serif;font-weight:700}#premium-info-section p{margin-bottom:25px;line-height:1.6;font-size:1rem}.back-to-login-btn{background:var(--warning-color);color:#fff;padding:11px 25px;border:none;border-radius:var(--border-radius);font-size:1rem;cursor:pointer;transition:all .3s ease;font-weight:600;display:inline-flex;align-items:center;gap:8px;box-shadow:0 2px 5px rgba(0,0,0,.1)}.back-to-login-btn:hover{background-color:#d48c0a;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}.back-to-login-btn:active{transform:translateY(0);box-shadow:0 2px 5px rgba(0,0,0,.1)}@keyframes fadeInLogin{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        #app-container { display: flex; width: 100%; opacity: 0; visibility: hidden; transition: opacity .5s ease, visibility .5s ease; }
        #app-container.visible { opacity: 1; visibility: visible; }
        #sidebar{width:var(--sidebar-width);height:100vh;background-color:var(--sidebar-bg);color:var(--sidebar-text);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:1000;transition:width .3s ease,left .3s ease;overflow-y:auto;overflow-x:hidden}#sidebar.collapsed{width:var(--sidebar-width-collapsed)}#sidebar .sidebar-header{padding:15px;display:flex;align-items:center;justify-content:center;height:var(--header-height);border-bottom:1px solid rgba(236,240,241,.1);white-space:nowrap}#sidebar .sidebar-header .logo-icon{font-size:1.8rem;color:var(--primary-color);margin-right:10px;transition:margin .3s ease}#sidebar .sidebar-header .logo-text{font-family:'Titillium Web',sans-serif;font-size:1.5rem;font-weight:700;opacity:1;transition:opacity .3s ease}#sidebar.collapsed .logo-icon{margin-right:0}#sidebar.collapsed .logo-text{opacity:0;width:0;overflow:hidden}#sidebar .sidebar-menu{list-style:none;padding:15px 0;flex-grow:1}#sidebar .sidebar-menu li{white-space:nowrap}#sidebar .sidebar-menu li a,#sidebar .sidebar-menu li .menu-item{display:flex;align-items:center;padding:13px 20px;color:var(--sidebar-text);text-decoration:none;transition:background-color .2s ease,color .2s ease, padding-left .2s ease;cursor:pointer;border-left:4px solid transparent}#sidebar .sidebar-menu li a i,#sidebar .sidebar-menu li .menu-item i{font-size:1.1rem;margin-right:15px;width:25px;text-align:center;transition:font-size .3s ease}#sidebar .sidebar-menu li span.menu-text{opacity:1;transition:opacity .2s ease .1s;font-size:.95rem}#sidebar .sidebar-menu li a:hover,#sidebar .sidebar-menu li .menu-item:hover{background-color:var(--sidebar-hover)}#sidebar .sidebar-menu li.active>a,#sidebar .sidebar-menu li.active>.menu-item{background-color:var(--sidebar-active);color:#fff;border-left-color:var(--secondary-color);font-weight:500;padding-left: 25px;}#sidebar.collapsed .sidebar-menu li a,#sidebar.collapsed .sidebar-menu li .menu-item{justify-content:center;padding:13px 10px}#sidebar.collapsed .sidebar-menu li a i,#sidebar.collapsed .sidebar-menu li .menu-item i{margin-right:0;font-size:1.4rem}#sidebar.collapsed .sidebar-menu li span.menu-text{opacity:0;position:absolute;width:0;height:0;overflow:hidden}#sidebar .sidebar-divider{height:1px;background-color:rgba(236,240,241,.1);margin:15px 20px}#sidebar.collapsed .sidebar-divider{margin:15px 10px}#sidebar .sidebar-footer{padding:15px 20px;border-top:1px solid rgba(236,240,241,.1);text-align:center}#sidebar #sidebar-toggle{background:none;border:none;color:var(--sidebar-text);font-size:1.3rem;cursor:pointer;padding:5px;transition:transform .3s ease}#sidebar #sidebar-toggle:hover{color:var(--primary-color);transform:scale(1.1)}#sidebar.collapsed .sidebar-footer{padding:15px 10px}
        #main-content{flex-grow:1;height:100vh;overflow-y:auto;margin-left:var(--sidebar-width);padding-top:var(--header-height);padding-bottom:30px;transition:margin-left .3s ease}#sidebar.collapsed+#main-content{margin-left:var(--sidebar-width-collapsed)}#top-header{position:fixed;top:0;left:var(--sidebar-width);right:0;height:var(--header-height);background-color:var(--card-bg);box-shadow:0 2px 5px rgba(0,0,0,.08);z-index:900;display:flex;align-items:center;padding:0 25px;justify-content:space-between;transition:left .3s ease}#sidebar.collapsed~#top-header{left:var(--sidebar-width-collapsed)}.header-title{font-family:'Titillium Web',sans-serif;font-size:1.5rem;font-weight:600;color:var(--primary-color)}.header-actions{display:flex;align-items:center;gap:10px}.header-actions button{background:none;border:1px solid #ccc;color:var(--text-color);font-size:.85rem;cursor:pointer;margin-left:5px;padding:5px 10px;border-radius:var(--border-radius);transition:all .2s ease;display:inline-flex;align-items:center;gap:5px}.header-actions button:hover{background-color:#eee;border-color:#bbb}.header-actions button.logout-button{border-color:var(--accent-color);color:var(--accent-color)}.header-actions button.logout-button:hover{background-color:var(--accent-color);color:#fff}
        .content-wrapper{padding:25px;max-width:100%}.view-section{display:none;animation:fadeInView .5s ease-out;background-color:transparent; /* View sections are now containers, card background is for elements inside */ padding:0; border-radius:0; box-shadow:none; margin-bottom:30px}.view-section.active{display:block}.view-header{font-family:'Titillium Web',sans-serif;font-size:1.8rem;font-weight:600;color:var(--primary-color);margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between;gap:10px; background-color:var(--card-bg); padding: 20px 25px; border-radius:var(--border-radius) var(--border-radius) 0 0; box-shadow: var(--shadow);} .view-header .title-text{display:flex;align-items:center;gap:10px}.view-header .title-text i{opacity:.8}.view-header .header-action-buttons button{font-size:.9rem;padding:6px 12px}@keyframes fadeInView{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* Section Content Style (Applied to divs inside view-section) */
        .section-content { background-color: var(--card-bg); padding: 25px; border-radius: 0 0 var(--border-radius) var(--border-radius); box-shadow: var(--shadow); }
        .data-table-container{max-height:65vh;overflow:auto;border:1px solid #e8e8e8;border-radius:var(--border-radius);box-shadow:0 1px 3px rgba(0,0,0,.05)}.data-table{width:100%;border-collapse:collapse;font-size:.9rem}.data-table th,.data-table td{padding:12px 15px;text-align:left;border-bottom:1px solid #eee;white-space:nowrap;vertical-align:middle}.data-table th{background-color:#f8f9fa;font-weight:600;color:var(--primary-color);position:sticky;top:0;z-index:10;box-shadow:inset 0 -1px 0 #e8e8e8}.data-table tbody tr:nth-child(even){background-color:#fdfdfd}.data-table tbody tr:hover{background-color:#eef5fc}.data-table .action-col{text-align:center;white-space:nowrap}.data-table .action-col i { margin: 0 5px; cursor: pointer; font-size: 1.1rem; transition: color 0.3s ease, transform 0.2s ease; padding:5px; display:inline-block;} .data-table .action-col .edit-btn, .data-table .action-col .edit-btn-generic {color: var(--primary-color);} .data-table .action-col .edit-btn:hover, .data-table .action-col .edit-btn-generic:hover {color: var(--secondary-color); transform: scale(1.1);} .data-table .action-col .delete-btn { color: var(--accent-color); } .data-table .action-col .delete-btn:hover { color: #c0392b; transform: scale(1.1); } .data-table .action-col .view-btn { color: var(--info-color); } .data-table .action-col .view-btn:hover { color: #2980b9; transform: scale(1.1); }.data-table .student-photo,.data-table .student-photo-placeholder{width:35px;height:35px;border-radius:50%;object-fit:cover;vertical-align:middle;border:1px solid #eee;background-color:#e0e0e0;display:inline-flex;align-items:center;justify-content:center;color:#999;font-size:1rem}
        
        /* Student List specific styling for class tiles */
        #student-classes-list { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; padding: 20px 0;} /* Added padding */
        .class-tile { background-color: #fff; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); cursor: pointer; transition: all 0.3s ease; min-width: 220px; text-align: center; border-left: 5px solid var(--primary-color); display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .class-tile:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-left-color: var(--secondary-color); }
        .class-tile i.fa-chalkboard { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 15px; } /* Updated icon */
        .class-tile h4 { font-size: 1.3rem; font-weight: 600; margin-bottom: 8px; }
        .class-tile p { font-size: 0.95rem; color: #777; }
        .back-to-classes-btn { margin-bottom: 20px; background-color: #7f8c8d; color: white; padding: 8px 15px; font-size: 0.9rem;}

        #student-list-view .filter-controls{margin-bottom:20px;padding:15px;background-color:#f9f9f9;border-radius:var(--border-radius);display:flex;align-items:center;gap:15px;flex-wrap:wrap}#student-list-view .filter-controls label{font-weight:500;display:flex;align-items:center;gap:5px;color:#555}#student-list-view .filter-controls select{padding:8px 12px;border:1px solid #ccc;border-radius:var(--border-radius);min-width:180px;font-size:.95rem;cursor:pointer;background-color:#fff}#student-list-view .filter-controls select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(52,152,219,.2)}#student-list-view .student-table-container{max-height:calc(100vh - 320px); /* Adjusted for potentially taller view header */}
        #add-results-view .form-step{margin-bottom:25px;padding:25px 30px;background-color:#fdfdfd;border:1px solid #e8e8e8;border-radius:var(--border-radius);animation:fadeIn .4s ease-out;box-shadow:0 1px 3px rgba(0,0,0,.05)}#add-results-view .form-step h4{margin-bottom:20px;color:var(--primary-color);font-size:1.2rem;font-weight:600;border-bottom:1px solid #eee;padding-bottom:10px}#add-results-view .input-group{margin-bottom:20px}#add-results-view .input-group label{display:block;margin-bottom:6px;font-weight:500;color:#555;font-size:.9rem}#add-results-view .input-group input,#add-results-view .input-group select{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:var(--border-radius);font-size:.95rem;transition:border-color .3s ease,box-shadow .3s ease}#add-results-view .input-group input:focus,#add-results-view .input-group select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(52,152,219,.2)}#add-results-view .subject-entry{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;align-items:center;margin-bottom:12px;padding:12px;background-color:#f9f9f9;border-radius:var(--border-radius);border:1px solid #eee}#add-results-view .subject-entry input{padding:9px;border:1px solid #ccc;border-radius:var(--border-radius);font-size:.9rem}#add-results-view .subject-entry input.marks-input{width:80px;text-align:center}#add-results-view .remove-subject-btn{background:none;border:none;color:var(--error-color);font-size:1.3rem;cursor:pointer;transition:color .3s ease,transform .2s ease;padding:0 5px;line-height:1;opacity:.7}#add-results-view .remove-subject-btn:hover{color:#c0392b;transform:scale(1.1);opacity:1}#add-results-view .add-subject-btn{background-color:var(--secondary-color);color:#fff;padding:8px 15px;border:none;border-radius:var(--border-radius);font-size:.9rem;cursor:pointer;transition:all .3s ease;margin-top:10px;font-weight:500;display:inline-flex;align-items:center;gap:6px}#add-results-view .add-subject-btn:hover{background-color:#27ae60;transform:translateY(-2px);box-shadow:0 2px 4px rgba(0,0,0,.1)}#add-results-view .step-navigation{display:flex;justify-content:space-between;margin-top:25px;padding-top:20px;border-top:1px solid #eee;flex-wrap:wrap;gap:10px}#add-results-view .step-navigation button{padding:10px 22px;border:none;border-radius:var(--border-radius);font-size:1rem;cursor:pointer;transition:all .3s ease;font-weight:500;display:inline-flex;align-items:center;gap:8px}#add-results-view .step-navigation button:hover{transform:translateY(-2px);box-shadow:0 3px 6px rgba(0,0,0,.1)}#add-results-view .next-step-btn,#add-results-view .submit-result-btn{background-color:var(--primary-color);color:#fff}#add-results-view .next-step-btn:hover,#add-results-view .submit-result-btn:hover{background-color:#2980b9}#add-results-view .prev-step-btn{background-color:#95a5a6;color:#fff}#add-results-view .prev-step-btn:hover{background-color:#7f8c8d}#add-results-view #results-student-list{margin-top:15px;max-height:40vh;overflow-y:auto;padding-right:5px;border:1px solid #eee;border-radius:var(--border-radius);background-color:#fff}#add-results-view .student-result-item{display:flex;align-items:center;padding:10px 15px;margin:0;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background-color .2s ease;position:relative}#add-results-view .student-result-item:last-child{border-bottom:none}#add-results-view .student-result-item:hover{background-color:#eef5fc}#add-results-view .student-result-item.selected{background-color:#d4e6fa;font-weight:500}#add-results-view .student-result-item.selected::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background-color:var(--primary-color)}#add-results-view .student-result-item img{width:40px;height:40px;border-radius:50%;margin-right:15px;object-fit:cover;border:1px solid #eee}#add-results-view .student-result-item .student-photo-placeholder{width:40px;height:40px;margin-right:15px}#add-results-view .student-result-info span{display:block;font-size:.9rem;color:#555;line-height:1.4}#add-results-view .student-result-info span strong{color:var(--text-color);font-weight:600;font-size:.95rem}#add-results-view .result-saved-indicator{margin-left:auto;color:var(--success-color);font-size:1.1rem;opacity:0;transition:opacity .3s ease}#add-results-view .student-result-item.has-result .result-saved-indicator{opacity:1}#add-results-view #marks-entry-container{margin-top:20px;padding:20px;border:1px solid #e0e0e0;border-radius:var(--border-radius);background-color:#fdfdfd;box-shadow:0 1px 3px rgba(0,0,0,.05)}#add-results-view #marks-entry-container h5{margin-bottom:15px;color:var(--primary-color);font-size:1.1rem;font-weight:600;border-bottom:1px solid #eee;padding-bottom:10px}#add-results-view #marks-entry-container h5 strong{color:var(--secondary-color);font-weight:700}#add-results-view #marks-entry-form .marks-input-group{display:grid;grid-template-columns:1fr auto;gap:10px 15px;align-items:center;margin-bottom:12px}#add-results-view #marks-entry-form .marks-input-group label{font-weight:500;font-size:.95rem;text-align:right;color:#444}#add-results-view #marks-entry-form .marks-input-group label .max-marks{font-size:.8em;font-weight:400;color:#888}#add-results-view #marks-entry-form .marks-input-group input{padding:9px;border:1px solid #ccc;border-radius:var(--border-radius);width:100px;text-align:center;font-size:.95rem}#add-results-view #marks-entry-form .marks-input-group input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 2px rgba(52,152,219,.15)}#add-results-view #marks-entry-form .marks-input-group input.invalid{border-color:var(--error-color);background-color:#fdecea}#add-results-view #marks-entry-message{margin-top:15px;font-weight:500;min-height:20px}
        
        /* Generic Sheet View Actions */
        #generic-sheet-view .header-action-buttons button { margin-left: 10px; }

        /* Modal Styling */
        .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);animation:fadeInModalBg .3s ease-out;padding-top:5vh;padding-bottom:5vh}@keyframes fadeInModalBg{from{opacity:0}to{opacity:1}}.modal-content{background-color:var(--card-bg);margin:0 auto;padding:0;border:none;width:90%;max-width:700px;border-radius:var(--border-radius);box-shadow:0 5px 20px rgba(0,0,0,.2);position:relative;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;animation:zoomInModal .3s ease-out}@keyframes zoomInModal{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}.modal-content.modal-lg{max-width:950px}.modal-content.modal-xl{max-width:1200px}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:18px 30px;border-bottom:1px solid #eee;background-color:#f8f9fa;border-top-left-radius:var(--border-radius);border-top-right-radius:var(--border-radius)}.modal-header h3{color:var(--primary-color);font-size:1.4rem;font-family:'Titillium Web',sans-serif;display:flex;align-items:center;gap:10px;font-weight:600}.modal-header h3 i{opacity:.8}.close-btn{color:#aaa;background:none;border:none;font-size:1.8rem;font-weight:700;cursor:pointer;transition:color .3s ease,transform .2s ease;line-height:1;padding:0 5px}.close-btn:hover,.close-btn:focus{color:var(--error-color);transform:rotate(90deg);outline:none}.modal-body{overflow-y:auto;padding:25px 30px;flex-grow:1}.modal-body .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px 20px}.modal-body .input-group{margin-bottom:0}.modal-body .input-group label{display:block;margin-bottom:5px;font-weight:500;color:#555;font-size:.9rem}.modal-body .input-group input,.modal-body .input-group select,.modal-body .input-group textarea{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:var(--border-radius);font-size:.95rem}.modal-body .input-group input:focus,.modal-body .input-group select:focus,.modal-body .input-group textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(52,152,219,.2)}.modal-body .input-group textarea{min-height:80px;resize:vertical}.modal-footer{padding:15px 30px;border-top:1px solid #eee;text-align:right;background-color:#f8f9fa;border-bottom-left-radius:var(--border-radius);border-bottom-right-radius:var(--border-radius)}.modal-footer button{padding:10px 20px;border-radius:var(--border-radius);cursor:pointer;font-size:.95rem;margin-left:10px;transition:all .3s ease;font-weight:500;border:none;display:inline-flex;align-items:center;gap:6px}.modal-footer .save-btn{background-color:var(--success-color);color:#fff}.modal-footer .save-btn:hover{background-color:#27ae60;transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.1)}.modal-footer .save-btn:active{transform:translateY(0);box-shadow:none}.modal-footer .cancel-btn{background-color:#bdc3c7;color:#fff}.modal-footer .cancel-btn:hover{background-color:#95a5a6;transform:translateY(-2px)}.modal-footer .cancel-btn:active{transform:translateY(0)}.modal-footer .message{margin:0 0 10px 0;text-align:left}
        .message{padding:10px 15px;border-radius:var(--border-radius);margin:15px 0;font-weight:500;text-align:left;border-width:1px;border-style:solid;display:flex;align-items:center;gap:10px;font-size:.9rem}.message i.fa-message-icon{font-size:1.1em}.message.error{background-color:#f8d7da;color:#721c24;border-color:#f5c6cb}.message.success{background-color:#d4edda;color:#155724;border-color:#c3e6cb}.message.info{background-color:#d1ecf1;color:#0c5460;border-color:#bee5eb}.message.warning{background-color:#fff3cd;color:#856404;border-color:#ffeeba}
        .hidden{display:none!important}
        /* Dashboard View */
        #dashboard-view .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom:30px;}
        .dashboard-card { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center; } /* Flex for better centering */
        .dashboard-card .card-icon { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 15px; }
        .dashboard-card .card-title { font-size: 0.9rem; color: #777; margin-bottom: 8px; text-transform: uppercase; font-weight:500;}
        .dashboard-card .card-value { font-size: 2.2rem; font-weight: 700; color: var(--text-color); }
        .dashboard-chart-container { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 25px; }
        .dashboard-chart-container h4 { margin-bottom:15px; font-size:1.2rem; color:var(--primary-color); text-align:center; }

        /* Tools View & Fullscreen Iframe */
        #tools-view-content { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; padding:20px 0;}
        .tool-card { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px; width: 220px; text-align: center; cursor: pointer; transition: transform .2s ease, box-shadow .2s ease; border-top: 4px solid var(--primary-color); }
        .tool-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .tool-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 15px; border-radius: 50%; background: #f0f0f0; padding: 5px;}
        .tool-card h4 { font-size: 1.1rem; margin-bottom: 8px; color: var(--text-color); font-weight:600;}
        .tool-card p { font-size: 0.9rem; color: #777; }
        
        #fullscreen-iframe-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 6000; display: none; flex-direction: column; }
        #fullscreen-iframe-header { background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;}
        #fullscreen-iframe-title { font-size: 1.2rem; font-weight: 600; }
        #close-fullscreen-iframe-btn { background: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: var(--border-radius); cursor: pointer; font-size: .9rem; }
        #fullscreen-iframe-wrapper { flex-grow: 1; background-color: #fff; }
        #fullscreen-iframe-wrapper iframe { width: 100%; height: 100%; border: none; }

        /* Add Fees View */
        #add-fees-view .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 20px;}
        #add-fees-view .input-group {margin-bottom:15px;}
        #add-fees-view .submit-btn { margin-top: 20px; width: 100%; }

        /* Profile Modals Professional UI */
        .profile-grid { display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .profile-sidebar { background-color: #f8f9fa; padding: 25px; border-radius: var(--border-radius); text-align: center; }
        .profile-photo-container img, .profile-photo-container div { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px auto; border: 4px solid var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .profile-sidebar h3.profile-name { font-size: 1.6rem; color: var(--primary-color); margin-bottom: 10px; font-family: 'Titillium Web'; }
        .profile-sidebar p.profile-meta { font-size: 0.95rem; color: #555; margin-bottom: 8px; line-height: 1.5; }
        .profile-sidebar p.profile-meta i { margin-right: 8px; color: var(--primary-color); width: 16px; text-align:center;}
        .profile-main-content .details-section { background-color: #fff; padding: 20px 25px; border-radius: var(--border-radius); margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .profile-main-content .details-section:last-child { margin-bottom: 0; }
        .profile-main-content .details-section h4 { font-size: 1.2rem; color: var(--primary-color); margin-bottom: 18px; font-weight: 600; padding-bottom: 10px; border-bottom: 1px solid #eee; display:flex; align-items:center; gap:8px;}
        .profile-main-content .details-section h4 i { opacity: 0.8; }
        .profile-main-content .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px 25px; }
        .profile-main-content .info-grid p { margin-bottom: 10px; font-size: 0.95rem; display: flex; }
        .profile-main-content .info-grid strong { font-weight: 600; color: var(--text-color); min-width: 120px; display: inline-block; color: #555; }
        .profile-main-content .details-list { max-height: 250px; overflow-y: auto; padding-right:10px;} /* Added padding for scrollbar */
        .profile-main-content .list-item { padding: 10px 5px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;}
        .profile-main-content .list-item:last-child { border-bottom: none; }
        .profile-main-content .list-item span { font-size: 0.9rem; }
        .profile-main-content .list-item .amount { font-weight: bold; }
        .profile-main-content .list-item .status-due { color: var(--error-color); font-weight:500; }
        .profile-main-content .list-item .status-paid { color: var(--success-color); font-weight:500; }
        .profile-main-content .attendance-summary, .profile-main-content .fees-summary { margin-bottom:15px; font-weight:bold; font-size:1rem; text-align: right;}
        .profile-main-content .mark-paid-btn { padding: 6px 12px; font-size: 0.85rem; background-color: var(--secondary-color); color:white; border:none; border-radius: var(--border-radius); cursor: pointer;}
        .profile-main-content .mark-paid-btn:hover { background-color: #27ae60; }
        #staffDetailsModal .profile-main-content #add-salary-form-modal { margin-top:20px; padding-top:20px; border-top:1px solid #eee;} /* Spacing for salary form */


        @media (max-width: 992px) { /* For better responsive profile modals */
             .profile-grid { grid-template-columns: 1fr; }
             .profile-sidebar { margin-bottom: 25px; }
        }
        @media (max-width: 768px){
            :root{--sidebar-width:200px;--sidebar-width-collapsed:0}
            #sidebar{position:fixed;left:calc(-1 * var(--sidebar-width));z-index:1100}#sidebar.open{left:0}#sidebar.collapsed{width:0;left:calc(-1 * var(--sidebar-width))}
            #main-content{margin-left:0!important}#top-header{left:0!important;padding:0 15px}
            .header-title{font-size:1.3rem}#sidebar-toggle-mobile{display:block;margin-right:10px}#sidebar-toggle{display:none}
            .content-wrapper{padding:15px}.view-section{/* padding already 0 */} .section-content { padding: 20px;}
            .view-header{font-size:1.4rem;margin-bottom:0; border-radius:var(--border-radius) var(--border-radius) 0 0; padding: 15px 20px;}
            .data-table th,.data-table td{padding:8px 10px;font-size:.85rem}
            .modal-content{width:95%;max-width:95%}.modal-body .form-grid{grid-template-columns:1fr}
            .modal-header{padding:15px 20px}.modal-body{padding:20px}.modal-footer{padding:12px 20px}.modal-footer button{font-size:.9rem;padding:8px 15px}
            #add-results-view .step-navigation{flex-direction:column;align-items:stretch}#add-results-view .step-navigation button{width:100%}#add-results-view .step-navigation .prev-step-btn{margin-bottom:10px}
            #dashboard-view .dashboard-grid { grid-template-columns: 1fr; } 
            #add-fees-view .form-grid { grid-template-columns: 1fr; }
            #student-classes-list { justify-content: center; } .class-tile { width: 90%; }
        }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div></div>

<div id="login-container">
    <div id="login-section">
        <h2><i class="fas fa-school"></i> School Portal</h2>
        <form id="login-form" novalidate>
            <div class="input-group"><i class="fas fa-mobile-alt fa-input-icon"></i><input type="tel" id="mobile" placeholder="Mobile Number" required></div>
            <div class="input-group"><i class="fas fa-lock fa-input-icon"></i><input type="password" id="password" placeholder="Password" required></div>
            <button type="submit" class="login-button" id="login-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
        </form>
        <div id="login-message" class="message error" style="display: none;"></div>
    </div>
     <div id="premium-info-section">
         <h2><i class="fas fa-exclamation-triangle"></i> Premium Access Required</h2>
         <p>This feature requires premium access to the system. Please contact support.</p>
         <button class="back-to-login-btn" id="premium-back-btn"><i class="fas fa-arrow-left"></i> Back to Login</button>
    </div>
</div>

<div id="app-container">
    <aside id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-university logo-icon"></i>
            <span class="logo-text">School Sys</span>
        </div>
        <ul class="sidebar-menu" id="sidebar-menu">
            <li id="nav-dashboard" class="active"><a data-view="dashboard-view"><i class="fas fa-tachometer-alt"></i><span class="menu-text">Dashboard</span></a></li>
            <li id="nav-students"><a data-view="student-list-view"><i class="fas fa-user-graduate"></i><span class="menu-text">Students</span></a></li>
            <li id="nav-staff"><a data-view="staff-list-view"><i class="fas fa-users-cog"></i><span class="menu-text">Staff</span></a></li>
            <li id="nav-add-fees"><a data-view="add-fees-view"><i class="fas fa-file-invoice-dollar"></i><span class="menu-text">Add Fees</span></a></li>
            <li id="nav-add-result"><a data-view="add-results-view"><i class="fas fa-plus-circle"></i><span class="menu-text">Add Result</span></a></li>
            <li id="nav-tools"><a data-view="tools-view"><i class="fas fa-tools"></i><span class="menu-text">Tools Hub</span></a></li>
            <li class="sidebar-divider" id="generator-divider" style="display: none;"></li>
            <!-- Dynamic generators will be appended here -->
            <li class="sidebar-divider" id="sheet-divider" style="display: none;"></li>
            <!-- Dynamic sheets will be appended here -->
        </ul>
        <div class="sidebar-footer"><button id="sidebar-toggle" title="Toggle Sidebar"><i class="fas fa-bars"></i></button></div>
    </aside>

    <main id="main-content">
        <header id="top-header">
             <button id="sidebar-toggle-mobile" style="display: none;"><i class="fas fa-bars"></i></button>
            <div class="header-title" id="main-header-title">Dashboard</div>
             <div class="header-actions">
                 <button id="download-pdf-btn" style="display: none;" title="Download Current View as PDF">
                     <i class="fas fa-file-pdf"></i> PDF
                 </button>
                <span id="user-greeting"></span>
                 <button class="logout-button" id="logout-btn" title="Logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
             </div>
        </header>

        <div class="content-wrapper">
            <!-- Dashboard View -->
            <section id="dashboard-view" class="view-section active">
                <div class="view-header"><div class="title-text"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</div></div>
                <div class="section-content">
                    <div id="dashboard-message" class="message info" style="display: none;"></div>
                    <div id="dashboard-content">
                        <div class="dashboard-grid">
                            <div class="dashboard-card"><i class="fas fa-user-graduate card-icon"></i><div class="card-title">Total Students</div><div class="card-value" id="db-total-students">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-chalkboard-teacher card-icon"></i><div class="card-title">Total Staff</div><div class="card-value" id="db-total-staff">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-school card-icon"></i><div class="card-title">Total Classes</div><div class="card-value" id="db-total-classes">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-venus card-icon" style="color: #e83e8c;"></i><div class="card-title">Total Girls</div><div class="card-value" id="db-total-girls">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-mars card-icon" style="color: #007bff;"></i><div class="card-title">Total Boys</div><div class="card-value" id="db-total-boys">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-money-bill-wave card-icon" style="color: var(--success-color);"></i><div class="card-title">Total Paid Fees</div><div class="card-value" id="db-total-paid">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-hand-holding-usd card-icon" style="color: var(--error-color);"></i><div class="card-title">Total Due Fees</div><div class="card-value" id="db-total-due">-</div></div>
                            <div class="dashboard-card"><i class="fas fa-receipt card-icon" style="color: var(--warning-color);"></i><div class="card-title">Total Expenses</div><div class="card-value" id="db-total-expenses">-</div></div>
                        </div>
                        <div class="dashboard-grid">
                            <div class="dashboard-chart-container"><canvas id="studentsPerClassChart"></canvas></div>
                            <div class="dashboard-chart-container"><canvas id="genderSplitPerClassChart"></canvas></div>
                        </div>
                         <div class="dashboard-grid">
                            <div class="dashboard-chart-container"><canvas id="feesCollectedPerClassChart"></canvas></div>
                            <div class="dashboard-chart-container"><canvas id="duesPerClassChart"></canvas></div>
                        </div>
                        <div class="dashboard-grid">
                            <div class="dashboard-chart-container"><canvas id="attendancePerClassChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Student List View -->
            <section id="student-list-view" class="view-section">
                <div class="view-header">
                    <div class="title-text"><i class="fas fa-user-graduate"></i> Students Management</div>
                </div>
                <div class="section-content">
                    <div id="student-list-main-content">
                        <!-- Populated by JS: either class tiles or student table -->
                    </div>
                    <div id="student-list-message" class="message info" style="display: none;"></div>
                </div>
            </section>
            
            <!-- Staff List View -->
            <section id="staff-list-view" class="view-section">
                <div class="view-header"><div class="title-text"><i class="fas fa-users-cog"></i> Staff Management</div></div>
                <div class="section-content">
                    <div id="staff-list-message" class="message info" style="display: none;"></div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead><tr><th>Photo</th><th>Name</th><th>Mobile</th><th>Role/Designation</th><th>Is Active</th><th>Actions</th></tr></thead>
                            <tbody id="staff-table-body"><tr><td colspan="6" style="text-align:center; padding: 30px; color: #888;">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Add Fees View -->
            <section id="add-fees-view" class="view-section">
                <div class="view-header"><div class="title-text"><i class="fas fa-file-invoice-dollar"></i> Add Bulk Fees</div></div>
                <div class="section-content">
                    <div id="add-fees-message" class="message" style="display:none;"></div>
                    <form id="add-fees-form">
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="fee-class-select">Select Class:</label>
                                <select id="fee-class-select" required><option value="" disabled selected>-- Select Class --</option></select>
                            </div>
                            <div class="input-group">
                                <label for="fee-type-select">Fee Type:</label>
                                <select id="fee-type-select" required><option value="" disabled selected>-- Select Fee Type --</option></select>
                            </div>
                             <div class="input-group">
                                <label for="fee-amount">Amount (Optional):</label>
                                <input type="number" id="fee-amount" placeholder="Default from Fee Type">
                            </div>
                            <div class="input-group">
                                <label for="fee-month-year">For Month & Year (e.g., Jul 2024):</label>
                                <input type="text" id="fee-month-year" required placeholder="MMMM YYYY">
                            </div>
                            <div class="input-group">
                                <label for="fee-due-date">Due Date:</label>
                                <input type="date" id="fee-due-date" required>
                            </div>
                            <div class="input-group">
                                <label for="fee-academic-year">Academic Year (e.g., 2024-25):</label>
                                <input type="text" id="fee-academic-year" placeholder="Optional, e.g., 2024-25">
                            </div>
                        </div>
                        <button type="submit" class="save-btn submit-btn"><i class="fas fa-plus-circle"></i> Add Fees to Class</button>
                    </form>
                </div>
            </section>

            <!-- Add Results View (existing) -->
             <section id="add-results-view" class="view-section">
                 <div class="view-header"><div class="title-text"><i class="fas fa-plus-circle"></i> Add New Result</div></div>
                 <div class="section-content">
                    <div id="add-results-message" class="message" style="display: none;"></div>
                    <div id="step1-result-details" class="form-step">
                        <h4>Step 1: Result & Subject Details</h4>
                        <div class="input-group"><label for="result-name">Result Name:</label><input type="text" id="result-name"></div>
                        <div class="input-group"><label for="school-name">School Name (for report):</label><input type="text" id="school-name"></div>
                        <div class="input-group"><label for="teacher-name">Teacher's Name (for report):</label><input type="text" id="teacher-name"></div>
                        <div class="input-group"><label for="result-class">Select Class:</label><select id="result-class"><option value="" disabled selected>-- Select --</option></select></div>
                        <div id="subjects-container">
                            <label>Subjects:</label>
                            <div class="subject-entry">
                                <input type="text" class="subject-name">
                                <input type="number" class="total-marks marks-input" placeholder="Total" min="1" value="100">
                                <input type="number" class="pass-marks marks-input" placeholder="Pass" min="0" value="30">
                                <button type="button" class="remove-subject-btn" onclick="removeSubject(this)" style="visibility: hidden;"><i class="fas fa-times-circle"></i></button>
                            </div>
                        </div>
                        <button type="button" class="add-subject-btn" id="add-subject-btn"><i class="fas fa-plus"></i> Add Subject</button>
                        <div class="step-navigation" style="justify-content: flex-end;">
                            <button type="button" class="next-step-btn" id="next-to-step2-btn">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                     <div id="step2-select-student" class="form-step" style="display: none;"><h4>Step 2: Select Student (Class: <strong id="selected-class-info"></strong>)</h4><p style="font-size:.9rem;color:#666;margin-bottom:15px">Click student to enter marks. <i class="fas fa-check-circle" style="color:var(--success-color);"></i> indicates saved.</p><div id="results-student-list"><p class="message info">Loading...</p></div><div class="step-navigation"><button type="button" class="prev-step-btn" id="back-to-step1-btn"><i class="fas fa-arrow-left"></i> Back</button></div></div>
                     <div id="step3-enter-marks" class="form-step" style="display: none;"><div id="marks-entry-container"><h5>Marks for: <strong id="selected-student-info"></strong></h5><form id="marks-entry-form" novalidate><p class="message info">Loading...</p></form><div id="marks-entry-message" class="message" style="display: none;"></div></div><div class="step-navigation"><button type="button" class="prev-step-btn" id="back-to-step2-btn"><i class="fas fa-arrow-left"></i> Back</button><button type="button" class="submit-result-btn" id="submit-marks-btn">Save <i class="fas fa-save"></i></button></div></div>
                 </div>
             </section>
            
            <!-- Tools View (cards) -->
            <section id="tools-view" class="view-section">
                <div class="view-header"><div class="title-text"><i class="fas fa-tools"></i> Tools Hub</div></div>
                <div class="section-content">
                    <div id="tools-message" class="message info" style="display: none;"></div>
                    <div id="tools-view-content"><p class="message info">Loading tools...</p></div>
                </div>
            </section>

            <!-- Generic Sheet View (for other sheets) -->
            <section id="generic-sheet-view" class="view-section">
                 <div class="view-header">
                     <div class="title-text" id="generic-view-title"><i class="far fa-file-alt"></i> Sheet View</div>
                      <div class="header-action-buttons">
                           <button id="download-sheet-json-btn" class="info-btn" style="display:none;"><i class="fas fa-download"></i> Download JSON</button>
                      </div>
                 </div>
                 <div class="section-content">
                    <div id="generic-sheet-message" class="message info" style="display: none;"></div>
                    <div id="generic-table-container" class="data-table-container">
                        <table id="generic-data-table" class="data-table">
                            <thead><tr id="generic-table-header-row"></tr></thead>
                            <tbody id="generic-table-body"><tr><td colspan="1" style="text-align:center; padding: 30px; color: #888;">Select a sheet from the menu.</td></tr></tbody>
                        </table>
                    </div>
                 </div>
            </section>

        </div> <!-- .content-wrapper -->
    </main>
</div> <!-- #app-container -->

<!-- Fullscreen Iframe Container (for Tools and Generators) -->
<div id="fullscreen-iframe-container">
    <div id="fullscreen-iframe-header">
        <span id="fullscreen-iframe-title">Embedded Content</span>
        <button id="close-fullscreen-iframe-btn"><i class="fas fa-times"></i> Close</button>
    </div>
    <div id="fullscreen-iframe-wrapper">
        <iframe id="fullscreen-iframe" src="about:blank" allowfullscreen sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts"></iframe>
    </div>
</div>


<!-- Edit Student Modal -->
<div id="editStudentModal" class="modal"><div class="modal-content modal-lg"><div class="modal-header"><h3><i class="fas fa-user-edit"></i> Edit Student</h3><button class="close-btn" data-modal-id="editStudentModal">Ã—</button></div><div class="modal-body"><form id="edit-student-form" novalidate><input type="hidden" id="edit-student-id"><div class="form-grid"><div class="input-group"><label for="edit-rollNumber">Roll No:</label><input type="text" id="edit-rollNumber" required></div><div class="input-group"><label for="edit-name">Name:</label><input type="text" id="edit-name" required></div><div class="input-group"><label for="edit-class">Class:</label><select id="edit-class" required><option value="" disabled selected>-- Select --</option></select></div><div class="input-group"><label for="edit-mobile">Mobile:</label><input type="tel" id="edit-mobile"></div><div class="input-group"><label for="edit-gmail">Gmail:</label><input type="email" id="edit-gmail"></div><div class="input-group"><label for="edit-password">New Password:</label><input type="text" id="edit-password" placeholder="Leave blank to keep current"></div><div class="input-group"><label for="edit-fatherName">Father:</label><input type="text" id="edit-fatherName"></div><div class="input-group"><label for="edit-motherName">Mother:</label><input type="text" id="edit-motherName"></div><div class="input-group"><label for="edit-address">Address:</label><input type="text" id="edit-address"></div><div class="input-group"><label for="edit-photoURL">Photo URL:</label><input type="url" id="edit-photoURL"></div><div class="input-group"><label for="edit-aadhar">Aadhar:</label><input type="text" id="edit-aadhar"></div><div class="input-group"><label for="edit-gender">Gender:</label><select id="edit-gender"><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div></div></form></div><div class="modal-footer"><div id="edit-student-message" class="message" style="display:none;margin-bottom:10px;"></div><button type="button" class="cancel-btn" data-modal-id="editStudentModal"><i class="fas fa-times"></i> Cancel</button><button type="button" class="save-btn" id="save-student-changes-btn"><i class="fas fa-save"></i> Save Changes</button></div></div></div>

<!-- View Student Details Modal (Enhanced UI) -->
<div id="studentDetailsModal" class="modal"><div class="modal-content modal-xl"><div class="modal-header"><h3 id="student-details-modal-title"><i class="fas fa-user-check"></i> Student Details</h3><button class="close-btn" data-modal-id="studentDetailsModal">Ã—</button></div><div class="modal-body" id="student-details-modal-body"><p class="message info">Loading details...</p></div><div class="modal-footer"><button type="button" class="cancel-btn" data-modal-id="studentDetailsModal"><i class="fas fa-times"></i> Close</button></div></div></div>

<!-- Edit Generic Row Modal -->
<div id="genericEditModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="generic-edit-modal-title"><i class="fas fa-edit"></i> Edit Row</h3><button class="close-btn" data-modal-id="genericEditModal">Ã—</button></div><div class="modal-body"><form id="generic-edit-form" novalidate><input type="hidden" id="generic-edit-sheetname"><input type="hidden" id="generic-edit-rowindex"><div id="generic-edit-form-fields" class="form-grid"><p>Loading...</p></div></form></div><div class="modal-footer"><div id="generic-edit-message" class="message" style="display:none;margin-bottom:10px;"></div><button type="button" class="cancel-btn" data-modal-id="genericEditModal"><i class="fas fa-times"></i> Cancel</button><button type="button" class="save-btn" id="save-generic-changes-btn"><i class="fas fa-save"></i> Save Changes</button></div></div></div>

<!-- Staff Details Modal (Enhanced UI) -->
<div id="staffDetailsModal" class="modal"><div class="modal-content modal-xl"><div class="modal-header"><h3 id="staff-details-modal-title"><i class="fas fa-user-tie"></i> Staff Details</h3><button class="close-btn" data-modal-id="staffDetailsModal">Ã—</button></div><div class="modal-body" id="staff-details-modal-body"><p class="message info">Loading staff details...</p></div><div class="modal-footer" id="staff-details-modal-footer"><div id="add-salary-message" class="message" style="display:none;margin-bottom:10px;"></div><button type="button" class="cancel-btn" data-modal-id="staffDetailsModal"><i class="fas fa-times"></i> Close</button><button type="button" class="save-btn" id="add-salary-payment-btn-modal" style="display:none;"><i class="fas fa-money-check-alt"></i> Save Payment</button></div></div></div>


<script>
    // --- State Variables ---
    let schoolSpreadsheetId = null;
    let studentsData = []; 
    let currentClassStudents = []; 
    let classMapping = {}; 
    let feeTypes = []; 
    let staffListData = [];
    let currentResultConfig = null; 
    let currentStudentForResult = null; 
    let studentsWithResults = new Set(); 
    let currentGenericSheetName = null;
    let currentGenericHeaders = [];
    let currentGenericData = []; 
    let currentView = 'dashboard-view'; 
    const { jsPDF } = window.jspdf;
    let dashboardCharts = {}; 
    let cachedTools = [];
    let cachedGenerators = [];


    // --- DOM Elements ---
    const D = {
         loadingOverlay: document.getElementById('loading-overlay'), loginContainer: document.getElementById('login-container'),
         loginSection: document.getElementById('login-section'), premiumInfoSection: document.getElementById('premium-info-section'),
         appContainer: document.getElementById('app-container'), loginForm: document.getElementById('login-form'),
         mobileInput: document.getElementById('mobile'), passwordInput: document.getElementById('password'), loginButton: document.getElementById('login-btn'),
         loginMessage: document.getElementById('login-message'), premiumBackBtn: document.getElementById('premium-back-btn'),
         sidebar: document.getElementById('sidebar'), sidebarMenu: document.getElementById('sidebar-menu'),
         sidebarToggle: document.getElementById('sidebar-toggle'), sidebarToggleMobile: document.getElementById('sidebar-toggle-mobile'),
         sheetDivider: document.getElementById('sheet-divider'), generatorDivider: document.getElementById('generator-divider'),
         topHeader: document.getElementById('top-header'), mainHeaderTitle: document.getElementById('main-header-title'), 
         userGreeting: document.getElementById('user-greeting'), logoutBtn: document.getElementById('logout-btn'), 
         mainContent: document.getElementById('main-content'), viewSections: document.querySelectorAll('.view-section'), 
         downloadPdfBtn: document.getElementById('download-pdf-btn'),

         dashboardView: document.getElementById('dashboard-view'), dashboardMessage: document.getElementById('dashboard-message'),
         dbTotalStudents: document.getElementById('db-total-students'), dbTotalStaff: document.getElementById('db-total-staff'),
         dbTotalClasses: document.getElementById('db-total-classes'), dbTotalGirls: document.getElementById('db-total-girls'),
         dbTotalBoys: document.getElementById('db-total-boys'), dbTotalPaid: document.getElementById('db-total-paid'),
         dbTotalDue: document.getElementById('db-total-due'), dbTotalExpenses: document.getElementById('db-total-expenses'),
         studentsPerClassChartEl: document.getElementById('studentsPerClassChart'),
         genderSplitPerClassChartEl: document.getElementById('genderSplitPerClassChart'),
         feesCollectedPerClassChartEl: document.getElementById('feesCollectedPerClassChart'),
         duesPerClassChartEl: document.getElementById('duesPerClassChart'),
         attendancePerClassChartEl: document.getElementById('attendancePerClassChart'),

         studentListView: document.getElementById('student-list-view'), 
         studentListMessage: document.getElementById('student-list-message'),
         studentListMainContent: document.getElementById('student-list-main-content'),
         
         editStudentModal: document.getElementById('editStudentModal'), editStudentForm: document.getElementById('edit-student-form'),
         editStudentMessage: document.getElementById('edit-student-message'), saveStudentChangesBtn: document.getElementById('save-student-changes-btn'),
         editClassSelect: document.getElementById('edit-class'),

         studentDetailsModal: document.getElementById('studentDetailsModal'),
         studentDetailsModalTitle: document.getElementById('student-details-modal-title'),
         studentDetailsModalBody: document.getElementById('student-details-modal-body'),

         addResultsView: document.getElementById('add-results-view'),
         step1ResultDetails: document.getElementById('step1-result-details'), step2SelectStudent: document.getElementById('step2-select-student'),
         step3EnterMarks: document.getElementById('step3-enter-marks'), resultNameInput: document.getElementById('result-name'),
         schoolNameInput: document.getElementById('school-name'), teacherNameInput: document.getElementById('teacher-name'),
         resultClassSelect: document.getElementById('result-class'), subjectsContainer: document.getElementById('subjects-container'),
         addSubjectBtn: document.getElementById('add-subject-btn'), nextToStep2Btn: document.getElementById('next-to-step2-btn'),
         backToStep1Btn: document.getElementById('back-to-step1-btn'), backToStep2Btn: document.getElementById('back-to-step2-btn'),
         submitMarksBtn: document.getElementById('submit-marks-btn'), resultsStudentList: document.getElementById('results-student-list'),
         selectedClassInfo: document.getElementById('selected-class-info'), selectedStudentInfo: document.getElementById('selected-student-info'),
         marksEntryContainer: document.getElementById('marks-entry-container'), marksEntryForm: document.getElementById('marks-entry-form'),
         marksEntryMessage: document.getElementById('marks-entry-message'), addResultsMessage: document.getElementById('add-results-message'),

         genericSheetView: document.getElementById('generic-sheet-view'),
         genericSheetMessage: document.getElementById('generic-sheet-message'), genericTableContainer: document.getElementById('generic-table-container'),
         genericDataTable: document.getElementById('generic-data-table'), genericTableHeaderRow: document.getElementById('generic-table-header-row'),
         genericTableBody: document.getElementById('generic-table-body'), genericViewTitle: document.getElementById('generic-view-title'),
         downloadSheetJsonBtn: document.getElementById('download-sheet-json-btn'),

         genericEditModal: document.getElementById('genericEditModal'),
         genericEditModalTitle: document.getElementById('generic-edit-modal-title'), genericEditForm: document.getElementById('generic-edit-form'),
         genericEditFormFields: document.getElementById('generic-edit-form-fields'), genericEditMessage: document.getElementById('generic-edit-message'),
         saveGenericChangesBtn: document.getElementById('save-generic-changes-btn'), genericEditSheetNameInput: document.getElementById('generic-edit-sheetname'),
         genericEditRowIndexInput: document.getElementById('generic-edit-rowindex'),
        
        toolsView: document.getElementById('tools-view'), toolsViewContent: document.getElementById('tools-view-content'),
        toolsMessage: document.getElementById('tools-message'),
        
        fullscreenIframeContainer: document.getElementById('fullscreen-iframe-container'), 
        fullscreenIframeEl: document.getElementById('fullscreen-iframe'),
        fullscreenIframeTitle: document.getElementById('fullscreen-iframe-title'), 
        closeFullscreenIframeBtn: document.getElementById('close-fullscreen-iframe-btn'),

        addFeesView: document.getElementById('add-fees-view'), addFeesForm: document.getElementById('add-fees-form'),
        feeClassSelect: document.getElementById('fee-class-select'), feeTypeSelect: document.getElementById('fee-type-select'),
        feeAmountInput: document.getElementById('fee-amount'), feeMonthYearInput: document.getElementById('fee-month-year'),
        feeDueDateInput: document.getElementById('fee-due-date'), feeAcademicYearInput: document.getElementById('fee-academic-year'),
        addFeesMessage: document.getElementById('add-fees-message'),

        staffListView: document.getElementById('staff-list-view'), staffListMessage: document.getElementById('staff-list-message'),
        staffTableBody: document.getElementById('staff-table-body'),

        staffDetailsModal: document.getElementById('staffDetailsModal'), staffDetailsModalTitle: document.getElementById('staff-details-modal-title'),
        staffDetailsModalBody: document.getElementById('staff-details-modal-body'), staffDetailsModalFooter: document.getElementById('staff-details-modal-footer'),
        addSalaryMessage: document.getElementById('add-salary-message'), addSalaryPaymentBtnModal: document.getElementById('add-salary-payment-btn-modal')
    };

    // --- Utility Functions (Mostly Unchanged) ---
    const showLoading = () => D.loadingOverlay.classList.add('show');
    const hideLoading = () => D.loadingOverlay.classList.remove('show');
    function showMessage(el, txt, type = 'error', autoHide = true) { if (!el) return; const icon = type==='error'?'fa-times-circle':type==='success'?'fa-check-circle':type==='warning'?'fa-exclamation-triangle':'fa-info-circle'; el.innerHTML = `<i class="fas ${icon} fa-message-icon"></i> ${txt}`; el.className = `message ${type}`; el.style.display = 'flex'; if (autoHide && type === 'success') setTimeout(() => hideMessage(el), 4000); }
    function hideMessage(el) { if (!el) return; el.style.display = 'none'; el.innerHTML = ''; el.className = 'message'; }
    const sanitizeHTML = str => { const tmp=document.createElement('div'); tmp.textContent=str||''; return tmp.innerHTML; };
    function openModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.style.display = 'block'; }
    function closeModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.style.display = 'none'; }
    function getStudentPhotoHtml(url, className = 'student-photo', placeholderIcon = 'fa-user') { const ph = `<div class="${className}-placeholder"><i class="fas ${placeholderIcon}"></i></div>`; if (!url || typeof url !== 'string' || !url.trim()) return ph; try { new URL(url); return `<img src="${sanitizeHTML(url)}" alt="Photo" class="${className}" onerror="this.outerHTML = '${ph.replace(/"/g, '\\"')}';">`; } catch (_) { return ph; } }
    function getCurrentMonthYear() { const now = new Date(); return now.toLocaleString('default', { month: 'long', year: 'numeric' });}
    function getCurrentAcademicYear() {const date=new Date(),year=date.getFullYear(),month=date.getMonth()+1;return month>=4?`${year}-${String(year+1).slice(-2)}`:`${year-1}-${String(year).slice(-2)}`;}
    function formatDateForInput(date) { if(!date) return ''; try {const d=new Date(date); return d.toISOString().split('T')[0];} catch(e){return '';} }
    function formatDisplayDate(dateString) { if (!dateString) return 'N/A'; try { const date = new Date(dateString); if (isNaN(date)) return dateString; return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }); } catch (e) { return dateString; } }
    function formatCurrency(amount) { return parseFloat(amount || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits:2 }); } // Adjusted for INR style and optional decimal for paisa

    // --- API Call Function (Unchanged) ---
    async function callBackendApi(action, payload = {}) { showLoading(); const endpoint = `/api/${action}`; if (schoolSpreadsheetId && action !== 'login') payload.spreadsheetId = schoolSpreadsheetId; try { const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!res.ok) { let eTxt = `HTTP ${res.status}`; let resultError = 'Request failed'; try { const errorJson = await res.json(); resultError = errorJson.error || errorJson.message || JSON.stringify(errorJson); eTxt += ` - ${resultError}`; } catch (parseError) { try { eTxt += ` - ${(await res.text()).substring(0, 200)}`; } catch(readError){} } throw new Error(eTxt); } const result = await res.json(); hideLoading(); if (result.success === false && result.errorType === 'AUTH_ERROR') { showLoginView(); showMessage(D.loginMessage, result.error || "Authentication failed. Please log in again.", 'error'); return { success: false, error: "Authentication failed." }; } return result; } catch (err) { console.error(`API Error (${action}):`, err); hideLoading(); const isAutoLoggedIn = localStorage.getItem('schoolSpreadsheetId'); if (isAutoLoggedIn && action !== 'login') { showMessage(D.loginMessage, `Session may have expired. Please log in again. (${err.message})`, 'error'); showLoginView(); } else { let msgEl = D.loginMessage; if (D.appContainer.classList.contains('visible')) { const modal = document.querySelector('.modal[style*="display: block"]'); if (modal) msgEl = modal.querySelector('.message[id$="-message"]'); else msgEl = document.getElementById(`${currentView.replace(/-/g, '')}-message`) || D.studentListMessage || D.genericSheetMessage || D.addResultsMessage || D.toolsMessage || D.dashboardMessage || D.staffListMessage || D.addFeesMessage; } showMessage(msgEl || D.loginMessage, `Network/Server Error: ${err.message}`, 'error'); } return { success: false, error: err.message }; } }

    // --- Auth & View Management (Login & Show App adjusted slightly) ---
    function showLoginView() { D.loginContainer.classList.remove('hidden'); D.appContainer.classList.remove('visible'); D.loginSection.style.display='block'; D.premiumInfoSection.style.display='none'; D.loginForm.reset(); hideMessage(D.loginMessage); D.loginButton.classList.remove('processing'); schoolSpreadsheetId = null; studentsData = []; classMapping = {}; feeTypes = []; staffListData = []; cachedTools = []; cachedGenerators = []; currentResultConfig = null; currentStudentForResult = null; studentsWithResults.clear(); currentGenericHeaders=[]; currentGenericData=[]; clearDynamicMenuItems(); Object.values(dashboardCharts).forEach(chart => chart?.destroy()); dashboardCharts = {}; localStorage.removeItem('schoolSpreadsheetId'); localStorage.removeItem('userMobile'); D.userGreeting.textContent = ''; }
    async function showAppView() { D.loginContainer.classList.add('hidden'); D.appContainer.classList.add('visible'); const storedMobile = localStorage.getItem('userMobile'); if (storedMobile) D.userGreeting.textContent = `Welcome, ${sanitizeHTML(storedMobile)}`; else D.userGreeting.textContent = ''; if (schoolSpreadsheetId) { await loadInitialAppData(); switchView('dashboard-view', 'Dashboard', 'nav-dashboard'); } else if (localStorage.getItem('schoolSpreadsheetId')) { schoolSpreadsheetId = localStorage.getItem('schoolSpreadsheetId'); await loadInitialAppData(); switchView('dashboard-view', 'Dashboard', 'nav-dashboard'); } else { showLoginView(); } }
    function showPremiumView() { D.loginSection.style.display='none'; D.premiumInfoSection.style.display='block'; }
    D.loginForm.addEventListener('submit', async (e) => { e.preventDefault(); hideMessage(D.loginMessage); const m = D.mobileInput.value.trim(), p = D.passwordInput.value.trim(); if (!m || !p) { showMessage(D.loginMessage, 'Mobile and password are required.', 'warning'); return; } D.loginButton.classList.add('processing'); D.loginButton.disabled = true; showLoading(); try { const res = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mobile: m, password: p }) }); const r = await res.json(); hideLoading(); D.loginButton.classList.remove('processing'); D.loginButton.disabled = false; if (res.ok && r?.success && r.spreadsheetId) { schoolSpreadsheetId = r.spreadsheetId; localStorage.setItem('schoolSpreadsheetId', schoolSpreadsheetId); localStorage.setItem('userMobile', m); showAppView(); } else if (res.ok && r?.reason === 'not_premium') { showPremiumView(); } else { showMessage(D.loginMessage, r?.message || r?.error || 'Login failed. Check credentials.', 'error'); localStorage.removeItem('schoolSpreadsheetId'); localStorage.removeItem('userMobile'); } } catch (err) { hideLoading(); D.loginButton.classList.remove('processing'); D.loginButton.disabled = false; console.error("Login fetch error:", err); showMessage(D.loginMessage, `Login Error: ${err.message}`, 'error'); localStorage.removeItem('schoolSpreadsheetId'); localStorage.removeItem('userMobile'); } });
    D.premiumBackBtn.addEventListener('click', () => { D.premiumInfoSection.style.display='none'; D.loginSection.style.display='block'; D.loginForm.reset(); hideMessage(D.loginMessage); });
    D.logoutBtn.addEventListener('click', () => { if(confirm("Are you sure you want to logout?")) showLoginView(); });
    function toggleSidebar() { D.sidebar.classList.toggle('collapsed'); }
    D.sidebarToggle.addEventListener('click', toggleSidebar); D.sidebarToggleMobile.addEventListener('click', () => D.sidebar.classList.toggle('open'));
    D.mainContent.addEventListener('click', () => { if (window.innerWidth <= 768 && D.sidebar.classList.contains('open')) D.sidebar.classList.remove('open'); });
    function setActiveMenuItem(navId) { D.sidebarMenu.querySelectorAll('li').forEach(li => li.classList.remove('active')); const item = document.getElementById(navId); if(item) item.classList.add('active'); }
    
    function switchView(viewId, title, navId) {
        D.viewSections.forEach(s => s.classList.remove('active'));
        const target = document.getElementById(viewId);
        if (target) {
            target.classList.add('active'); currentView = viewId;
            D.mainHeaderTitle.textContent = title || 'School System';
            if (navId) setActiveMenuItem(navId);
            if (viewId === 'dashboard-view') loadDashboardData();
            else if (viewId === 'student-list-view' && studentsData.length > 0) displayClassTiles(); 
            else if (viewId === 'student-list-view') loadStudentsAndClasses(); 
            else if (viewId === 'tools-view') loadTools(); // Load cards for tools view
            else if (viewId === 'add-fees-view') prepareAddFeesForm();
            else if (viewId === 'staff-list-view') loadStaffList();
        } else console.error(`View "${viewId}" not found.`);
        updatePdfButtonVisibility(viewId);
        if (window.innerWidth <= 768 && D.sidebar.classList.contains('open')) D.sidebar.classList.remove('open');
    }
    D.sidebarMenu.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (link) {
            const viewId = link.dataset.view;
            const sheetName = link.dataset.sheetName; 
            const iframeUrl = link.dataset.iframeUrl;
            const iframeName = link.dataset.iframeName;
            const navId = link.closest('li').id;
            let title = link.querySelector('.menu-text')?.textContent || 'View';

            if (iframeUrl) { // Handle direct iframe openers (like generators)
                e.preventDefault();
                openFullscreenIframe(iframeName || title, iframeUrl);
                if (navId) setActiveMenuItem(navId); // Keep it active
            } else if (viewId) { // Handle regular view switching
                e.preventDefault();
                switchView(viewId, title, navId);
                if (viewId === 'generic-sheet-view' && sheetName) loadGenericSheetData(sheetName);
            }
        }
    });

    async function loadInitialAppData() { 
        if (!schoolSpreadsheetId) { console.error("No Spreadsheet ID for initial app data."); showLoginView(); return; }
        showLoading();
        await Promise.all([
            loadStudentsAndClasses(false), 
            loadSheetNames(false),        
            loadFeeTypes(false),
            loadToolsAndGenerators(false) // Fetch both tools.json and generator.json
        ]).catch(err => {
            console.error("Error during initial data load batch:", err);
            showMessage(D.dashboardMessage || D.loginMessage, `Failed to load critical school data: ${err.message}`, 'error');
        });
        
        clearDynamicMenuItems(); 
        populateDynamicSidebarItems(); // Centralized function for sheets, tools, generators
        
        populateClassDropdowns(); 
        hideLoading();
    }
    
    let cachedSheetNames = []; // (Unchanged)
    async function loadSheetNames(showMsg = true) { if (!schoolSpreadsheetId) return; if(showMsg && (D.genericSheetMessage || D.dashboardMessage)) showMessage(D.genericSheetMessage || D.dashboardMessage, 'Loading sheet list...', 'info'); const result = await callBackendApi('getSheetNames', {}); if (result?.success && result.data) { cachedSheetNames = result.data; if (showMsg) populateDynamicSidebarItems(); } else { console.error("Failed to load sheet names:", result?.error); if(showMsg && (D.genericSheetMessage || D.dashboardMessage)) showMessage(D.genericSheetMessage || D.dashboardMessage, `Error loading sheet list: ${result?.error}`, 'error'); } }
    
    async function loadToolsAndGenerators(showMsg = true) {
        // Load Tools
        try {
            const resTools = await fetch('./tools.json');
            if (resTools.ok) cachedTools = await resTools.json();
            else console.warn("tools.json not found or not accessible.");
        } catch (e) { console.warn("Error fetching tools.json", e); cachedTools = []; }

        // Load Generators
        try {
            const resGens = await fetch('./generator.json');
            if (resGens.ok) cachedGenerators = await resGens.json();
            else console.warn("generator.json not found or not accessible.");
        } catch (e) { console.warn("Error fetching generator.json", e); cachedGenerators = [];}
        
        if(showMsg) populateDynamicSidebarItems(); // If called directly and expected to update UI
    }

    function clearDynamicMenuItems() { 
        D.sidebarMenu.querySelectorAll('.dynamic-sheet-item, .dynamic-generator-item').forEach(item => item.remove()); 
        D.sheetDivider.style.display = 'none'; 
        D.generatorDivider.style.display = 'none';
    }
    function populateDynamicSidebarItems() {
        clearDynamicMenuItems();
        const frag = document.createDocumentFragment();
        let sheetsAdded = false;
        let generatorsAdded = false;
        const dedicatedSheets = ['students', 'classes', 'staff', 'studentsfees', 'feetypes', 'staffsalarypayments', 'results', 'attendance', 'expenses', 'results1129']; // Lowercase, no spaces

        // Populate Generators first (if any)
        if (cachedGenerators && cachedGenerators.length > 0) {
            cachedGenerators.forEach(gen => {
                const li = document.createElement('li');
                li.className = 'dynamic-generator-item'; // Specific class
                li.id = `nav-generator-${sanitizeHTML(gen.name.replace(/[^a-zA-Z0-9]/g, '-'))}`;
                li.innerHTML = `<a data-iframe-url="${sanitizeHTML(gen.url)}" data-iframe-name="${sanitizeHTML(gen.name)}">
                                <i class="fas fa-cogs"></i> <!-- Or use gen.icon if provided in JSON -->
                                <span class="menu-text">${sanitizeHTML(gen.name)}</span>
                              </a>`;
                frag.appendChild(li);
                generatorsAdded = true;
            });
            if(generatorsAdded) D.generatorDivider.style.display = 'block';
        }
        D.generatorDivider.after(...Array.from(frag.childNodes)); // Insert after generator divider
        
        // Populate Other Sheets
        const sheetFrag = document.createDocumentFragment();
        cachedSheetNames.forEach(name => {
            const lowerName = name.toLowerCase().replace(/\s+/g, '');
            if (dedicatedSheets.some(ds => lowerName.includes(ds))) return; // Skip dedicated
            const li = document.createElement('li');
            li.className = 'dynamic-sheet-item';
            li.id = `nav-sheet-${sanitizeHTML(name.replace(/[^a-zA-Z0-9]/g, '-'))}`;
            li.innerHTML = `<a data-view="generic-sheet-view" data-sheet-name="${sanitizeHTML(name)}"><i class="far fa-file-alt"></i><span class="menu-text">${sanitizeHTML(name)}</span></a>`;
            sheetFrag.appendChild(li);
            sheetsAdded = true;
        });
        if (sheetsAdded) { D.sheetDivider.style.display = 'block'; D.sidebarMenu.appendChild(sheetFrag);  }
    }

    // --- Students Management (Enhanced UI remains mostly the same JS, but CSS changes modal appearance) ---
    async function loadStudentsAndClasses(showMsg = true) { if (!schoolSpreadsheetId) return; if(showMsg && D.studentListMessage) showMessage(D.studentListMessage, 'Loading student and class data...', 'info'); const result = await callBackendApi('getStudents', {}); if (result?.success && result.data) { if(showMsg && D.studentListMessage) hideMessage(D.studentListMessage); studentsData = result.data.students || []; classMapping = result.data.classes || {}; if(currentView === 'student-list-view' || document.getElementById('student-list-view').classList.contains('active')){ displayClassTiles(); } populateClassDropdowns(); } else { if(showMsg && D.studentListMessage) showMessage(D.studentListMessage, result?.error || 'Failed to load students data.', 'error'); } }
    function displayClassTiles() { D.studentListMainContent.innerHTML = ''; const classListContainer = document.createElement('div'); classListContainer.id = 'student-classes-list'; if (Object.keys(classMapping).length === 0) { classListContainer.innerHTML = `<p class="message warning">No classes found.</p>`; } else { const sortedClassIds = Object.keys(classMapping).sort((a,b) => (classMapping[a].displayName.localeCompare(classMapping[b].displayName))); sortedClassIds.forEach(classId => { const classInfo = classMapping[classId]; const tile = document.createElement('div'); tile.className = 'class-tile'; tile.dataset.classId = classId; tile.innerHTML = `<i class="fas fa-chalkboard"></i><h4>${sanitizeHTML(classInfo.displayName)}</h4><p>${studentsData.filter(s => s.Class === classId).length} Students</p>`; tile.addEventListener('click', () => displayStudentsForClass(classId)); classListContainer.appendChild(tile); }); } D.studentListMainContent.appendChild(classListContainer); updatePdfButtonVisibility(currentView); D.studentListMainContent.dataset.currentClassId = ''; }
    function displayStudentsForClass(classId) { D.studentListMainContent.innerHTML = ''; currentClassStudents = studentsData.filter(s => String(s.Class || '').trim() === classId); D.studentListMainContent.dataset.currentClassId = classId; const headerDiv = document.createElement('div'); headerDiv.style.display = 'flex'; headerDiv.style.justifyContent = 'space-between'; headerDiv.style.alignItems = 'center'; headerDiv.style.marginBottom = '20px'; const backButton = document.createElement('button'); backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Classes'; backButton.className = 'btn cancel-btn back-to-classes-btn'; backButton.addEventListener('click', displayClassTiles); headerDiv.appendChild(backButton); const classTitle = document.createElement('h3'); classTitle.style.textAlign = 'right'; classTitle.style.flexGrow = '1'; classTitle.textContent = `${sanitizeHTML(classMapping[classId]?.displayName || classId)} - Student List`; headerDiv.appendChild(classTitle); D.studentListMainContent.appendChild(headerDiv); const tableContainer = document.createElement('div'); tableContainer.className = 'student-table-container data-table-container'; const table = document.createElement('table'); table.className = 'student-table data-table'; table.innerHTML = `<thead><tr><th>Photo</th><th>Roll No</th><th>Name</th><th>Mobile</th><th>Father's Name</th><th>Actions</th></tr></thead><tbody id="current-class-student-table-body"></tbody>`; tableContainer.appendChild(table); D.studentListMainContent.appendChild(tableContainer); const tbody = document.getElementById('current-class-student-table-body'); tbody.innerHTML = ''; if (currentClassStudents.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:30px;color:#888;">No students in this class.</td></tr>`; } else { const frag = document.createDocumentFragment(); currentClassStudents.sort((a, b) => (a.RollNumber || '').localeCompare(b.RollNumber || '', undefined, {numeric:true}) || (a.Name || '').localeCompare(b.Name || '') ).forEach(s => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${getStudentPhotoHtml(s.PhotoURL,'student-photo')}</td><td>${sanitizeHTML(s.RollNumber||'N/A')}</td><td>${sanitizeHTML(s.Name||'N/A')}</td><td>${sanitizeHTML(s.Mobile||'N/A')}</td><td>${sanitizeHTML(s.FatherName||'N/A')}</td><td class="action-col"><i class="fas fa-eye view-btn" title="View Details" data-studentid="${sanitizeHTML(s.StudentID)}"></i> <i class="fas fa-edit edit-btn" title="Edit Student" data-studentid="${sanitizeHTML(s.StudentID)}"></i> <i class="fas fa-trash-alt delete-btn" title="Delete Student" data-studentid="${sanitizeHTML(s.StudentID)}" data-studentname="${sanitizeHTML(s.Name || 'this student')}"></i></td>`; frag.appendChild(tr); }); tbody.appendChild(frag); } updatePdfButtonVisibility(currentView); }
    D.studentListMainContent.addEventListener('click', async (e) => { if (e.target?.classList.contains('edit-btn')) { const id = e.target.dataset.studentid; if (id) openEditStudentModal(id); } if (e.target?.classList.contains('delete-btn')) { const id = e.target.dataset.studentid; const name = e.target.dataset.studentname; if (id) handleDeleteStudent(id, name); } if (e.target?.classList.contains('view-btn')) { const id = e.target.dataset.studentid; if (id) openStudentDetailsModal(id); } });
    function populateClassDropdowns() { const createOption = (val, txt) => { const opt = document.createElement('option'); opt.value = val; opt.textContent = txt; return opt; }; const selectors = [D.editClassSelect, D.resultClassSelect, D.feeClassSelect]; selectors.forEach(sel => { if(sel) { const currentVal = sel.value; sel.innerHTML = '<option value="" disabled selected>-- Select Class --</option>'; const sortedClassIds = Object.keys(classMapping).sort((a,b) => (classMapping[a].displayName.localeCompare(classMapping[b].displayName))); sortedClassIds.forEach(classId => { sel.appendChild(createOption(classId, classMapping[classId].displayName)); }); if(currentVal) sel.value = currentVal; } }); }
    function openEditStudentModal(studentId) { hideMessage(D.editStudentMessage); const student = studentsData.find(s => String(s.StudentID) === String(studentId)); if (!student) { console.error("Student not found:", studentId); showMessage(D.studentListMessage || D.dashboardMessage, 'Student details not found.', 'error'); return; } D.editStudentForm.reset(); document.getElementById('edit-student-id').value=student.StudentID; document.getElementById('edit-rollNumber').value=student.RollNumber||''; document.getElementById('edit-name').value=student.Name||''; D.editClassSelect.value=student.Class||''; document.getElementById('edit-mobile').value=student.Mobile||''; document.getElementById('edit-gmail').value=student.Gmail||''; document.getElementById('edit-password').value=''; document.getElementById('edit-fatherName').value=student.FatherName||''; document.getElementById('edit-motherName').value=student.MotherName||''; document.getElementById('edit-address').value=student.Address||''; document.getElementById('edit-photoURL').value=student.PhotoURL||''; document.getElementById('edit-aadhar').value=student.Aadhar||''; document.getElementById('edit-gender').value=student.Gender||'Male'; openModal('editStudentModal'); }
    D.saveStudentChangesBtn.addEventListener('click', async () => { hideMessage(D.editStudentMessage); const nameIn = document.getElementById('edit-name').value.trim(); const rollIn = document.getElementById('edit-rollNumber').value.trim(); const classIdIn = D.editClassSelect.value; if(!nameIn||!rollIn||!classIdIn){showMessage(D.editStudentMessage,'Roll Number, Name, and Class are required.','error');return;} const studentId = document.getElementById('edit-student-id').value; const studentPayload = { StudentID: studentId, RollNumber: rollIn, Name: nameIn, Class: classIdIn, Mobile: document.getElementById('edit-mobile').value.trim(), Gmail: document.getElementById('edit-gmail').value.trim(), Password: document.getElementById('edit-password').value.trim() || undefined, FatherName: document.getElementById('edit-fatherName').value.trim(), MotherName: document.getElementById('edit-motherName').value.trim(), Address: document.getElementById('edit-address').value.trim(), PhotoURL: document.getElementById('edit-photoURL').value.trim(), Aadhar: document.getElementById('edit-aadhar').value.trim(), Gender: document.getElementById('edit-gender').value }; if(studentPayload.Password === undefined) delete studentPayload.Password; const result = await callBackendApi('editStudent',{ studentData: studentPayload }); if(result?.success){ showMessage(D.editStudentMessage,result.message||'Student updated successfully!','success'); await loadStudentsAndClasses(false); const displayedClassId = D.studentListMainContent.dataset.currentClassId; if(displayedClassId) displayStudentsForClass(displayedClassId); else displayClassTiles(); setTimeout(()=>closeModal('editStudentModal'),1500); } else { showMessage(D.editStudentMessage,result?.error||'Update failed. Try again.','error'); } });
    async function handleDeleteStudent(studentId, studentName) { if (!confirm(`Delete ${studentName} (ID: ${studentId})? This is permanent.`)) return; const result = await callBackendApi('deleteStudent', { studentId }); if (result?.success) { showMessage(D.studentListMessage || D.dashboardMessage, result.message || 'Student deleted.', 'success'); await loadStudentsAndClasses(false); const displayedClassId = D.studentListMainContent.dataset.currentClassId; if(displayedClassId) displayStudentsForClass(displayedClassId); else displayClassTiles(); } else { showMessage(D.studentListMessage || D.dashboardMessage, result?.error || 'Failed to delete student.', 'error'); } }
    // Enhanced Student Details Modal JS
    async function openStudentDetailsModal(studentId) {
        D.studentDetailsModalBody.innerHTML = '<p class="message info">Loading student details...</p>';
        openModal('studentDetailsModal');
        const result = await callBackendApi('getStudentFullDetails', { studentId });
        if (result?.success && result.data) {
            const S = result.data; 
            D.studentDetailsModalTitle.innerHTML = `<i class="fas fa-user-check"></i> Profile: ${sanitizeHTML(S.Name || 'Student')}`;

            let feeDetailsHtml = '<h4><i class="fas fa-coins"></i> Fee Records</h4>';
            if (S.fees) {
                feeDetailsHtml += `<div class="fees-summary">Total Due: <strong>${formatCurrency(S.fees.totalDue)}</strong> &nbsp;&nbsp;|&nbsp;&nbsp; Total Paid: <strong>${formatCurrency(S.fees.totalPaid)}</strong></div><div class="details-list">`;
                if (S.fees.due?.length > 0) {
                    S.fees.due.forEach(f => {
                        feeDetailsHtml += `<div class="list-item" data-fee-record-id="${sanitizeHTML(f.FeeRecordID)}">
                            <span>${sanitizeHTML(f.FeeTypeName || f.FeeTypeID)} (${formatDisplayDate(f.DueDate)}): <strong class="status-due">${formatCurrency(f.Amount)}</strong> - ${sanitizeHTML(f.Status)}</span>
                            <button class="mark-paid-btn" data-student-id="${sanitizeHTML(S.StudentID)}"><i class="fas fa-check-circle"></i> Mark Paid</button>
                        </div>`;
                    });
                } else { feeDetailsHtml += '<p style="text-align:center; color:#777; margin-top:10px;">No outstanding due fees.</p>'; }
                feeDetailsHtml += '</div><h5 style="margin-top:15px; font-size:1rem; color:#555;">Paid History:</h5><div class="details-list">';
                if (S.fees.paid?.length > 0) {
                    S.fees.paid.forEach(f => {
                        feeDetailsHtml += `<div class="list-item"><span>${sanitizeHTML(f.FeeTypeName || f.FeeTypeID)} (${formatDisplayDate(f.PaidDate)}): <strong class="status-paid">${formatCurrency(f.Amount)}</strong></span></div>`;
                    });
                } else { feeDetailsHtml += '<p style="text-align:center; color:#777; margin-top:10px;">No paid fee records.</p>'; }
                 feeDetailsHtml += '</div>';

                if (Object.keys(S.fees.byMonth || {}).length > 0) {
                     feeDetailsHtml += '<h5 style="margin-top:15px; font-size:1rem; color:#555;">Fees Paid (Monthly Summary):</h5><div class="details-list">';
                     for (const month in S.fees.byMonth) {
                         feeDetailsHtml += `<div class="list-item"><span>${sanitizeHTML(month)}: <strong>${formatCurrency(S.fees.byMonth[month])}</strong></span></div>`;
                     }
                     feeDetailsHtml += '</div>';
                 }
            } else { feeDetailsHtml += '<p>Fee data not available.</p>'; }

            let attendanceDetailsHtml = '<h4><i class="fas fa-user-clock"></i> Attendance Records</h4>';
            if (S.attendance) {
                attendanceDetailsHtml += `<div class="attendance-summary">Total Present: <strong>${S.attendance.totalPresent}</strong> &nbsp;&nbsp;|&nbsp;&nbsp; Total Absent: <strong>${S.attendance.totalAbsent}</strong> (out of ${S.attendance.totalSchoolDaysForStudent} school days)</div><div class="details-list">`;
                if (Object.keys(S.attendance.byMonth || {}).length > 0) {
                     for (const month in S.attendance.byMonth) {
                         const monthData = S.attendance.byMonth[month];
                         const percentage = monthData.schoolDays > 0 ? ((monthData.present / monthData.schoolDays) * 100).toFixed(1) : 0;
                         attendanceDetailsHtml += `<div class="list-item"><span>${sanitizeHTML(month)}: ${monthData.present}P, ${monthData.absent}A (${percentage}%)</span></div>`;
                     }
                } else if(S.attendance.records?.length > 0){
                    attendanceDetailsHtml += '<p style="font-size:0.9em; color:#666;">Showing recent individual records (up to 10):</p>';
                     S.attendance.records.slice(-10).reverse().forEach(att => { 
                         attendanceDetailsHtml += `<div class="list-item"><span>${formatDisplayDate(att.Date)}: <strong>${sanitizeHTML(att.Status)}</strong></span></div>`;
                     });
                } else { attendanceDetailsHtml += '<p style="text-align:center; color:#777; margin-top:10px;">No attendance records found.</p>'; }
                attendanceDetailsHtml += '</div>';
            } else { attendanceDetailsHtml += '<p>Attendance data not available.</p>'; }

            D.studentDetailsModalBody.innerHTML = `
                <div class="profile-grid">
                    <div class="profile-sidebar">
                        <div class="profile-photo-container">${getStudentPhotoHtml(S.PhotoURL, 'profile-photo')}</div>
                        <h3 class="profile-name">${sanitizeHTML(S.Name)}</h3>
                        <p class="profile-meta"><i class="fas fa-id-badge"></i> ID: ${sanitizeHTML(S.StudentID)}</p>
                        <p class="profile-meta"><i class="fas fa-chalkboard"></i> Class: ${sanitizeHTML(S.ClassNameWithSection || S.Class)}</p>
                        <p class="profile-meta"><i class="fas fa-list-ol"></i> Roll: ${sanitizeHTML(S.RollNumber || 'N/A')}</p>
                        <p class="profile-meta"><i class="fas fa-venus-mars"></i> Gender: ${sanitizeHTML(S.Gender || 'N/A')}</p>
                        <p class="profile-meta"><i class="fas fa-calendar-alt"></i> Reg. Date: ${formatDisplayDate(S.RegistrationDate)}</p>
                    </div>
                    <div class="profile-main-content">
                        <div class="details-section">
                            <h4><i class="fas fa-user-friends"></i> Family & Contact</h4>
                            <div class="info-grid">
                                <p><strong>Father:</strong> ${sanitizeHTML(S.FatherName)}</p>
                                <p><strong>Mother:</strong> ${sanitizeHTML(S.MotherName)}</p>
                                <p><strong>Mobile:</strong> ${sanitizeHTML(S.Mobile)}</p>
                                <p><strong>Gmail:</strong> ${sanitizeHTML(S.Gmail)}</p>
                                <p><strong>Address:</strong> ${sanitizeHTML(S.Address)}</p>
                                <p><strong>Aadhar:</strong> ${sanitizeHTML(S.Aadhar)}</p>
                            </div>
                        </div>
                        <div class="details-section fees-section">${feeDetailsHtml}</div>
                        <div class="details-section attendance-section">${attendanceDetailsHtml}</div>
                    </div>
                </div>
            `;
        } else { D.studentDetailsModalBody.innerHTML = `<p class="message error">${result?.error || 'Failed to load student details.'}</p>`; }
    }
    D.studentDetailsModalBody.addEventListener('click', async (e) => { if (e.target.classList.contains('mark-paid-btn') || e.target.closest('.mark-paid-btn')) { const button = e.target.closest('.mark-paid-btn'); const feeRecordId = button.closest('.list-item').dataset.feeRecordId; const studentId = button.dataset.studentId; if (!feeRecordId || !studentId) { showMessage(D.studentDetailsModalBody.querySelector('.fees-section .message') || D.studentDetailsModalBody, "Error: Fee Record ID missing.", "error", false); return; } const paidDate = prompt("Enter Paid Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]); if (paidDate) { try { new Date(paidDate).toISOString(); } catch { alert("Invalid date format!"); return; } const result = await callBackendApi('updateStudentFeeStatus', { feeRecordId, newStatus: 'Paid', paidDate }); if (result?.success) { const feeMsgContainer = D.studentDetailsModalBody.querySelector('.fees-section'); const tempMsg = document.createElement('div'); feeMsgContainer.prepend(tempMsg); showMessage(tempMsg, result.message || 'Fee status updated.', 'success', true); openStudentDetailsModal(studentId); } else { showMessage(D.studentDetailsModalBody.querySelector('.fees-section'), result?.error || 'Failed to update.', 'error', false); } } } });


    // --- Add Results View JS (Unchanged) ---
    function resetAddResultsForm() { D.resultNameInput.value='';D.schoolNameInput.value='';D.teacherNameInput.value='';D.resultClassSelect.value='';D.subjectsContainer.innerHTML=`<label>Subjects:</label><div class="subject-entry"><input type="text" class="subject-name"><input type="number" class="total-marks marks-input" placeholder="Total" min="1" value="100"><input type="number" class="pass-marks marks-input" placeholder="Pass" min="0" value="30"><button type="button" class="remove-subject-btn" onclick="removeSubject(this)" style="visibility:hidden;"><i class="fas fa-times-circle"></i></button></div>`;D.resultsStudentList.innerHTML='';D.marksEntryForm.innerHTML='';currentResultConfig=null;currentStudentForResult=null;studentsWithResults.clear();hideMessage(D.addResultsMessage);hideMessage(D.marksEntryMessage);showStep(1);}
    function showStep(step){D.step1ResultDetails.style.display=step===1?'block':'none';D.step2SelectStudent.style.display=step===2?'block':'none';D.step3EnterMarks.style.display=step===3?'block':'none';if(step!==3)currentStudentForResult=null;if(step===2)D.resultsStudentList.querySelectorAll('.selected').forEach(i=>i.classList.remove('selected'));if(step===1 && D.addResultsView.classList.contains('active'))resetAddResultsForm();} 
    D.addSubjectBtn.addEventListener('click', () => { const e=document.createElement('div');e.className='subject-entry';e.innerHTML=`<input type="text" class="subject-name"><input type="number" class="total-marks marks-input" placeholder="Total" min="1" value="100"><input type="number" class="pass-marks marks-input" placeholder="Pass" min="0" value="30"><button type="button" class="remove-subject-btn" onclick="removeSubject(this)"><i class="fas fa-times-circle"></i></button>`;const b=D.subjectsContainer.querySelector('.remove-subject-btn');if(b)b.style.visibility='visible';D.subjectsContainer.appendChild(e);e.querySelector('.subject-name').focus();});
    function removeSubject(btn){ const c=D.subjectsContainer,e=c.querySelectorAll('.subject-entry');if(e.length>1){btn.closest('.subject-entry').remove();if(c.querySelectorAll('.subject-entry').length===1){const b=c.querySelector('.remove-subject-btn');if(b)b.style.visibility='hidden';}}else{showMessage(D.addResultsMessage,"Must have at least one subject.","warning");}}
    D.nextToStep2Btn.addEventListener('click',()=>{hideMessage(D.addResultsMessage);const name=D.resultNameInput.value.trim(),sch=D.schoolNameInput.value.trim(),tch=D.teacherNameInput.value.trim(),clsId=D.resultClassSelect.value;const subjects=[];let valid=true,firstInv=null;D.subjectsContainer.querySelectorAll('.subject-entry').forEach(e=>{const nI=e.querySelector('.subject-name'),tI=e.querySelector('.total-marks'),pI=e.querySelector('.pass-marks');const n=nI.value.trim(),t=tI.value.trim(),p=pI.value.trim();let eV=true;[nI,tI,pI].forEach(el=>el.classList.remove('invalid'));if(!n){eV=false;nI.classList.add('invalid');if(!firstInv)firstInv=nI;}if(!t||isNaN(t)||Number(t)<=0){eV=false;tI.classList.add('invalid');if(!firstInv)firstInv=tI;}if(!p||isNaN(p)||Number(p)<0||Number(p)>Number(t)){eV=false;pI.classList.add('invalid');if(!firstInv)firstInv=pI;}if(eV)subjects.push({name:n,total:Number(t),pass:Number(p)});else valid=false;});let err='';if(!name)err+='Result Name required. ';if(!clsId)err+='Class required. ';if(subjects.length===0||!valid)err+='Valid subject(s) required. ';if(err){showMessage(D.addResultsMessage,err.trim(),'error');if(firstInv)firstInv.focus();return;}const clsName=classMapping[clsId]?.displayName||clsId;currentResultConfig={resultName:name,schoolName:sch,teacherName:tch,className:clsId,classDisplayName:clsName,subjects:subjects};studentsWithResults.clear();D.selectedClassInfo.textContent=clsName;loadStudentsForResultsList(clsId);showStep(2);});
    function loadStudentsForResultsList(classId){D.resultsStudentList.innerHTML='<p class="message info">Loading students...</p>';const clsStudents=studentsData.filter(s=>String(s.Class||'').trim()===classId);if(clsStudents.length===0){D.resultsStudentList.innerHTML='<p class="message warning">No students found for this class.</p>';return;}D.resultsStudentList.innerHTML='';const frag=document.createDocumentFragment();clsStudents.sort((a,b)=>(a.RollNumber||'').localeCompare(b.RollNumber||'',undefined,{numeric:true})||(a.Name||'').localeCompare(b.Name||'')).forEach(s=>{const i=document.createElement('div');i.className='student-result-item';i.dataset.studentId=s.StudentID;i.innerHTML=`${getStudentPhotoHtml(s.PhotoURL)}<div class="student-result-info"><span><strong>${sanitizeHTML(s.Name||'N/A')}</strong></span><span>Roll: ${sanitizeHTML(s.RollNumber||'N/A')}</span></div><i class="fas fa-check-circle result-saved-indicator"></i>`;i.addEventListener('click',()=>selectStudentForMarks(i,s));frag.appendChild(i);});D.resultsStudentList.appendChild(frag);}
    function selectStudentForMarks(el,std){const c=D.resultsStudentList.querySelector('.selected');if(c)c.classList.remove('selected');el.classList.add('selected');hideMessage(D.marksEntryMessage);currentStudentForResult=std;if(!currentStudentForResult){console.error("Student invalid:",std);return;}D.selectedStudentInfo.textContent=`${sanitizeHTML(std.Name||'N/A')} (Roll: ${sanitizeHTML(std.RollNumber||'N/A')})`;generateMarksEntryForm();showStep(3);D.marksEntryContainer.scrollIntoView({behavior:'smooth',block:'nearest'});}
    function generateMarksEntryForm(){D.marksEntryForm.innerHTML='';if(!currentResultConfig?.subjects?.length){D.marksEntryForm.innerHTML='<p class="message error">No subjects defined.</p>';return;}if(!currentStudentForResult){D.marksEntryForm.innerHTML='<p class="message error">No student selected.</p>';return;}const frag=document.createDocumentFragment();currentResultConfig.subjects.forEach(s=>{const g=document.createElement('div');g.className='marks-input-group';const id=`marks-${currentResultConfig.className}-${currentStudentForResult.StudentID}-${s.name.replace(/\s+/g,'-')}`;g.innerHTML=`<label for="${id}">${sanitizeHTML(s.name)} <span class="max-marks">(Max: ${s.total})</span>:</label><input type="number" id="${id}" class="marks-input" data-subject-name="${sanitizeHTML(s.name)}" max="${s.total}" min="0" required>`;frag.appendChild(g);});D.marksEntryForm.appendChild(frag);const fI=D.marksEntryForm.querySelector('.marks-input');if(fI)fI.focus();}
    D.backToStep1Btn.addEventListener('click',()=>showStep(1)); D.backToStep2Btn.addEventListener('click',()=>showStep(2));
    D.submitMarksBtn.addEventListener('click',async()=>{hideMessage(D.marksEntryMessage);if(!currentStudentForResult||!schoolSpreadsheetId||!currentResultConfig){showMessage(D.marksEntryMessage,'Error: Invalid state. Cannot save.','error');return;}const marks={};let valid=true, firstInvalidInput=null; currentResultConfig.subjects.forEach(s=>{const id=`marks-${currentResultConfig.className}-${currentStudentForResult.StudentID}-${s.name.replace(/\s+/g,'-')}`;const inp=document.getElementById(id);if(!inp){console.error(`Input missing: ${id}`);valid=false;return;}const v=inp.value.trim(),mx=parseFloat(inp.max),mn=parseFloat(inp.min);inp.classList.remove('invalid');if(v===''||isNaN(v)||parseFloat(v)<mn||parseFloat(v)>mx){valid=false;inp.classList.add('invalid'); if(!firstInvalidInput) firstInvalidInput = inp;}else{marks[s.name]=parseFloat(v);}});if(!valid){showMessage(D.marksEntryMessage,'One or more marks are invalid or empty.','error'); if(firstInvalidInput) firstInvalidInput.focus(); return;}const payload={resultName:currentResultConfig.resultName, className:currentResultConfig.className, schoolName:currentResultConfig.schoolName, teacherName:currentResultConfig.teacherName, subjects:JSON.stringify(currentResultConfig.subjects), studentId:currentStudentForResult.StudentID, marks:JSON.stringify(marks)}; const r=await callBackendApi('saveResult',payload);if(r?.success){showMessage(D.marksEntryMessage,r.message||'Marks saved successfully!','success');const i=D.resultsStudentList.querySelector(`.student-result-item[data-student-id="${currentStudentForResult.StudentID}"]`);if(i)i.classList.add('has-result');studentsWithResults.add(currentStudentForResult.StudentID);setTimeout(()=>showStep(2),1500);}else{showMessage(D.marksEntryMessage,r?.error||'Failed to save marks.','error');}});

    // --- Generic Sheet Management (Unchanged) ---
    async function loadGenericSheetData(sheetName) { if (!schoolSpreadsheetId || !sheetName) return; currentGenericSheetName = sheetName; D.downloadSheetJsonBtn.style.display = 'none'; showMessage(D.genericSheetMessage, `Loading "${sanitizeHTML(sheetName)}"...`, 'info'); D.genericTableHeaderRow.innerHTML=''; D.genericTableBody.innerHTML=`<tr><td colspan="1" style="text-align:center;padding:30px;color:#888;">Loading...</td></tr>`; currentGenericHeaders=[]; currentGenericData=[]; D.genericViewTitle.innerHTML = `<i class="far fa-file-alt"></i> ${sanitizeHTML(sheetName)}`; const result = await callBackendApi('getSheetData', { sheetName }); if(result?.success && result.data){ hideMessage(D.genericSheetMessage); currentGenericHeaders=result.data.headers||[]; currentGenericData=result.data.rows||[]; const headFrag=document.createDocumentFragment(); currentGenericHeaders.forEach(h=>{const th=document.createElement('th');th.textContent=sanitizeHTML(h);headFrag.appendChild(th);}); if(currentGenericData.length > 0){ const thA=document.createElement('th');thA.textContent='Actions';thA.style.textAlign='center';headFrag.appendChild(thA); D.downloadSheetJsonBtn.style.display='inline-flex';} D.genericTableHeaderRow.appendChild(headFrag); D.genericTableBody.innerHTML=''; if(currentGenericData.length === 0){ const cs=currentGenericHeaders.length||1; D.genericTableBody.innerHTML=`<tr><td colspan="${cs}" style="text-align:center;padding:30px;color:#888;">Sheet is empty.</td></tr>`; } else{ const bodyFrag=document.createDocumentFragment(); currentGenericData.forEach(item=>{ const tr=document.createElement('tr'); item.values.forEach(v=>{const td=document.createElement('td');td.textContent=sanitizeHTML(v);tr.appendChild(td);}); const tdA=document.createElement('td');tdA.className='action-col';tdA.innerHTML=`<i class="fas fa-edit edit-btn-generic" title="Edit Row" data-sheet-name="${sanitizeHTML(sheetName)}" data-row-index="${item.rowIndex}"></i> <i class="fas fa-trash-alt delete-btn generic-delete-btn" title="Delete Row" data-sheet-name="${sanitizeHTML(sheetName)}" data-row-index="${item.rowIndex}"></i>`;tr.appendChild(tdA); bodyFrag.appendChild(tr); }); D.genericTableBody.appendChild(bodyFrag); } } else { showMessage(D.genericSheetMessage, result?.error || `Failed to load "${sanitizeHTML(sheetName)}".`, 'error'); D.genericTableHeaderRow.innerHTML=''; D.genericTableBody.innerHTML=`<tr><td colspan="1" style="text-align:center;padding:30px;color:var(--error-color);">Error loading data.</td></tr>`; } updatePdfButtonVisibility(currentView); }
    D.genericTableBody.addEventListener('click',(e)=>{ if(e.target?.classList.contains('edit-btn-generic')){const sn=e.target.dataset.sheetName,ri=e.target.dataset.rowIndex;if(sn&&ri)openGenericEditModal(sn,parseInt(ri));} if(e.target?.classList.contains('generic-delete-btn')){const sn=e.target.dataset.sheetName,ri=e.target.dataset.rowIndex;if(sn&&ri)handleGenericDeleteRow(sn,parseInt(ri));}});
    function openGenericEditModal(sheetName, rowIndex) { hideMessage(D.genericEditMessage); D.genericEditForm.reset(); D.genericEditFormFields.innerHTML='<p>Loading...</p>'; const rowData=currentGenericData.find(i=>i.rowIndex===rowIndex); if(!rowData||!currentGenericHeaders||currentGenericHeaders.length===0){console.error("Data/Headers missing", {sheetName,rowIndex}); showMessage(D.genericSheetMessage,'Error: Headers missing or data not found.','error'); return;} D.genericEditModalTitle.innerHTML=`<i class="fas fa-edit"></i> Edit Row ${rowIndex} in "${sanitizeHTML(sheetName)}"`; D.genericEditSheetNameInput.value=sheetName; D.genericEditRowIndexInput.value=rowIndex; const frag=document.createDocumentFragment(); currentGenericHeaders.forEach((h,idx)=>{ const v=rowData.values[idx] ?? ''; const ig=document.createElement('div'); ig.className='input-group'; const lbl=document.createElement('label'); const id=`gen-edit-${h.replace(/[^a-zA-Z0-9]/g,'-')}-${rowIndex}`; lbl.htmlFor=id; lbl.textContent=sanitizeHTML(h)+':'; let inp; if(String(v).length>100||String(v).includes('\n')){inp=document.createElement('textarea');}else{inp=document.createElement('input');inp.type='text';} inp.id=id; inp.name=h; inp.value=v; ig.appendChild(lbl); ig.appendChild(inp); frag.appendChild(ig); }); D.genericEditFormFields.innerHTML=''; D.genericEditFormFields.appendChild(frag); openModal('genericEditModal');}
    D.saveGenericChangesBtn.addEventListener('click', async () => { hideMessage(D.genericEditMessage); const sheetName=D.genericEditSheetNameInput.value,rowIndex=D.genericEditRowIndexInput.value; if(!sheetName||!rowIndex){showMessage(D.genericEditMessage,'Error: Sheet/Row ID missing.','error');return;} const formD=new FormData(D.genericEditForm); const data={}; currentGenericHeaders.forEach(h=>{if(formD.has(h))data[h]=formD.get(h);}); const result=await callBackendApi('updateSheetRow',{sheetName:sheetName,rowIndex:parseInt(rowIndex),rowData:data}); if(result?.success){showMessage(D.genericEditMessage,result.message||'Row updated!','success');loadGenericSheetData(sheetName); setTimeout(()=>closeModal('genericEditModal'),1500);}else{showMessage(D.genericEditMessage,result?.error||'Update failed.','error');}});
    async function handleGenericDeleteRow(sheetName, rowIndex) { if (!confirm(`Delete row ${rowIndex} from sheet "${sheetName}"? This is permanent.`)) return; const result = await callBackendApi('deleteSheetRow', { sheetName, rowIndex }); if (result?.success) { showMessage(D.genericSheetMessage, result.message || 'Row deleted.', 'success'); loadGenericSheetData(sheetName); } else { showMessage(D.genericSheetMessage, result?.error || 'Failed to delete row.', 'error'); } }
    D.downloadSheetJsonBtn.addEventListener('click', async () => { if (!currentGenericSheetName) { showMessage(D.genericSheetMessage, 'No sheet selected.', 'warning'); return; } const result = await callBackendApi('getSheetDataAsJson', { sheetName: currentGenericSheetName }); if (result?.success && result.data) { const jsonStr = JSON.stringify(result.data, null, 2); const blob = new Blob([jsonStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${currentGenericSheetName.replace(/ /g, '_')}_export.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showMessage(D.genericSheetMessage, 'JSON downloaded.', 'success'); } else { showMessage(D.genericSheetMessage, result?.error || 'Failed to download JSON.', 'error'); } });
    
    // --- Tools View (cards) and Fullscreen Iframe ---
    async function loadTools() {
        if(cachedTools.length > 0) { populateToolsView(); return; } // Use cache if available
        showMessage(D.toolsMessage, 'Loading tools...', 'info'); D.toolsViewContent.innerHTML = '';
        try {
            const response = await fetch('./tools.json');
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            cachedTools = await response.json(); populateToolsView();
        } catch (error) { console.error("Error loading tools.json:", error); showMessage(D.toolsMessage, `Failed to load tools: ${error.message}`, 'error'); D.toolsViewContent.innerHTML = `<p class="message error">Could not load tools.json.</p>`; cachedTools = [];}
    }
    function populateToolsView(){
        hideMessage(D.toolsMessage); D.toolsViewContent.innerHTML = '';
        if (cachedTools && cachedTools.length > 0) {
            cachedTools.forEach(tool => {
                const card = document.createElement('div'); card.className = 'tool-card';
                card.innerHTML = `<img src="${sanitizeHTML(tool.imageUrl || 'https://via.placeholder.com/80?text=Tool')}" alt="${sanitizeHTML(tool.name)}"><h4>${sanitizeHTML(tool.name)}</h4><p>${sanitizeHTML(tool.description || 'Click to open tool')}</p>`;
                card.addEventListener('click', () => openFullscreenIframe(tool.name, tool.url));
                D.toolsViewContent.appendChild(card);
            });
        } else { D.toolsViewContent.innerHTML = '<p class="message warning">No tools configured in tools.json.</p>'; }
    }
    function openFullscreenIframe(name, url) { D.fullscreenIframeTitle.textContent = sanitizeHTML(name); D.fullscreenIframeEl.src = url; D.fullscreenIframeContainer.style.display = 'flex'; document.body.style.overflow = 'hidden';}
    D.closeFullscreenIframeBtn.addEventListener('click', () => { D.fullscreenIframeContainer.style.display = 'none'; D.fullscreenIframeEl.src = 'about:blank'; D.fullscreenIframeTitle.textContent = 'Tool'; document.body.style.overflow = ''; });


    // --- Add Fees View JS (Unchanged) ---
    async function loadFeeTypes(showMsg = true) { if(!schoolSpreadsheetId) return; if(feeTypes.length > 0 && !showMsg) return; /* Already loaded and not forced refresh */ if (showMsg) showMessage(D.addFeesMessage, "Loading fee types...", "info"); const result = await callBackendApi('getSheetDataAsJson', { sheetName: 'FeeTypes' }); if (result?.success && result.data) { if(showMsg) hideMessage(D.addFeesMessage); feeTypes = result.data; populateFeeTypeDropdown(); } else { if(showMsg) showMessage(D.addFeesMessage, result?.error || "Failed to load fee types.", "error"); console.error("Failed to load fee types", result?.error); } }
    function populateFeeTypeDropdown() { D.feeTypeSelect.innerHTML = '<option value="" disabled selected>-- Select Fee Type --</option>'; if (feeTypes && feeTypes.length > 0) { feeTypes.forEach(ft => { const opt = document.createElement('option'); opt.value = ft.FeeTypeID; opt.textContent = `${sanitizeHTML(ft.FeeTypeName)} (${formatCurrency(ft.DefaultAmount || 0)})`; opt.dataset.defaultAmount = ft.DefaultAmount || ''; D.feeTypeSelect.appendChild(opt); }); } }
    D.feeTypeSelect.addEventListener('change', (e) => { const selectedOption = e.target.selectedOptions[0]; if (selectedOption && selectedOption.dataset.defaultAmount) { D.feeAmountInput.placeholder = `Default: ${formatCurrency(selectedOption.dataset.defaultAmount)}`; if (!D.feeAmountInput.value) D.feeAmountInput.value = selectedOption.dataset.defaultAmount; } else { D.feeAmountInput.placeholder = `Enter Amount`; } });
    async function prepareAddFeesForm() { if (Object.keys(classMapping).length === 0) await loadStudentsAndClasses(false); if (feeTypes.length === 0) await loadFeeTypes(false); if (D.feeClassSelect.options.length <=1 && Object.keys(classMapping).length > 0) populateClassDropdowns(); D.feeMonthYearInput.value = getCurrentMonthYear(); D.feeAcademicYearInput.value = getCurrentAcademicYear(); const today = new Date(); D.feeDueDateInput.value = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0]; D.feeAmountInput.value = ''; D.feeAmountInput.placeholder = 'Default from Fee Type'; if (D.feeTypeSelect.options.length <=1 && feeTypes.length > 0) populateFeeTypeDropdown(); }
    D.addFeesForm.addEventListener('submit', async (e) => { e.preventDefault(); hideMessage(D.addFeesMessage); const payload = { classId: D.feeClassSelect.value, feeTypeId: D.feeTypeSelect.value, monthYear: D.feeMonthYearInput.value.trim(), dueDate: D.feeDueDateInput.value, academicYear: D.feeAcademicYearInput.value.trim() || undefined, amount: D.feeAmountInput.value.trim() || undefined }; if (!payload.classId || !payload.feeTypeId || !payload.monthYear || !payload.dueDate) { showMessage(D.addFeesMessage, "Class, Fee Type, Month/Year, and Due Date are required.", "error"); return; } const result = await callBackendApi('addBulkFees', payload); if (result?.success) { showMessage(D.addFeesMessage, result.message || "Fees added!", "success"); D.addFeesForm.reset(); prepareAddFeesForm(); } else { showMessage(D.addFeesMessage, result?.error || "Failed to add fees.", "error"); } });

    // --- Staff Management (Enhanced UI changes affect modal display) ---
    async function loadStaffList() { showMessage(D.staffListMessage, "Loading staff...", "info"); D.staffTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#888;">Loading...</td></tr>'; const result = await callBackendApi('getStaffList'); if (result?.success && result.data) { hideMessage(D.staffListMessage); staffListData = result.data; if (staffListData.length === 0) { D.staffTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#888;">No staff.</td></tr>'; } else { const frag = document.createDocumentFragment(); staffListData.forEach(staff => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${getStudentPhotoHtml(staff.PhotoURL, 'student-photo', 'fa-user-tie')}</td><td>${sanitizeHTML(staff.Name||'N/A')}</td><td>${sanitizeHTML(staff.Mobile||'N/A')}</td><td>${sanitizeHTML(staff.Role||staff.Designation||'N/A')}</td> <td><span style="color:${String(staff.IsActive).toLowerCase()==='true'?'var(--success-color)':'var(--error-color)'}; font-weight:bold;">${String(staff.IsActive).toLowerCase()==='true'?'Active':'Inactive'}</span></td><td class="action-col"><i class="fas fa-eye view-btn" title="View Staff Details" data-staffid="${sanitizeHTML(staff.StaffID)}"></i></td>`; frag.appendChild(tr); }); D.staffTableBody.innerHTML = ''; D.staffTableBody.appendChild(frag); } } else { showMessage(D.staffListMessage, result?.error||"Failed to load staff.", "error"); D.staffTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--error-color);">Error.</td></tr>';}}
    D.staffTableBody.addEventListener('click', (e) => { if (e.target?.classList.contains('view-btn')) { const staffId = e.target.dataset.staffid; if (staffId) openStaffDetailsModal(staffId); } });
    // Enhanced Staff Details Modal JS
    async function openStaffDetailsModal(staffId) {
        D.staffDetailsModalBody.innerHTML = '<p class="message info">Loading staff details...</p>';
        D.addSalaryPaymentBtnModal.style.display = 'none'; 
        hideMessage(D.addSalaryMessage); openModal('staffDetailsModal');
        const result = await callBackendApi('getStaffDetails', { staffId });
        if (result?.success && result.data) {
            const S = result.data; 
            D.staffDetailsModalTitle.innerHTML = `<i class="fas fa-user-tie"></i> Profile: ${sanitizeHTML(S.Name || 'Staff Member')}`;
            
            let paymentsHtml = '<h4><i class="fas fa-money-check-alt"></i> Salary Payments</h4>';
            if (S.payments && S.payments.records?.length > 0) {
                paymentsHtml += `<div class="fees-summary">Total Paid to Date: <strong>${formatCurrency(S.payments.totalPaid)}</strong></div><div class="details-list">`; // Reused fees-summary style for consistency
                S.payments.records.slice(-10).reverse().forEach(p => { 
                    paymentsHtml += `<div class="list-item"><span>${formatDisplayDate(p.PaymentDate)} for ${sanitizeHTML(p.MonthYear)}: <strong>${formatCurrency(p.Amount)}</strong></span></div>`;
                });
                paymentsHtml += '</div>';
            } else { paymentsHtml += '<p style="text-align:center; color:#777; margin-top:10px;">No payment records found.</p>'; }

            paymentsHtml += `<hr style="margin: 25px 0 15px;"><h4><i class="fas fa-hand-holding-usd"></i> Add New Salary Payment</h4>
                <form id="add-salary-form-modal" class="form-grid" data-staff-id="${sanitizeHTML(S.StaffID)}">
                    <div class="input-group"><label for="modal-salary-payment-date">Payment Date:</label><input type="date" id="modal-salary-payment-date" required></div>
                    <div class="input-group"><label for="modal-salary-amount">Amount:</label><input type="number" id="modal-salary-amount" min="0.01" step="0.01" required placeholder="e.g., 25000"></div>
                    <div class="input-group"><label for="modal-salary-monthyear">For Month/Year:</label><input type="text" id="modal-salary-monthyear" placeholder="MMMM YYYY" required></div>
                    <div class="input-group" style="grid-column: 1 / -1;"><label for="modal-salary-notes">Notes (Optional):</label><textarea id="modal-salary-notes" rows="2"></textarea></div>
                </form>`;
            D.addSalaryPaymentBtnModal.style.display = 'inline-flex'; 

            D.staffDetailsModalBody.innerHTML = `
                <div class="profile-grid">
                    <div class="profile-sidebar">
                         <div class="profile-photo-container">${getStudentPhotoHtml(S.PhotoURL, 'profile-photo', 'fa-user-tie')}</div>
                         <h3 class="profile-name">${sanitizeHTML(S.Name)}</h3>
                         <p class="profile-meta"><i class="fas fa-id-badge"></i> ID: ${sanitizeHTML(S.StaffID)}</p>
                         <p class="profile-meta"><i class="fas fa-briefcase"></i> Role: ${sanitizeHTML(S.Role || S.Designation || 'N/A')}</p>
                         <p class="profile-meta"><i class="fas fa-dollar-sign"></i> Salary: ${formatCurrency(S.SalaryAmount)}</p>
                         <p class="profile-meta"><i class="fas fa-calendar-check"></i> Joined: ${formatDisplayDate(S.JoiningDate)}</p>
                         <p class="profile-meta"><i class="fas fa-toggle-${String(S.IsActive).toLowerCase()==='true'?'on':'off'}"></i> Status: <span style="font-weight:bold; color: ${String(S.IsActive).toLowerCase()==='true'?'var(--success-color)':'var(--error-color)'};">${S.IsActive?'Active':'Inactive'}</span></p>
                    </div>
                    <div class="profile-main-content">
                        <div class="details-section">
                            <h4><i class="fas fa-address-book"></i> Contact Information</h4>
                            <div class="info-grid">
                                <p><strong>Mobile:</strong> ${sanitizeHTML(S.Mobile)}</p>
                                <p><strong>Gmail:</strong> ${sanitizeHTML(S.Gmail)}</p>
                            </div>
                        </div>
                        <div class="details-section"> 
                            <h4><i class="fas fa-file-invoice-dollar"></i> Financial Overview</h4>
                            <div class="info-grid">
                                 <p><strong>Salary:</strong> ${formatCurrency(S.SalaryAmount)}</p>
                                 <p><strong>Total Paid:</strong> ${formatCurrency(S.TotalPaid)}</p>
                                 <p><strong>Total Dues:</strong> ${formatCurrency(S.TotalDues)}</p>
                            </div>
                        </div>
                        <div class="details-section payments-section">${paymentsHtml}</div>
                    </div>
                </div>`;
            document.getElementById('modal-salary-payment-date').valueAsDate = new Date();
            document.getElementById('modal-salary-monthyear').value = getCurrentMonthYear();
        } else { D.staffDetailsModalBody.innerHTML = `<p class="message error">${result?.error || 'Failed to load staff details.'}</p>`; }
    }
    D.addSalaryPaymentBtnModal.addEventListener('click', async () => { hideMessage(D.addSalaryMessage); const form = document.getElementById('add-salary-form-modal'); if (!form) return; const staffId = form.dataset.staffId; const payload = { staffId: staffId, paymentDate: document.getElementById('modal-salary-payment-date').value, amount: document.getElementById('modal-salary-amount').value, monthYear: document.getElementById('modal-salary-monthyear').value.trim(), notes: document.getElementById('modal-salary-notes').value.trim() }; if (!payload.staffId || !payload.paymentDate || !payload.amount || !payload.monthYear) { showMessage(D.addSalaryMessage, "Date, Amount, and Month/Year required.", "error"); return; } if (parseFloat(payload.amount) <=0) { showMessage(D.addSalaryMessage, "Amount must be > 0.", "error"); return; } const result = await callBackendApi('addStaffSalaryPayment', payload); if (result?.success) { showMessage(D.addSalaryMessage, result.message || "Payment added!", "success"); openStaffDetailsModal(staffId); loadStaffList(); } else { showMessage(D.addSalaryMessage, result?.error || "Failed to add payment.", "error"); } });

    // --- Dashboard View (Charting Unchanged) ---
    async function loadDashboardData() { showMessage(D.dashboardMessage, "Loading dashboard data...", "info"); const result = await callBackendApi('getDashboardOverview'); if (result?.success && result.data) { hideMessage(D.dashboardMessage); const data = result.data; D.dbTotalStudents.textContent = data.totalStudents ?? '-'; D.dbTotalStaff.textContent = data.totalStaff ?? '-'; D.dbTotalClasses.textContent = data.totalClasses ?? '-'; D.dbTotalGirls.textContent = data.totalGirls ?? '-'; D.dbTotalBoys.textContent = data.totalBoys ?? '-'; D.dbTotalPaid.textContent = formatCurrency(data.totalPaidMoney) ?? '-'; D.dbTotalDue.textContent = formatCurrency(data.totalDuesMoney) ?? '-'; D.dbTotalExpenses.textContent = formatCurrency(data.totalExpenses) ?? '-'; Object.values(dashboardCharts).forEach(chart => chart?.destroy()); dashboardCharts = {}; if (data.studentsPerClass) renderBarChart('studentsPerClassChart', D.studentsPerClassChartEl, 'Students per Class', data.studentsPerClass); if (data.genderSplitPerClass) renderGroupedBarChart('genderSplitPerClassChart', D.genderSplitPerClassChartEl, 'Gender Split per Class', data.genderSplitPerClass); if (data.feesCollectedPerClassThisMonth) renderBarChart('feesCollectedPerClassChart', D.feesCollectedPerClassChartEl, `Fees Collected (${getCurrentMonthYear()})`, data.feesCollectedPerClassThisMonth, true); if (data.duesPerClass) renderBarChart('duesPerClassChart', D.duesPerClassChartEl, 'Total Dues per Class', data.duesPerClass, true); if (data.attendancePerClass) renderBarChart('attendancePerClassChart', D.attendancePerClassChartEl, 'Avg Attendance % (Last 30 Days)', data.attendancePerClass, false, true); } else { showMessage(D.dashboardMessage, result?.error || "Failed to load dashboard.", "error"); } }
    function renderBarChart(chartId, canvasEl, label, dataObject, isCurrency = false, isPercentage = false) { if(!canvasEl) return; const ctx = canvasEl.getContext('2d'); const labels = Object.keys(dataObject); const dataValues = Object.values(dataObject).map(val => (isPercentage && typeof val === 'object' ? val.averageAttendancePercent : val) ); dashboardCharts[chartId] = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: label, data: dataValues, backgroundColor: 'rgba(52, 152, 219, 0.7)', borderColor: 'rgba(52, 152, 219, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return isCurrency ? formatCurrency(value) : (isPercentage ? value + '%' : value); } } } }, plugins: { legend: { display: false }, title: {display:true, text:label, font:{size:14}} } } }); }
    function renderGroupedBarChart(chartId, canvasEl, label, dataObject) { if(!canvasEl) return; const ctx = canvasEl.getContext('2d'); const labels = Object.keys(dataObject); const boysData = labels.map(l => dataObject[l].boys || 0); const girlsData = labels.map(l => dataObject[l].girls || 0); const othersData = labels.map(l => dataObject[l].other || 0); dashboardCharts[chartId] = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Boys', data: boysData, backgroundColor: 'rgba(52, 152, 219, 0.7)', borderColor: 'rgba(52, 152, 219, 1)', borderWidth: 1 }, { label: 'Girls', data: girlsData, backgroundColor: 'rgba(232, 62, 140, 0.7)', borderColor: 'rgba(232, 62, 140, 1)', borderWidth: 1 }, { label: 'Other', data: othersData, backgroundColor: 'rgba(40, 167, 69, 0.7)', borderColor: 'rgba(40, 167, 69, 1)', borderWidth: 1} ] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', scales: { y: { beginAtZero: true, stacked: false }, x: {stacked: false} }, plugins: { legend: { display: true, position: 'top' }, title: { display: true, text: label, font:{size:14} } } } }); }

    // --- PDF (Unchanged) ---
    function updatePdfButtonVisibility(viewId) { D.downloadPdfBtn.style.display = 'none'; if (viewId === 'student-list-view') { const studentTableBody = document.getElementById('current-class-student-table-body'); if (studentTableBody && studentTableBody.rows.length > 0 && !studentTableBody.rows[0].cells[0].textContent.toLowerCase().includes('no students')) { D.downloadPdfBtn.style.display = 'inline-flex'; } } else if (viewId === 'generic-sheet-view' && D.genericTableBody.rows.length > 0 && !D.genericTableBody.rows[0].cells[0].textContent.toLowerCase().includes('empty')) { D.downloadPdfBtn.style.display = 'inline-flex'; } }
    D.downloadPdfBtn.addEventListener('click', downloadCurrentViewAsPDF);
    function downloadCurrentViewAsPDF() { let tableElement, headers = [], data = [], title = 'Data Export', orientation = 'p'; if (currentView === 'student-list-view') { const currentStudentTable = document.getElementById('current-class-student-table-body'); if(!currentStudentTable || currentClassStudents.length === 0) { showMessage(D.studentListMessage, "No data to export.", "warning"); return;} tableElement = currentStudentTable.closest('table'); const displayedClassName = D.studentListMainContent.querySelector('h3')?.textContent.replace(' - Student List','') || "Student List"; title = displayedClassName; headers = Array.from(tableElement.querySelectorAll('thead th')).map(th => th.textContent.trim()).slice(0, -1); data = currentClassStudents.map(s => [ s.PhotoURL ? 'Photo' : '-', s.RollNumber || '-', s.Name || '-', s.Mobile || '-', s.FatherName || '-' ]); if (headers.length > 4) orientation = 'l'; } else if (currentView === 'generic-sheet-view' && currentGenericSheetName && currentGenericData.length > 0) { tableElement = D.genericDataTable; title = `${currentGenericSheetName} Data`; headers = currentGenericHeaders; data = currentGenericData.map(rowItem => currentGenericHeaders.map((h, idx) => rowItem.values[idx] ?? '')); if (headers.length > 6) orientation = 'l'; } else { showMessage(D.dashboardMessage || D.mainHeaderTitle, "PDF not available.", 'warning'); return; } if (!tableElement || data.length === 0) { showMessage(D.mainHeaderTitle, "No data to download.", 'warning'); return; } try { showLoading(); const doc = new jsPDF({ orientation: orientation }); doc.setFontSize(16); doc.text(title, 14, 16); doc.setFontSize(8); doc.setTextColor(100); doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 20); jsPDF.autoTable(doc, { head: [headers], body: data, startY: 25, theme: 'grid', styles: { fontSize: orientation === 'l' ? 7 : 8, cellPadding: 1.5, overflow: 'linebreak' }, headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' }, didDrawPage: function (data) { doc.setFontSize(8); doc.setTextColor(150); const pageCount=doc.internal.getNumberOfPages(); doc.text('Page '+doc.internal.getCurrentPageInfo().pageNumber+' of '+pageCount,data.settings.margin.left,doc.internal.pageSize.height-10); } }); doc.save(`${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().slice(0,10)}.pdf`); hideLoading(); } catch (error) { console.error("Error PDF:", error); hideLoading(); showMessage(document.querySelector('.header-actions'), `PDF Error: ${error.message}`, 'error'); } }

    // --- Event Listeners & Initial Load ---
    document.querySelectorAll('.close-btn, .cancel-btn[data-modal-id]').forEach(btn => { btn.addEventListener('click', () => closeModal(btn.dataset.modalId || btn.closest('.modal').id)); });
    window.addEventListener('click', (e)=>{ if(e.target.classList.contains('modal')) closeModal(e.target.id); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>closeModal(m.id)); if (D.fullscreenIframeContainer.style.display === 'flex') D.closeFullscreenIframeBtn.click(); } });
    document.addEventListener('DOMContentLoaded', () => { const storedSpreadsheetId = localStorage.getItem('schoolSpreadsheetId'); if (storedSpreadsheetId) { schoolSpreadsheetId = storedSpreadsheetId; showAppView(); } else { showLoginView(); } const mt = D.sidebarToggleMobile; if (window.innerWidth <= 768) { mt.style.display = 'block'; D.sidebar.classList.add('collapsed'); } else { mt.style.display = 'none'; } });
    window.addEventListener('resize',()=>{const mt=D.sidebarToggleMobile; if(window.innerWidth<=768){mt.style.display='block';if(!D.sidebar.classList.contains('open'))D.sidebar.classList.add('collapsed');}else{mt.style.display='none';D.sidebar.classList.remove('open');}});

</script>

</body>
</html>
```